<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Coach Tai Jitsu ‚Äì 2e Dan</title>

  <style>
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      min-height: 100vh;
      background-image: linear-gradient(to right, #ffecd2 0%, #fcb69f 100%);
    }
    h1 { text-align: center; padding: 1rem; }

    .container { max-width: 900px; margin: auto; padding: 1rem; }

    .uv {
      background: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);
      border-radius: 20px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 10px 20px rgba(0,0,0,.15);
    }

    .exercise {
      background: white;
      border-radius: 15px;
      padding: .75rem;
      margin: .5rem 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 10px rgba(0,0,0,.1);
      cursor: grab;
    }

    .exercise.dragging { opacity: .5; }

    .controls button {
      border: none;
      border-radius: 50px;
      padding: .6rem 1.2rem;
      margin: .3rem;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,.2);
    }

    .status {
      background: white;
      border-radius: 20px;
      padding: 1rem;
      margin-top: 1rem;
      box-shadow: 0 6px 12px rgba(0,0,0,.15);
    }

    textarea {
      width: 100%;
      border-radius: 15px;
      padding: .75rem;
      border: none;
    }
  </style>
</head>

<body>
<h1>ü•ã Coach Tai Jitsu ‚Äì Passage 2e Dan</h1>
<div class="container" id="app"></div>

<audio id="beep" src="beep.mp3"></audio>
<audio id="ding" src="ding.mp3"></audio>

<script>
/* ===================== DATA ===================== */

const synth = window.speechSynthesis;
let isRunning = false;
let timer = null;
let currentIndex = 0;
let remaining = 0;
let sequence = [];

const data = JSON.parse(localStorage.getItem('tj-exercises')) || [
  { uv: 'ü•ã UV 1 ‚Äì Kihon', items: [
    { name: 'Kihon simple', duration: 15 },
    { name: 'Encha√Ænement de kihon', duration: 20 },
    { name: 'Cibles', duration: 10 }
  ]},
  { uv: 'üåÄ UV 2 ‚Äì D√©placements', items: [
    { name: 'Ta√Ø sabaki', duration: 10 },
    { name: 'Slow ippon', duration: 10 },
    { name: 'Ippon kumite', duration: 10 }
  ]},
  { uv: 'üìê UV 3 ‚Äì Kata', items: [
    { name: 'Slow kata', duration: 10 },
    { name: 'Kata nidan', duration: 10 },
    { name: 'Bunka√Ø', duration: 5 }
  ]},
  { uv: '‚öôÔ∏è UV 4 ‚Äì Technique de base', items: [
    { name: 'Shadow', duration: 10 }
  ]},
  { uv: 'üî• UV 5 & 6 ‚Äì Randori', items: [
    { name: 'Shadow randori', duration: 10 }
  ]}
];

/* ===================== RENDER ===================== */

function render() {
  const app = document.getElementById('app');
  app.innerHTML = '';

  data.forEach((uv, uvi) => {
    const block = document.createElement('div');
    block.className = 'uv';
    block.innerHTML = `<h2>${uv.uv}</h2>`;

    uv.items.forEach((ex, exi) => {
      const el = document.createElement('div');
      el.className = 'exercise';
      el.draggable = true;
      el.dataset.uv = uvi;
      el.dataset.index = exi;

      el.innerHTML = `
        <span>‚ò∞ ${ex.name}</span>
        <input type="range" min="1" max="60" value="${ex.duration}">
        <span>${ex.duration} min</span>
      `;

      const range = el.querySelector('input');
      range.oninput = () => {
        ex.duration = Number(range.value);
        el.querySelector('span:last-child').textContent = range.value + ' min';
        save();
      };

      el.addEventListener('dragstart', dragStart);
      el.addEventListener('dragover', e => e.preventDefault());
      el.addEventListener('drop', drop);
      el.addEventListener('dragend', dragEnd);

      block.appendChild(el);
    });

    app.appendChild(block);
  });

  app.innerHTML += `
    <div class="controls">
      <button onclick="start()">‚ñ∂Ô∏è Lecture</button>
      <button onclick="pause()">‚è∏ Pause</button>
      <button onclick="stop()">‚èπ Stop</button>
      <button onclick="save()">üíæ Enregistrer</button>
      <button onclick="exportCSV()">üì§ Export CSV</button>
    </div>

    <div class="status">
      <h3>üìç Suivi</h3>
      <div id="current">En attente‚Ä¶</div>

      <h4>üìù Notes</h4>
      <textarea rows="3" onblur="saveNote(this.value)">${localStorage.getItem('tj-note')||''}</textarea>
    </div>
  `;
}

/* ===================== DRAG & DROP ===================== */

let dragSource = null;

function dragStart(e) {
  dragSource = e.currentTarget;
  dragSource.classList.add('dragging');
}

function drop(e) {
  e.preventDefault();
  const target = e.currentTarget;
  if (dragSource === target) return;

  const uvFrom = +dragSource.dataset.uv;
  const iFrom = +dragSource.dataset.index;
  const uvTo = +target.dataset.uv;
  const iTo = +target.dataset.index;

  const moved = data[uvFrom].items.splice(iFrom, 1)[0];
  data[uvTo].items.splice(iTo, 0, moved);

  save();
  render();
}

function dragEnd() {
  if (dragSource) dragSource.classList.remove('dragging');
  dragSource = null;
}

/* ===================== TRAINING ===================== */

function buildSequence() {
  sequence = [];
  data.forEach(uv => uv.items.forEach(ex => sequence.push(ex)));
}

function speak(txt) {
  const u = new SpeechSynthesisUtterance(txt);
  u.lang = 'fr-FR';
  synth.speak(u);
}

function start() {
  if (isRunning) return;
  buildSequence();
  if (!sequence.length) return;

  isRunning = true;
  currentIndex = 0;
  speak("Commen√ßons la s√©ance");
  setTimeout(runExercise, 1200);
}

function runExercise() {
  if (!isRunning) return;

  if (currentIndex >= sequence.length) {
    speak("Fin de l'entra√Ænement, √† bient√¥t !");
    isRunning = false;
    return;
  }

  const ex = sequence[currentIndex];
  document.getElementById('beep').play();
  speak(`Exercice ${currentIndex + 1} : ${ex.name}`);

  remaining = ex.duration * 60;
  updateStatus(ex);

  timer = setInterval(() => {
    remaining--;
    updateStatus(ex);

    if (remaining <= 0) {
      clearInterval(timer);
      document.getElementById('ding').play();
      speak("Fin de l'exercice");
      currentIndex++;
      setTimeout(runExercise, 1200);
    }
  }, 1000);
}

function updateStatus(ex) {
  document.getElementById('current').textContent =
    `${ex.name} ‚Äì ${Math.floor(remaining/60)}:${String(remaining%60).padStart(2,'0')}`;
}

function pause() {
  clearInterval(timer);
  isRunning = false;
}

function stop() {
  clearInterval(timer);
  isRunning = false;
  currentIndex = 0;
  document.getElementById('current').textContent = 'S√©ance arr√™t√©e';
}

/* ===================== STORAGE ===================== */

function save() {
  localStorage.setItem('tj-exercises', JSON.stringify(data));
  alert('‚úÖ S√©ance enregistr√©e');
}

function saveNote(v) {
  localStorage.setItem('tj-note', v);
}

function exportCSV() {
  let csv = 'Exercice;Dur√©e (min)\n';
  buildSequence();
  sequence.forEach(e => csv += `${e.name};${e.duration}\n`);

  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'entrainement_taijitsu.csv';
  a.click();
}

render();
</script>
</body>
</html>
