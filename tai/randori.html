<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pr√©paration Techniques ‚Äì Tai-Jitsu</title>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="randori.css">

  <style>
    /* Limite taille photo pour impression (7 cm max) */
    @media print {
      .tech-photo {
        max-width: 7cm !important;
        max-height: 7cm !important;
        object-fit: contain !important;
      }
    }
  </style>

</head>

<body>
  <header class="appbar">
    <a class="logo" href="../index.html" title="Accueil">
      <img src="logo.png" alt="logo" class="logo-big">
    </a>
    <div class="header-text">
      <div class="title spicy">Pr√©paration Techniques</div>
      <div class="subtitle spicy">Tai-Jitsu ‚Äì Randori</div>
    </div>
  </header>

  <main class="kata-container">

    <!-- SELECTEUR TECHNIQUE -->
    <section class="kata-block wide-block">
      <h2 class="spicy section-title">üéØ S√©lectionner une technique</h2>

      <div class="selector-bar">
        <select id="filterType">
          <option value="">Filtrer par type</option>
        </select>

        <input type="text" id="searchBox" placeholder="Recherche rapide...">

        <select id="selectTech">
          <option value="">Choisir une technique</option>
        </select>

        <button id="btnRandom" class="btn primary">üé≤ Al√©atoire</button>
      </div>

      <div id="randomResult" class="randori-preview">Technique s√©lectionn√©e : -</div>

      <!-- FICHE TECHNIQUE -->
      <div id="techCard"></div>

    </section>
  </main>

  <script>
    let techniquesData = [];
    const DEFAULT_EMBED = "https://www.youtube.com/embed/Yfe5aQdez9Q";

    async function fetchData() {
      try {
        const resp = await fetch("randori.json");
        const json = await resp.json();
        techniquesData = json.techniques || [];
        populateTypeFilter();
        populateTechSelector();
      } catch (e) {
        console.error("Erreur chargement JSON", e);
        document.getElementById("techCard").innerHTML = "<p>Impossible de charger les techniques.</p>";
      }
    }

    function populateTypeFilter() {
      const set = new Set();
      techniquesData.forEach(t => { if (t.type_attaque) set.add(t.type_attaque); });
      const sel = document.getElementById("filterType");
      set.forEach(v => {
        const o = document.createElement("option");
        o.value = v;
        o.textContent = v;
        sel.appendChild(o);
      });
    }

    function populateTechSelector(filterType = "", query = "") {
      const sel = document.getElementById("selectTech");
      sel.innerHTML = '<option value="">Choisir une technique</option>';
      techniquesData.forEach(t => {
        if (filterType && t.type_attaque !== filterType) return;
        if (query) {
          const q = query.toLowerCase();
          const haystack =
            (t.attaque + " " + (t.objectif||"") + " " + (t.points_cles||"") + " " + (t.erreurs||"")).toLowerCase();
          if (!haystack.includes(q)) return;
        }
        const o = document.createElement("option");
        o.value = t.attaque;
        o.textContent = t.attaque;
        sel.appendChild(o);
      });
    }

    function findTechniqueByName(name) { return techniquesData.find(t => t.attaque === name); }

    function toEmbedUrl(url) {
      if (!url) return DEFAULT_EMBED;
      if (url.includes("youtube.com/embed")) return url;
      const by = url.match(/youtu\.be\/([A-Za-z0-9_-]{5,})/);
      if (by) return `https://www.youtube.com/embed/${by[1]}`;
      const q = url.match(/[?&]v=([A-Za-z0-9_-]{5,})/);
      if (q) return `https://www.youtube.com/embed/${q[1]}`;
      return DEFAULT_EMBED;
    }

    function escapeHtml(s) {
      if (!s) return "";
      return s.replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      })[m]);
    }

    function renderTechniqueCard(t) {
      const container = document.getElementById("techCard");
      if (!t) { container.innerHTML = ""; return; }

      const derouleHtml = (Array.isArray(t.deroule) && t.deroule.length)
        ? `<ul class="deroule-list">${t.deroule.map(s => `<li>${escapeHtml(s)}</li>`).join("")}</ul>`
        : "<em>Aucun d√©roul√© d√©taill√©</em>";

      container.innerHTML = `
        <div class="tech-wrapper">

          <!-- PHOTO √Ä GAUCHE -->
          <div class="tech-photo-box">
            <img src="${t.photo || 'placeholder.png'}" class="tech-photo" alt="Illustration technique">
          </div>

          <!-- CONTENU √Ä DROITE -->
          <div class="tech-info-box">
            <h3 class="tech-title">${escapeHtml(t.attaque)}</h3>
            <div class="tech-side">${escapeHtml(t.type_attaque||'')}</div>

            <p><strong>Atemi pr√©paratoire :</strong> ${escapeHtml(t.atemi_preparatoire||'')}</p>
            <p><strong>Objectif :</strong> ${escapeHtml(t.objectif||'')}</p>

            <p><strong>D√©roul√© :</strong><br>${derouleHtml}</p>

            <p><strong>Points cl√©s :</strong> ${escapeHtml(t.points_cles||'')}</p>
            <p><strong>Erreurs fr√©quentes :</strong> ${escapeHtml(t.erreurs||'')}</p>

            <iframe class="video-frame"
              src="${toEmbedUrl(t.video_embed || '')}"
              allowfullscreen></iframe>

            <button class="fiche-btn" onclick="window.print()">üñ®Ô∏è Imprimer la fiche</button>
          </div>

        </div>
      `;
    }

    function randomTechnique() {
      if (!techniquesData.length) return null;
      const idx = Math.floor(Math.random() * techniquesData.length);
      return techniquesData[idx];
    }

    function showRandomPreview(t) {
      const el = document.getElementById("randomResult");
      el.textContent = t
        ? `Technique s√©lectionn√©e : ${t.attaque}`
        : "Technique s√©lectionn√©e : -";
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await fetchData();

      const selTech = document.getElementById("selectTech");
      const filterType = document.getElementById("filterType");
      const searchBox = document.getElementById("searchBox");
      const btnRandom = document.getElementById("btnRandom");

      selTech.addEventListener("change", (e) => {
        const t = findTechniqueByName(e.target.value);
        renderTechniqueCard(t);
      });

      filterType.addEventListener("change", (e) => {
        populateTechSelector(e.target.value, searchBox.value.trim());
        renderTechniqueCard(null);
      });

      searchBox.addEventListener("input", (e) => {
        populateTechSelector(filterType.value, e.target.value.trim());
        renderTechniqueCard(null);
      });

      btnRandom.addEventListener("click", () => {
        const t = randomTechnique();
        if (t) {
          showRandomPreview(t);
          selTech.value = t.attaque;
          renderTechniqueCard(t);
        }
      });

      const initial = randomTechnique();
      if (initial) showRandomPreview(initial);
    });
  </script>

</body>
</html>
