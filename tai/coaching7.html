<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¥‹ Carnet dâ€™entraÃ®nement KaratÃ©</title>

<style>
:root{
 --g1:linear-gradient(to right,#ffecd2,#fcb69f);
 --g2:linear-gradient(120deg,#84fab0,#8fd3f4);
}
body{
 margin:0;
 font-family:system-ui;
 background:var(--g1);
}
header{
 background:var(--g2);
 text-align:center;
 padding:14px;
}
.container{
 max-width:900px;
 margin:auto;
 padding:16px;
}
button{
 padding:12px 18px;
 border:none;
 border-radius:20px;
 margin:6px;
 font-size:16px;
 box-shadow:0 6px 12px rgba(0,0,0,.2);
}
.primary{background:#84fab0}
.warn{background:#ffd86f}
ul{list-style:none;padding:0}
li{
 background:#fff;
 margin:10px 0;
 padding:14px;
 border-radius:18px;
 box-shadow:0 6px 12px rgba(0,0,0,.15);
}
.progress{
 height:8px;
 background:#eee;
 border-radius:8px;
 margin-top:6px;
}
.progress div{
 height:100%;
 background:var(--g2);
}
.modal{
 position:fixed;
 inset:0;
 background:rgba(0,0,0,.5);
 display:none;
 align-items:center;
 justify-content:center;
}
.card{
 background:white;
 border-radius:20px;
 padding:20px;
 width:90%;
 max-width:520px;
 max-height:90%;
 overflow:auto;
}
.smile{
 font-size:26px;
 padding:6px;
 cursor:pointer;
}
.smile.active{
 transform:scale(1.3);
}
canvas{max-width:100%}
textarea{width:100%}
</style>
</head>

<body>

<header>
<h1>ğŸ¥‹ Carnet dâ€™entraÃ®nement</h1>
</header>

<div class="container">

<button class="primary" onclick="start()">â–¶ Lancer</button>
<button class="warn" onclick="pause()">â¸ Pause</button>
<button onclick="newSession()">â™» Nouvelle sÃ©ance</button>
<button onclick="openEval()">ğŸ“ Auto-Ã©valuation</button>

<ul id="program"></ul>

<h3>ğŸ“Š Radar technique (7 jours)</h3>
<canvas id="radar" width="320" height="320"></canvas>

</div>

<div class="modal" id="evalModal">
 <div class="card">
  <h2>ğŸ“ Auto-Ã©valuation du jour</h2>
  <div id="evalContent"></div>

  <h4>ğŸ’¬ Commentaire</h4>
  <textarea id="comment" rows="3"></textarea>
  <button onclick="dictate()">ğŸ™ Dicter</button>

  <button class="primary" onclick="saveEval()">ğŸ’¾ Enregistrer</button>
  <button onclick="closeEval()">Fermer</button>
 </div>
</div>

<audio id="ding" src="ding.mp3"></audio>

<script>
/* ===== CONFIG ===== */
const UV_CRITERIA={
 Kihon:["distance","kime","prÃ©cision","posture","rythme"],
 Kata:["prÃ©cision","Ã©quilibre","fluiditÃ©","kime","regard"],
 Randori:["distance","timing","tai sabaki","engagement","luciditÃ©"]
};

/* ===== DONNÃ‰ES ===== */
let exercises=[
 {name:"Kihon",label:"ğŸ¥‹ Kihon",duration:1,progress:0},
 {name:"Kata",label:"ğŸ§˜ Kata",duration:1,progress:0},
 {name:"Randori",label:"ğŸ”¥ Randori",duration:1,progress:0}
];

let currentIndex=0;
let interval=null;
let remaining=0;

const synth=speechSynthesis;
const ding=document.getElementById("ding");

const today=()=>new Date().toISOString().slice(0,10);

/* ===== JOURNAL ===== */
function getLog(){
 return JSON.parse(localStorage.getItem("trainingLog")||"{}");
}
function saveLog(log){
 localStorage.setItem("trainingLog",JSON.stringify(log));
}

/* ===== RENDER ===== */
function render(){
 const ul=document.getElementById("program");
 ul.innerHTML="";
 exercises.forEach(e=>{
  const li=document.createElement("li");
  li.innerHTML=`
   <strong>${e.label}</strong>
   <div class="progress"><div style="width:${e.progress}%"></div></div>
  `;
  ul.appendChild(li);
 });
}
render();

/* ===== TIMER ===== */
function start(){
 if(interval) return;
 play();
}

function play(){
 if(currentIndex>=exercises.length){
  synth.cancel();
  synth.speak(new SpeechSynthesisUtterance("Fin de l'entraÃ®nement"));

  const log=getLog();
  log[today()]={ exercises:{} };
  exercises.forEach(e=>{
   if(e.progress>=100){
    log[today()].exercises[e.name]={duration:e.duration};
   }
  });
  saveLog(log);
  drawRadar();
  return;
 }

 const e=exercises[currentIndex];
 synth.cancel();
 synth.speak(new SpeechSynthesisUtterance(e.name));
 remaining=e.duration*60;

 interval=setInterval(()=>{
  remaining--;
  e.progress=100-(remaining/(e.duration*60))*100;
  render();

  if(remaining<=0){
   clearInterval(interval);
   interval=null;
   ding.play();
   currentIndex++;
   play();
  }
 },1000);
}

function pause(){
 clearInterval(interval);
 interval=null;
}

function newSession(){
 pause();
 currentIndex=0;
 exercises.forEach(e=>e.progress=0);
 render();
}

/* ===== AUTO-Ã‰VALUATION ===== */
function openEval(){
 const log=getLog()[today()];
 const c=document.getElementById("evalContent");
 c.innerHTML="";

 if(!log || !Object.keys(log.exercises).length){
  c.innerHTML="<p>Aucun exercice terminÃ© aujourdâ€™hui.</p>";
 }else{
  Object.keys(log.exercises).forEach(ex=>{
   let html=`<h4>${ex}</h4>`;
   UV_CRITERIA[ex].forEach(cr=>{
    html+=`${cr} :
     ${[1,2,3,4,5].map(v=>
      `<span class="smile" data-ex="${ex}" data-cr="${cr}" data-v="${v}">
       ${["ğŸ˜","ğŸ˜","ğŸ™‚","ğŸ˜„","ğŸ”¥"][v-1]}
      </span>`).join("")}<br>`;
   });
   c.innerHTML+=html+"<hr>";
  });
 }

 document.querySelectorAll(".smile").forEach(s=>{
  s.onclick=()=>{
   s.parentNode.querySelectorAll(".smile").forEach(x=>x.classList.remove("active"));
   s.classList.add("active");
  };
 });

 document.getElementById("evalModal").style.display="flex";
}

function saveEval(){
 const log=getLog();
 log[today()].eval={};

 document.querySelectorAll(".smile.active").forEach(s=>{
  const ex=s.dataset.ex;
  const cr=s.dataset.cr;
  const v=parseInt(s.dataset.v);
  log[today()].eval[ex]=log[today()].eval[ex]||{};
  log[today()].eval[ex][cr]=v;
 });

 log[today()].comment=document.getElementById("comment").value;
 saveLog(log);
 closeEval();
 drawRadar();
}

function closeEval(){
 document.getElementById("evalModal").style.display="none";
}

/* ===== RADAR ===== */
function drawRadar(){
 const ctx=document.getElementById("radar").getContext("2d");
 ctx.clearRect(0,0,320,320);

 const log=getLog();
 const since=Date.now()-7*86400000;
 const acc={};

 Object.entries(log).forEach(([d,val])=>{
  if(new Date(d).getTime()<since||!val.eval) return;
  Object.values(val.eval).forEach(ex=>{
   Object.entries(ex).forEach(([k,v])=>{
    acc[k]=acc[k]||[];
    acc[k].push(v);
   });
  });
 });

 const keys=Object.keys(acc);
 if(!keys.length) return;

 const cx=160,cy=160,r=120;
 keys.forEach((k,i)=>{
  const a=(Math.PI*2/keys.length)*i-Math.PI/2;
  const avg=acc[k].reduce((a,b)=>a+b)/acc[k].length;
  ctx.beginPath();
  ctx.moveTo(cx,cy);
  ctx.lineTo(cx+Math.cos(a)*r*avg/5,cy+Math.sin(a)*r*avg/5);
  ctx.stroke();
  ctx.fillText(k,cx+Math.cos(a)*(r+10),cy+Math.sin(a)*(r+10));
 });
}

/* ===== DICTÃ‰E ===== */
function dictate(){
 const r=new (window.SpeechRecognition||webkitSpeechRecognition)();
 r.lang="fr-FR";
 r.onresult=e=>{
  document.getElementById("comment").value+=e.results[0][0].transcript;
 };
 r.start();
}
</script>

</body>
</html>
