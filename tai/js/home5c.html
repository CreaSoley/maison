<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Coaching Karate</title>

<style>
body{font-family:Arial;margin:0;background:#f4f4f4;padding:10px}
h2{text-align:center}
.card{background:#fff;border-radius:12px;padding:12px;margin-bottom:12px}
.btn{padding:6px 12px;border-radius:18px;border:2px solid #ff64c4;background:white;font-weight:bold}
.btn-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.sequence-item{padding:8px;border-radius:8px;margin-bottom:6px;background:#eee}
.sequence-item.active{background:#ffd6ec;font-weight:bold}
.sequence-item.done{text-decoration:line-through;opacity:.6}
progress{width:100%}
#overlay{display:none;position:fixed;inset:0;background:black;color:white;z-index:999;
align-items:center;justify-content:center;flex-direction:column;gap:12px}
</style>
</head>

<body>

<h2>ü•ã Coaching Karate</h2>

<div class="card">
<h3>Banque</h3>
<div id="bank"></div>
</div>

<div class="card">
<h3>S√©lection</h3>
<div id="selection"></div>
<div class="btn-row">
<button class="btn" onclick="startTraining()">‚ñ∂Ô∏è D√©marrer</button>
<button class="btn" onclick="showOverlay()">üñ• Plein √©cran</button>
<button class="btn" onclick="editGoals()">üéØ √âditer objectifs</button>
<button class="btn" onclick="showHistory()">üìú Historique</button>
</div>
</div>

<div class="card">
<h3>üéØ Objectifs hebdomadaires</h3>
<div id="goalsView"></div>
</div>

<div id="overlay">
<h2 id="oTitle"></h2>
<div id="oTimer" style="font-size:2rem"></div>
<progress id="oProgress" value="0" max="100"></progress>
<div class="btn-row">
<button class="btn" onclick="pause()">‚è∏ Pause</button>
<button class="btn" onclick="resume()">‚ñ∂Ô∏è Reprendre</button>
<button class="btn" onclick="hideOverlay()">‚¨ÖÔ∏è Quitter</button>
</div>
</div>

<script>
/* ===== DATA ===== */
const bankData=[
{uv:"UV1 ‚Äì Kihon",ex:["Kihon simple","Encha√Ænement kihon","Travail aux cibles"]},
{uv:"UV2 ‚Äì D√©placements",ex:["Ta√Ø sabaki","Slow ippon","Ippon kumite"]},
{uv:"UV3 ‚Äì Kata",ex:["Slow kata","Kata nidan","Bunka√Ø"]},
{uv:"UV4 ‚Äì Techniques",ex:["Shadow technique","Encha√Ænements libres"]},
{uv:"UV5-6 ‚Äì Randori",ex:["Randori shadow","Randori dirig√©"]}
];

let selection=[],idx=0,remaining=0,timer=null,paused=false;
let history=JSON.parse(localStorage.getItem("tj-history")||"[]");
let goals=JSON.parse(localStorage.getItem("tj-goals")||"{}");

/* ===== AUDIO ===== */
const ding=new Audio("ding.mp3");
const beep=new Audio("beep.mp3");

/* ===== UTIL ===== */
function weekKey(){
const d=new Date(),o=new Date(d.getFullYear(),0,1);
return d.getFullYear()+"-W"+Math.ceil((((d-o)/86400000)+o.getDay()+1)/7);
}

/* ===== UI ===== */
function renderBank(){
const b=document.getElementById("bank");b.innerHTML="";
bankData.forEach(u=>{
const d=document.createElement("div");
d.innerHTML=`<strong>${u.uv}</strong><br>`;
u.ex.forEach(n=>{
const btn=document.createElement("button");
btn.className="btn";btn.textContent=n;
btn.onclick=()=>{selection.push({name:n,duration:5,done:false});renderSelection();}
d.appendChild(btn);
});
b.appendChild(d);
});
}

function renderSelection(){
const s=document.getElementById("selection");s.innerHTML="";
selection.forEach((e,i)=>{
s.innerHTML+=`
<div class="sequence-item ${i===idx?"active":""} ${e.done?"done":""}">
${e.name}<br>
<input type="number" min="1" value="${e.duration}"
onchange="selection[${i}].duration=Number(this.value)"> min
<button onclick="selection.splice(${i},1);renderSelection()">‚ùå</button>
</div>`;
});
}

function renderGoals(){
const g=document.getElementById("goalsView");g.innerHTML="";
const wk=weekKey(),tot={};
history.forEach(s=>{
if(s.week===wk){
s.exercises.forEach(e=>{
tot[e.name]=(tot[e.name]||0)+e.minutes;
});
}
});
Object.keys(goals).forEach(n=>{
const d=tot[n]||0,t=goals[n];
const pct=Math.min(100,Math.round(d/t*100));
g.innerHTML+=`${n}<br>${d}/${t} min<progress value="${pct}"></progress><br>`;
});
}

/* ===== VOICE WITH LATENCY ===== */
function speak(text,delay=300){
setTimeout(()=>{
try{
const u=new SpeechSynthesisUtterance(text);
u.lang="fr-FR";
speechSynthesis.speak(u);
}catch(e){}
},delay);
}

/* ===== TRAINING ===== */
function startTraining(){
if(!selection.length)return;
idx=0;selection.forEach(e=>e.done=false);

history.push({
date:new Date().toLocaleString(),
week:weekKey(),
exercises:[]
});
localStorage.setItem("tj-history",JSON.stringify(history));

speak("Commen√ßons l'entra√Ænement");
runExercise();
}

function runExercise(){
clearTimeout(timer);

if(idx>=selection.length){
speak("Fin de l'entra√Ænement, √† bient√¥t");
renderSelection();renderGoals();
return;
}

const ex=selection[idx];
ding.play();
speak("Exercice "+(idx+1)+" : "+ex.name,300);

remaining=ex.duration*60;
updateOverlay(ex.name);
tick();
renderSelection();
}

function tick(){
clearTimeout(timer);
if(paused)return;

document.getElementById("oTimer").textContent=
Math.floor(remaining/60)+":"+String(remaining%60).padStart(2,"0");
document.getElementById("oProgress").value=
100*(1-remaining/(selection[idx].duration*60));

if(remaining<=0){
beep.play();
speak("Fin de l'exercice",300);

selection[idx].done=true;
history[history.length-1].exercises.push({
name:selection[idx].name,
minutes:selection[idx].duration
});
localStorage.setItem("tj-history",JSON.stringify(history));

idx++;
runExercise();
return;
}

remaining--;
timer=setTimeout(tick,1000);
}

/* ===== CONTROLS ===== */
function pause(){paused=true;clearTimeout(timer);}
function resume(){if(!paused)return;paused=false;tick();}
function showOverlay(){overlay.style.display="flex";}
function hideOverlay(){overlay.style.display="none";}
function updateOverlay(t){oTitle.textContent=t;}

/* ===== GOALS ===== */
function editGoals(){
selection.forEach(e=>{
const v=prompt("Objectif hebdomadaire (minutes) pour "+e.name,goals[e.name]||30);
if(v)goals[e.name]=Number(v);
});
localStorage.setItem("tj-goals",JSON.stringify(goals));
renderGoals();
}

/* ===== HISTORY ===== */
function showHistory(){
let t="";
history.forEach(s=>{
t+=s.date+"\n";
s.exercises.forEach(e=>t+=`- ${e.name}: ${e.minutes} min\n`);
t+="\n";
});
alert(t||"Aucun historique");
}

/* INIT */
renderBank();renderSelection();renderGoals();
</script>

</body>
</html>
