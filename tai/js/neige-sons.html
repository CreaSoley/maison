<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Tai-Jitsu Coach ‚Äì Ceinture Noire</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box}
body{margin:0;font-family:'Fredoka',Arial,sans-serif;background-image:linear-gradient(120deg,#84fab0 0%,#8fd3f4 100%);overflow-x:hidden}
.container{padding:12px}
.card{background:#fff;border-radius:18px;padding:14px;margin-bottom:14px;box-shadow:0 6px 12px rgba(0,0,0,.1)}
h1,h3{text-align:center}
button{border:none;border-radius:14px;padding:10px 14px;font-family:'Fredoka';cursor:pointer;margin:4px 0}
.btn-primary{background-image:linear-gradient(to right,#fa709a 0%,#fee140 100%);color:#fff}
.btn-secondary{background:#84fab0;color:#fff}
.btn-secondary.active{background-image:linear-gradient(to top,#30cfd0 0%,#330867 100%);}
.btn-danger{background:#ff6b6b;color:#fff}
.accordion-header{display:flex;justify-content:space-between;font-weight:600;cursor:pointer}
.accordion-content{display:none;margin-top:10px}
.exercise{display:flex;align-items:center;justify-content:space-between;gap:6px;margin-bottom:6px}
.exercise.active{background:#fff3cd;border-radius:10px;padding:6px}
.exercise.done{text-decoration:line-through;opacity:.5}
.progress{width:100%;height:10px;background:#eee;border-radius:10px;overflow:hidden}
.progress-bar{height:100%;width:0;background-image:linear-gradient(to right,#fa709a 0%,#fee140 100%)}
input[type=range]{flex:1}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;padding:12px}
.modal-content{background:#fff;border-radius:18px;padding:14px;width:100%;max-height:90vh;overflow:auto}
.rating{display:flex;justify-content:space-between;font-size:12px}
</style>
</head>
<body>
<div class="container">
<h1>ü•ã Tai-Jitsu Coach</h1>

<div class="card">
<div class="accordion-header" onclick="toggleAccordion(this)">üéØ Objectifs <span>‚¨áÔ∏è</span></div>
<div class="accordion-content" id="objectifs"><em>Chargement‚Ä¶</em></div>
<button class="btn-secondary" onclick="editObjectives()">‚úèÔ∏è √âditer</button>
</div>

<div class="card">
<div class="accordion-header" onclick="toggleAccordion(this)">üìö Banque d'exercices <span>‚¨áÔ∏è</span></div>
<div class="accordion-content" id="bank"></div>
</div>

<div class="card">
<h3>üìù S√©ance</h3>
<div id="selection"></div>
<button class="btn-secondary" onclick="clearSelection()">Vider</button>
</div>

<div class="card">
<h3>‚è±Ô∏è S√©ance</h3>
<div class="progress"><div class="progress-bar" id="globalBar"></div></div>
<p id="timers" style="text-align:center;font-weight:600">00:00 | 00:00</p>
<button class="btn-primary" onclick="startSession()">Commencer</button>
<button class="btn-secondary" id="pauseBtn" onclick="pauseResume()">Pause</button>
<button class="btn-danger" onclick="stopSession()">Stop</button>
</div>
</div>

<div class="modal" id="evalModal">
<div class="modal-content">
<h3>üìù Auto-√©valuation</h3>
<textarea id="notes" placeholder="Carnet de notes..."></textarea>
<div id="evaluation"></div>
<button class="btn-primary" onclick="saveEvaluation()">Valider</button>
</div>
</div>

<script>
/********************
 * AUDIO
 ********************/
const ding = new Audio('ding.mp3');
const beep = new Audio('beep.mp3');

/********************
 * DONN√âES
 ********************/
const DEFAULT_GOAL = 60;

const EXERCISES = [
  { name:'UV1 : Kihon simples',criteria:['pr√©cision','kime','posture']},
  { name:'UV1 : Encha√Ænements',criteria:['pr√©cision','kime','posture']},
  { name:'UV1 : Cibles',criteria:['pr√©cision','kime','posture']},
  { name:'UV2 : Ta√Ø sabaki',criteria:['fluidit√©','distance','contr√¥le']},
  { name:'UV2 : Ippon kumite lent',criteria:['fluidit√©','distance','contr√¥le']},
  { name:'UV2 : Ippon kumite examen',criteria:['fluidit√©','distance','contr√¥le']},
  { name:'UV3 : Kata lent',criteria:['exactitude','kime','√©quilibre']},
  { name:'UV3 : Kata examen',criteria:['exactitude','kime','√©quilibre']},
  { name:'UV3 : Bunka√Ø',criteria:['exactitude','kime','√©quilibre']},
  { name:'UV4 : Technique de base',criteria:['r√©alisme','zanchin','protection']},
  { name:'UV5-6 : Self-defense arme',criteria:['r√©alisme','zanchin','protection']},
  { name:'UV5-6 : Self-defense atemi',criteria:['r√©alisme','zanchin','protection']},
  { name:'UV5-6 : Self-defense saisie',criteria:['r√©alisme','zanchin','protection']}
];

let selection=[];
let timer=null;
let paused=false;
let current=0;
let remainingEx=0;
let remainingTotal=0;

/********************
 * ACCORD√âON
 ********************/
function toggleAccordion(header){
  const content = header.nextElementSibling;
  const arrow = header.querySelector('span');
  const open = content.style.display === 'block';
  content.style.display = open ? 'none' : 'block';
  if(arrow) arrow.textContent = open ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è';
}

/********************
 * OBJECTIFS (FIX DEFINITIF)
 ********************/
function getWeekKey(){
  const d=new Date();
  const onejan=new Date(d.getFullYear(),0,1);
  const week=Math.ceil((((d-onejan)/86400000)+onejan.getDay()+1)/7);
  return `${d.getFullYear()}-W${week}`;
}

function loadObjectives(){
  const weekKey=getWeekKey();
  let data=JSON.parse(localStorage.getItem('objectives'));

  if(!data || data.week!==weekKey){
    data={week:weekKey,goals:{}};
    EXERCISES.forEach(ex=>{
      data.goals[ex.name]={target:DEFAULT_GOAL,done:0};
    });
    localStorage.setItem('objectives',JSON.stringify(data));
  }
  return data;
}

function renderObjectives(){
  const container=document.getElementById('objectifs');
  const data=loadObjectives();
  container.innerHTML='';

  Object.entries(data.goals).forEach(([name,goal])=>{
    const pct=Math.min(100,Math.round((goal.done/goal.target)*100));
    container.innerHTML+=`
      <div>
        <strong>${name}</strong>
        <div class="progress"><div class="progress-bar" style="width:${pct}%"></div></div>
        <small>${goal.done} / ${goal.target} min (${pct}%)</small>
      </div>`;
  });
}

function editObjectives(){
  const data=loadObjectives();
  Object.keys(data.goals).forEach(name=>{
    const v=prompt(`Objectif hebdomadaire pour ${name} (min)`,data.goals[name].target);
    if(v!==null && !isNaN(v)){
      data.goals[name].target=parseInt(v);
      data.goals[name].done=0;
    }
  });
  localStorage.setItem('objectives',JSON.stringify(data));
  renderObjectives();
}

/********************
 * BANQUE / S√âLECTION
 ********************/
function renderBank(){
  const bank=document.getElementById('bank');
  bank.innerHTML='';
  EXERCISES.forEach(ex=>{
    bank.innerHTML+=`<div class="exercise"><span>${ex.name}</span><button onclick="addExercise('${ex.name}')">‚ûï</button></div>`;
  });
}

function addExercise(name){
  selection.push({name,duration:10});
  renderSelection();
}

function renderSelection(){
  const s=document.getElementById('selection');
  s.innerHTML='';
  selection.forEach((ex,i)=>{
    s.innerHTML+=`
      <div class="exercise">
        <span>${ex.name}</span>
        <input type="range" min="1" max="60" value="${ex.duration}" oninput="updateDuration(${i},this.value)">
        <span>${ex.duration} min</span>
      </div>`;
  });
}

function updateDuration(i,v){selection[i].duration=parseInt(v);renderSelection();}
function clearSelection(){selection=[];renderSelection();}

/********************
 * SESSION
 ********************/
function speak(t){speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(t);u.lang='fr-FR';speechSynthesis.speak(u);}

function startSession(){
  if(!selection.length)return;
  paused=false;
  document.getElementById('pauseBtn').classList.remove('active');
  document.getElementById('pauseBtn').textContent='Pause';
  remainingTotal=selection.reduce((a,b)=>a+b.duration*60,0);
  speak("Commen√ßons l'entra√Ænement");
  setTimeout(()=>runExercise(0),2000);
}

function runExercise(i){
  if(i>=selection.length){endSession(true);return;}
  current=i;
  remainingEx=selection[i].duration*60;
  announceExercise(i);
  timer=setInterval(tick,1000);
}

function announceExercise(i){
  const label=i===0?'premier':(i+1)+'√®me';
  speak(`${label} exercice, ${selection[i].name}`);
}

function tick(){
  if(paused)return;
  remainingEx--;remainingTotal--;
  updateTimers();updateProgress();
  if(remainingEx===10)speak('10 secondes');
  if(remainingEx<=0){
    clearInterval(timer);
    current<selection.length-1?ding.play():beep.play();
    setTimeout(()=>runExercise(current+1),1500);
  }
}

function pauseResume(){
  paused=!paused;
  const b=document.getElementById('pauseBtn');
  b.textContent=paused?'Reprendre':'Pause';
  b.classList.toggle('active',paused);
}

function stopSession(){clearInterval(timer);endSession(false);}

function updateTimers(){document.getElementById('timers').textContent=format(remainingEx)+' | '+format(remainingTotal);}
function updateProgress(){const total=selection.reduce((a,b)=>a+b.duration*60,0);document.getElementById('globalBar').style.width=((total-remainingTotal)/total*100)+'%';}
function format(s){const m=Math.floor(s/60).toString().padStart(2,'0');const r=(s%60).toString().padStart(2,'0');return m+':'+r;}

function endSession(normal){clearInterval(timer);setTimeout(()=>{speak("Fin de l'entra√Ænement, place √† l'auto-√©valuation");openEval();},normal?4000:0);}

/********************
 * √âVALUATION
 ********************/
function openEval(){
  const e=document.getElementById('evaluation');
  e.innerHTML='';
  selection.forEach(ex=>{
    const def=EXERCISES.find(d=>d.name===ex.name);
    let html=`<h4>${ex.name}</h4>`;
    def.criteria.forEach(c=>{
      html+=`<div class="rating"><span>${c}</span>`;
      for(let i=0;i<=5;i++)html+=`<label><input type="radio" name="${ex.name}-${c}" value="${i}">${i}</label>`;
      html+='</div>';
    });
    e.innerHTML+=html;
  });
  document.getElementById('evalModal').style.display='flex';
}

function saveEvaluation(){document.getElementById('evalModal').style.display='none';}

/********************
 * INIT (ORDRE CRITIQUE)
 ********************/
document.addEventListener('DOMContentLoaded',()=>{
  renderObjectives();
  renderBank();
  renderSelection();
});
</script>
</body>
</html>
