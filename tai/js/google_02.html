<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tai-Jitsu Coach</title>

<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Fredoka',Arial,sans-serif;
  background-image:linear-gradient(120deg,#84fab0 0%,#8fd3f4 100%);
}
.container{padding:12px}
.card{
  background:#fff;
  border-radius:18px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 6px 12px rgba(0,0,0,.1)
}
h1,h2,h3{text-align:center}
button{
  border:none;
  border-radius:14px;
  padding:10px 14px;
  font-family:'Fredoka';
  cursor:pointer;
  margin:4px 0
}
.btn-primary{background-image:linear-gradient(to right,#fa709a,#fee140);color:#fff}
.btn-secondary{background:#84fab0;color:#fff}
.btn-danger{background:#ff6b6b;color:#fff}
button.active{
  background-image:linear-gradient(to top,#30cfd0,#330867);
  color:#fff
}
.accordion-header{
  font-weight:600;
  display:flex;
  justify-content:space-between;
  cursor:pointer
}
.accordion-content{display:none;margin-top:10px}
.exercise{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:6px 0;
  border-bottom:1px dashed #ddd
}
.exercise.active{background:#fff3cd;border-radius:10px;padding:6px}
.progress{
  width:100%;
  height:10px;
  background:#eee;
  border-radius:10px;
  overflow:hidden;
  margin:6px 0
}
.progress-bar{
  height:100%;
  background-image:linear-gradient(to right,#fa709a,#fee140)
}
.timers{text-align:center;font-weight:600}
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  justify-content:center;
  align-items:center;
  padding:12px
}
.modal-content{
  background:#fff;
  border-radius:18px;
  padding:14px;
  width:100%;
  max-height:90vh;
  overflow:auto
}
textarea{width:100%;border-radius:12px;padding:8px}
.rating{display:flex;justify-content:space-between;font-size:12px}
</style>
</head>

<body>
<div class="container">
<h1>ü•ã Tai-Jitsu Coach</h1>

<!-- OBJECTIFS -->
<div class="card">
  <div class="accordion-header" onclick="toggleAccordion(this)">
    üéØ Objectifs hebdomadaires <span>‚¨áÔ∏è</span>
  </div>
  <div class="accordion-content" id="objectifs">Chargement‚Ä¶</div>

</div>
<div class="card">
  <h3>üìä Progression Objectifs</h3>
  <canvas id="objectivesChart"></canvas>
</div>

<!-- BANQUE -->
<div class="card">
  <div class="accordion-header" onclick="toggleAccordion(this)">
    üìö Banque d'exercices <span>‚¨áÔ∏è</span>
  </div>
  <div class="accordion-content" id="bank"></div>
</div>

<!-- S√âLECTION -->
<div class="card">
  <h3>üìù S√©ance s√©lectionn√©e</h3>
  <div id="selection"></div>
  <button class="btn-secondary" onclick="clearSelection()">Vider</button>
</div>

<!-- SESSION -->
<div class="card">
  <h3>‚è±Ô∏è S√©ance</h3>
  <div class="progress"><div class="progress-bar" id="globalProgress"></div></div>
  <div class="timers" id="timers">00:00 | 00:00</div>
  <button class="btn-primary" id="startBtn" onclick="startSession()">Commencer</button>
  <button class="btn-secondary" id="pauseBtn" onclick="pauseResume()">Pause</button>
  <button class="btn-danger" onclick="stopSession()">Stop</button>
</div>
</div>

<!-- √âVALUATION -->
<div class="modal" id="evaluationModal">
<div class="modal-content">
<h2>üìù Auto-√©valuation</h2>
<textarea id="notes"></textarea>
<div id="evaluation"></div>
<button class="btn-primary" onclick="saveEvaluation()">Valider</button>
</div>
</div>

<script>
/* ================= CONFIG ================= */
const GOOGLE_API_URL = "https://script.google.com/macros/s/AKfycbw0XUFA42PqPRoROu_Dru3gKie9QfBZq0cVlxT3xxys6kDVUaKIg4d188rPmXebDFxnWg/exec";

/* ================= DONN√âES ================= */
const EXERCISES = [
 {name:'UV1 : Kihon simples',criteria:['pr√©cision','kime','posture']},
 {name:'UV1 : Encha√Ænements',criteria:['pr√©cision','kime','posture']},
 {name:'UV1 : Cibles',criteria:['pr√©cision','kime','posture']},
 {name:'UV2 : Ta√Ø sabaki',criteria:['fluidit√©','distance','contr√¥le']},
 {name:'UV2 : Ippon kumite lent',criteria:['fluidit√©','distance','contr√¥le']},
 {name:'UV2 : Ippon kumite examen',criteria:['fluidit√©','distance','contr√¥le']},
 {name:'UV3 : Kata lent',criteria:['exactitude','kime','√©quilibre']},
 {name:'UV3 : Kata examen',criteria:['exactitude','kime','√©quilibre']},
 {name:'UV3 : Bunka√Ø',criteria:['exactitude','kime','√©quilibre']},
 {name:'UV4: Technique de base',criteria:['r√©alisme','zanchin','protection']},
 {name:'UV5-6 : Self-defense arme',criteria:['r√©alisme','zanchin','protection']},
 {name:'UV5-6 : Self-defense atemi',criteria:['r√©alisme','zanchin','protection']},
 {name:'UV5-6 : Self-defense saisie',criteria:['r√©alisme','zanchin','protection']}
];

let selection=[],currentIndex=0,timer=null,paused=false;
let remainingExercise=0,remainingGlobal=0;
let objectivesChart = null;

/* ================= OBJECTIFS ================= */
async function fetchObjectivesFromSheet(){
  try{
    const r=await fetch(GOOGLE_API_URL+"?action=fetchObjectives");
    const data=await r.json();
    renderObjectives(data);
    renderObjectivesChart(data);

  }catch(e){
    document.getElementById("objectifs").innerHTML="Erreur chargement objectifs";
  }
}
function renderObjectivesChart(data){
  const labels = data.map(o => o.Exercice);
  const objectifs = data.map(o => o.ObjectifHebdo);
  const realises = data.map(o => o.R√©alis√©);

  const ctx = document.getElementById("objectivesChart").getContext("2d");

  // D√©truire l'ancien graphique si existant
  if(objectivesChart) objectivesChart.destroy();

  // Calcul du max Y arrondi + 20 pour l'esth√©tique
  const maxY = Math.ceil(Math.max(...objectifs) / 10) * 10 + 20;

  objectivesChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Objectif (min)",
          data: objectifs,
          backgroundColor: "rgba(255, 159, 64, 0.7)"
        },
        {
          label: "R√©alis√© (min)",
          data: realises,
          backgroundColor: "rgba(54, 162, 235, 0.7)"
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            font: { family: "Fredoka" }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ": " + context.raw + " min";
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          suggestedMax: maxY,
          ticks: {
            stepSize: 20
          },
          title: {
            display: true,
            text: "Minutes",
            font: { family: "Fredoka", size: 14 }
          }
        },
        x: {
          ticks: {
            font: { family: "Fredoka", size: 12 }
          }
        }
      }
    }
  });
}


function renderObjectives(list){
  const div=document.getElementById("objectifs");
  div.innerHTML="";
  list.forEach(o=>{
    const pct=o.ObjectifHebdo?Math.round((o.R√©alis√©/o.ObjectifHebdo)*100):0;
    div.innerHTML+=`
      <strong>${o.Exercice}</strong>
      <div class="progress">
        <div class="progress-bar" style="width:${pct}%"></div>
      </div>
      <small>${o.R√©alis√©}/${o.ObjectifHebdo} min (${pct}%)</small>
    `;
  });
}

/* ================= UI ================= */
function toggleAccordion(h){
  const c=h.nextElementSibling;
  const a=h.querySelector("span");
  const open=c.style.display==="block";
  c.style.display=open?"none":"block";
  a.textContent=open?"‚¨áÔ∏è":"‚¨ÜÔ∏è";
}

function renderBank(){
  bank.innerHTML="";
  EXERCISES.forEach(e=>{
    bank.innerHTML+=`
    <div class="exercise">
      <span>${e.name}</span>
      <button onclick="addExercise('${e.name}')">‚ûï</button>
    </div>`;
  });
}

function addExercise(n){
  selection.push({name:n,duration:10});
  renderSelection();
}

function renderSelection(){
  selectionDiv.innerHTML="";
  selection.forEach((e,i)=>{
    selectionDiv.innerHTML+=`
    <div class="exercise ${i===currentIndex?'active':''}">
      <span>${e.name}</span>
      <input type="range" min="1" max="60" value="${e.duration}"
        oninput="selection[${i}].duration=parseInt(this.value)">
      <span>${e.duration} min</span>
    </div>`;
  });
}

function clearSelection(){selection=[];renderSelection()}

/* ================= SESSION ================= */
const ding=new Audio("ding.mp3");
const beep=new Audio("beep.mp3");

function speak(t){speechSynthesis.speak(new SpeechSynthesisUtterance(t))}

function startSession(){
  if(!selection.length)return;
  startBtn.disabled=true;
  remainingGlobal=selection.reduce((s,e)=>s+e.duration*60,0);
  speak("Commen√ßons l'entra√Ænement");
  setTimeout(()=>runExercise(0),1500);
}

function runExercise(i){
  if(i>=selection.length){endSession();return}
  currentIndex=i;
  renderSelection();
  speak(`Exercice ${i+1}, ${selection[i].name}`);
  remainingExercise=selection[i].duration*60;
  timer=setInterval(()=>{
    if(!paused){
      remainingExercise--;remainingGlobal--;
      updateTimers();updateProgress();
      if(remainingExercise<=0){
        clearInterval(timer);
        ding.play();
        runExercise(i+1);
      }
    }
  },1000);
}

function updateTimers(){
  timers.textContent=`${fmt(remainingExercise)} | ${fmt(remainingGlobal)}`
}

function updateProgress(){
  const total=selection.reduce((s,e)=>s+e.duration*60,0);
  globalProgress.style.width=`${100-(remainingGlobal/total*100)}%`
}

function pauseResume(){
  paused=!paused;
  pauseBtn.textContent=paused?"Reprendre":"Pause";
  pauseBtn.classList.toggle("active",paused);
}

function stopSession(){clearInterval(timer);endSession()}

function endSession(){
  sendSessionToSheet();
  fetchObjectivesFromSheet();
  beep.play();
  speak("Fin de l'entra√Ænement, place √† l'auto-√©valuation");
  evaluationModal.style.display="flex";
  renderEvaluation();
}

function fmt(s){
  return String(Math.floor(s/60)).padStart(2,"0")+":"+
         String(s%60).padStart(2,"0")
}

/* ================= GOOGLE SHEET ================= */
function sendSessionToSheet(){
  selection.forEach(ex=>{
    const params=new URLSearchParams({
      action:"addSession",
      exercice:ex.name,
      duree:ex.duration,
      notes:notes.value||""
    });
    fetch(GOOGLE_API_URL+"?"+params.toString());
  });
}

/* ================= √âVALUATION ================= */
function renderEvaluation(){
  evaluation.innerHTML="";
  selection.forEach(e=>{
    const def=EXERCISES.find(x=>x.name===e.name);
    if(!def) return;
    evaluation.innerHTML+=`<h4>${e.name}</h4>`;
    def.criteria.forEach(c=>{
      evaluation.innerHTML+=`
      <div class="rating">
        ${c}
        ${[0,1,2,3,4,5].map(v=>`
          <label>
            <input type="radio" name="${e.name+c}" value="${v}">${v}
          </label>`).join("")}
      </div>`;
    });
  });
}

function saveEvaluation(){location.reload()}

/* ================= INIT ================= */
const bank=document.getElementById("bank");
const selectionDiv=document.getElementById("selection");
const timers=document.getElementById("timers");
const globalProgress=document.getElementById("globalProgress");
const startBtn=document.getElementById("startBtn");
const pauseBtn=document.getElementById("pauseBtn");
const evaluation=document.getElementById("evaluation");
const evaluationModal=document.getElementById("evaluationModal");
const notes=document.getElementById("notes");

renderBank();
fetchObjectivesFromSheet();
</script>

</body>
</html>
