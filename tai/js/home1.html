<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coach Tai Jitsu ‚Äì S√©ance + √âvaluation</title>
<style>
body { font-family: 'Fredoka', Arial, sans-serif; margin:0; background: linear-gradient(180deg,#fff7fc 0%,#ffeef7 100%); color:#222; }
h1 { text-align:center; margin:1rem 0; color:#ff1493; }
.container { display:grid; grid-template-columns:1fr 1fr; gap:1rem; max-width:1100px; margin:auto; padding:1rem; }
.panel { background:white; border-radius:16px; padding:1rem; box-shadow:0 6px 14px rgba(0,0,0,0.15); }
.exercise, .sequence-item { display:flex; justify-content:space-between; align-items:center; padding:.5rem .7rem; border-radius:10px; margin:.3rem 0; background:#f5f5f5; }
.exercise.selected { background:#d1f5d3; }
.exercise.active { background:#ffe8b3; }
.exercise.done { text-decoration:line-through; opacity:.6; }
button { cursor:pointer; border:none; border-radius:8px; padding:.3rem .6rem; font-size:1rem; margin-left:.3rem; }
input[type=range]{ width:100px; margin-left:.3rem; }
progress{ width:100%; height:16px; margin-top:.5rem; }
#trainingOverlay { display:none; position:fixed; inset:0; background:linear-gradient(to right,#84fab0,#8fd3f4); z-index:999; flex-direction:column; justify-content:center; align-items:center; color:#000; font-family:system-ui,sans-serif; }
#trainingOverlay h1 { font-size:3rem; margin-bottom:1rem; }
#trainingOverlay #timer { font-size:4rem; margin-bottom:1rem; }
#trainingOverlay progress{ width:80%; height:24px; }
#trainingOverlay button{ margin-top:2rem;padding:1rem 2rem;font-size:1.2rem;border-radius:12px; cursor:pointer; }

#modal{ display:none; position:fixed; inset:0; background: rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center; overflow:auto; padding:1rem; }
#modal .content{ background:white; border-radius:16px; padding:1rem; max-width:600px; width:100%; }
.emoji-btn{ font-size:1.5rem; cursor:pointer; margin-right:.3rem; }
.selected-emoji{ border:2px solid #333; border-radius:6px; }
</style>
</head>
<body>
<h1>ü•ã Coach Tai Jitsu ‚Äì S√©ance + √âvaluation</h1>

<div class="container">
  <div class="panel">
    <h2>üìö Banque d'exercices</h2>
    <div id="bank"></div>
  </div>

  <div class="panel">
    <h2>üìù S√©ance s√©lectionn√©e</h2>
    <input type="text" id="sessionName" placeholder="Nom de la s√©ance">
    <div id="selection"></div>
    <label>Carnet de notes :</label>
    <textarea id="notes" rows="3" placeholder="Ressenti du jour..."></textarea>
    <h3>üéØ Objectifs hebdomadaires</h3>
    <div id="goals"></div>
    <div style="margin-top:.5rem;" class="controls">
      <button onclick="saveSelection()">üíæ Sauvegarder s√©lection</button>
      <button onclick="clearSelection()">üßπ Vider s√©lection</button>
      <button onclick="startSession()">‚ñ∂Ô∏è Commencer entra√Ænement</button>
      <button onclick="toggleFullscreen()">üì± Plein √©cran</button>
      <button onclick="showHistory()">üìä Historique</button>
      <button onclick="pauseTraining()">‚è∏ Pause</button>
      <button onclick="resumeTraining()">‚ñ∂Ô∏è Reprendre</button>
      <button onclick="stopTraining()">‚èπ Stop</button>
    </div>
    <progress id="progress" value="0" max="100"></progress>
  </div>
</div>

<!-- Overlay plein √©cran -->
<div id="trainingOverlay">
  <h1 id="exerciseName">Exercice</h1>
  <div id="timer">00:00</div>
  <progress id="sessionProgress" value="0" max="100"></progress>
  <button onclick="toggleFullscreen()">‚ùå Quitter plein √©cran</button>
</div>

<!-- Modal historique/√©valuation -->
<div id="modal">
  <div class="content">
    <h2>üìã Historique & √âvaluation</h2>
    <div id="historyList"></div>
    <button onclick="closeModal()">‚ùå Fermer</button>
  </div>
</div>

<audio id="beep" src="beep.mp3"></audio>
<audio id="ding" src="ding.mp3"></audio>

<script>
/* ========== DONN√âES ========== */
const bankData = [
  { uv:'ü•ã UV 1 ‚Äì Kihon', items:['Kihon simple','Encha√Ænement de kihon','Travail aux cibles'], criteria:['Pr√©cision','R√©activit√©','Posture'] },
  { uv:'üåÄ UV 2 ‚Äì D√©placements', items:['Ta√Ø sabaki','Slow ippon','Ippon kumite'], criteria:['Fluidit√©','√âquilibre','Contr√¥le'] },
  { uv:'üìê UV 3 ‚Äì Kata', items:['Slow kata','Kata nidan','Bunka√Ø'], criteria:['Exactitude','Ma√Ætrise','Kime'] },
  { uv:'‚öôÔ∏è UV 4 ‚Äì Techniques de base', items:['Shadow technique','Encha√Ænements libres'], criteria:['R√©alisme','Zanchin','Protection'] },
  { uv:'üî• UV 5 & 6 ‚Äì Randori', items:['Randori shadow','Randori dirig√©'], criteria:['R√©alisme','Zanchin','Protection'] }
];

let selection = JSON.parse(localStorage.getItem('tj-selection'))||[];
let sessions = JSON.parse(localStorage.getItem('tj-sessions'))||{};
let goals = JSON.parse(localStorage.getItem('tj-goals'))||{};
let seqIndex=0, timer=null, paused=false, fullscreen=false;
let currentSessionName="";

/* ===== UTIL ===== */
function weekKey(){
 const d=new Date(),j=new Date(d.getFullYear(),0,1);
 return d.getFullYear()+"-W"+Math.ceil((((d-j)/86400000)+j.getDay()+1)/7);
}
function speak(txt,cb){ const u=new SpeechSynthesisUtterance(txt); u.lang='fr-FR'; u.onend=cb; speechSynthesis.speak(u); }
function formatTime(sec){ const m=Math.floor(sec/60); const s=sec%60; return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; }

/* ===== RENDER ===== */
function renderBank(){
  const bankEl=document.getElementById('bank'); bankEl.innerHTML='';
  bankData.forEach(u=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`<h3>${u.uv}</h3>`;
    u.items.forEach(n=>{
      const btn=document.createElement('button'); btn.className='btn';
      btn.textContent=n; btn.onclick=()=>addExercise(u.uv,n);
      div.appendChild(btn);
    });
    bankEl.appendChild(div);
  });
}

function renderSelection(){
  const sel=document.getElementById('selection'); sel.innerHTML='';
  if(!selection.length){ sel.innerHTML='<em>Aucun exercice</em>'; return;}
  selection.forEach((ex,i)=>{
    const div=document.createElement('div'); div.className='exercise selected';
    div.innerHTML=`
      ${ex.uv} ‚Äì ${ex.name}
      <div>
        <input type="range" min="1" max="60" value="${ex.duration}" oninput="updateDuration(${i},this.value)">
        ${ex.duration} min
        <button onclick="moveUp(${i})">‚¨ÜÔ∏è</button>
        <button onclick="moveDown(${i})">‚¨áÔ∏è</button>
        <button onclick="removeExercise(${i})">‚ùå</button>
      </div>
    `;
    sel.appendChild(div);
  });
  renderGoals();
}

function renderGoals(){
  const gEl=document.getElementById('goals'); gEl.innerHTML='';
  const wk=weekKey();
  selection.forEach(ex=>{
    if(!goals[ex.name]) goals[ex.name]=30;
    let done=0;
    Object.values(sessions).forEach(s=>s.exercises.forEach(e=>{if(e.name===ex.name && e.doneMinutes) done+=e.doneMinutes;}));
    const pct=Math.min(100,Math.round(done/goals[ex.name]*100));
    gEl.innerHTML+=`
      <div>
        <strong>${ex.name}</strong><br>
        Objectif <input type="number" value="${goals[ex.name]}" onchange="setGoal('${ex.name}',this.value)"> min
        <progress value="${pct}" max="100"></progress>
        ${pct}%
      </div>`;
  });
  localStorage.setItem('tj-goals',JSON.stringify(goals));
}

/* ===== ACTIONS ===== */
function addExercise(uv,name){ selection.push({uv,name,duration:5,doneMinutes:0}); saveSelection(); }
function updateDuration(i,v){ selection[i].duration=parseInt(v); saveSelection(); }
function moveUp(i){ if(i>0){ [selection[i-1],selection[i]]=[selection[i],selection[i-1]]; saveSelection(); } }
function moveDown(i){ if(i<selection.length-1){ [selection[i+1],selection[i]]=[selection[i+1],selection[i]]; saveSelection(); } }
function removeExercise(i){ selection.splice(i,1); saveSelection(); }
function saveSelection(){ localStorage.setItem('tj-selection',JSON.stringify(selection)); renderSelection(); }
function clearSelection(){ if(confirm('Vider la s√©lection ?')){ selection=[]; saveSelection(); } }
function setGoal(name,v){ goals[name]=parseInt(v); renderGoals(); }

/* ===== ENTRA√éNEMENT ===== */
const beep=document.getElementById('beep'), ding=document.getElementById('ding');
const trainingOverlay=document.getElementById('trainingOverlay');
const exerciseName=document.getElementById('exerciseName');
const timerEl=document.getElementById('timer');
const sessionProgress=document.getElementById('sessionProgress');

function startSession(){
  if(!selection.length){ alert('S√©lectionnez des exercices'); return; }
  const name=document.getElementById('sessionName').value.trim()||"S√©ance "+new Date().toLocaleString();
  currentSessionName=name;
  sessions[name]={ date:new Date().toLocaleString(), week:weekKey(), exercises:selection.map(e=>({...e,doneMinutes:0})), notes:document.getElementById('notes').value };
  localStorage.setItem('tj-sessions',JSON.stringify(sessions));
  seqIndex=0; paused=false;
  speak("Commen√ßons l'entra√Ænement", nextExercise);
}

let intervalId=null;
function nextExercise(){
  if(seqIndex>=selection.length){ speak("Entra√Ænement termin√©, √† bient√¥t !"); return; }
  const ex=selection[seqIndex];
  exerciseName.textContent=ex.name;
  if(fullscreen) trainingOverlay.style.display='flex';
  speak(`Exercice ${seqIndex+1} : ${ex.name}`,()=>{
    setTimeout(()=>{
      beep.play();
      let remaining=ex.duration*60; timerEl.textContent=formatTime(remaining);
      sessionProgress.value=(seqIndex)/selection.length*100;
      clearInterval(intervalId);
      intervalId=setInterval(()=>{
        if(!paused){
          remaining--; timerEl.textContent=formatTime(remaining);
          sessionProgress.value=(seqIndex + (ex.duration*60-remaining)/(ex.duration*60))/selection.length*100;
          if(remaining<=0){
            clearInterval(intervalId); ding.play();
            selection[seqIndex].doneMinutes=ex.duration;
            sessions[currentSessionName].exercises[seqIndex].doneMinutes=ex.duration;
            localStorage.setItem('tj-sessions',JSON.stringify(sessions));
            speak("Fin de l'exercice",()=>{ seqIndex++; nextExercise(); });
          }
        }
      },1000);
    },2000);
  });
}

function pauseTraining(){ paused=true; }
function resumeTraining(){ paused=false; }
function stopTraining(){ paused=true; seqIndex=selection.length; trainingOverlay.style.display='none'; sessionProgress.value=100; }

/* ===== PLEIN √âCRAN ===== */
function toggleFullscreen(){ fullscreen=!fullscreen; trainingOverlay.style.display=fullscreen?'flex':'none'; }

/* ===== HISTORIQUE ===== */
function showHistory(){
  const modal=document.getElementById('modal'); modal.style.display='flex';
  let html='<h3>üìä Historique des s√©ances</h3>';
  for(const name in sessions){
    const s=sessions[name];
    html+=`<div><strong>${name}</strong> (${s.date})<br>Notes: ${s.notes||''}<br>`;
    s.exercises.forEach(e=>{ html+=`- ${e.name}: ${e.doneMinutes||0} min<br>`; });
    html+='</div><hr>';
  }
  document.getElementById('historyList').innerHTML=html;
}
function closeModal(){ document.getElementById('modal').style.display='none'; }

/* ===== INIT ===== */
renderBank();
renderSelection();
</script>
</body>
</html>
