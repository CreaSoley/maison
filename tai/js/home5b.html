<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Coaching Karate</title>

<style>
body{font-family:Arial;margin:0;background:#f4f4f4;padding:10px}
h2{text-align:center}
.card{background:#fff;border-radius:12px;padding:12px;margin-bottom:12px}
.btn{padding:6px 12px;border-radius:18px;border:2px solid #ff64c4;background:white;font-weight:bold}
.btn-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.sequence-item{padding:8px;border-radius:8px;margin-bottom:6px;background:#eee}
.sequence-item.active{background:#ffd6ec;font-weight:bold}
.sequence-item.done{text-decoration:line-through;opacity:.6}
progress{width:100%}
#overlay{display:none;position:fixed;inset:0;background:black;color:white;z-index:999;
align-items:center;justify-content:center;flex-direction:column;gap:12px}
</style>
</head>

<body>

<h2>ü•ã Coaching Karate</h2>

<div class="card">
<h3>Banque</h3>
<div id="bank"></div>
</div>

<div class="card">
<h3>S√©lection</h3>
<div id="selection"></div>
<div class="btn-row">
<button class="btn" onclick="startTraining()">‚ñ∂Ô∏è D√©marrer</button>
<button class="btn" onclick="showOverlay()">üñ• Plein √©cran</button>
<button class="btn" onclick="editGoals()">üéØ Objectifs</button>
<button class="btn" onclick="showHistory()">üìú Historique</button>
</div>
</div>

<div class="card">
<h3>üéØ Objectifs hebdomadaires</h3>
<div id="goalsView"></div>
</div>

<div class="card" id="historyBox" style="display:none"></div>

<div id="overlay">
<h2 id="oTitle"></h2>
<div id="oTimer" style="font-size:2rem"></div>
<progress id="oProgress" value="0" max="100"></progress>
<div class="btn-row">
<button class="btn" onclick="pause()">‚è∏</button>
<button class="btn" onclick="resume()">‚ñ∂Ô∏è</button>
<button class="btn" onclick="hideOverlay()">‚¨ÖÔ∏è</button>
</div>
</div>

<script>
/* ===== DATA ===== */
const bankData=[
{uv:"UV1 ‚Äì Kihon",ex:["Kihon simple","Encha√Ænement kihon","Travail aux cibles"]},
{uv:"UV2 ‚Äì D√©placements",ex:["Ta√Ø sabaki","Slow ippon","Ippon kumite"]},
{uv:"UV3 ‚Äì Kata",ex:["Slow kata","Kata nidan","Bunka√Ø"]},
{uv:"UV4 ‚Äì Techniques",ex:["Shadow technique","Encha√Ænements libres"]},
{uv:"UV5-6 ‚Äì Randori",ex:["Randori shadow","Randori dirig√©"]}
];

let selection=[],idx=0,remaining=0,timer=null,paused=false,trainingActive=false;
let history=JSON.parse(localStorage.getItem("tj-history")||"[]");
let goals=JSON.parse(localStorage.getItem("tj-goals")||"{}");
let currentSession=null;

/* ===== UTIL ===== */
function weekKey(){
const d=new Date(),o=new Date(d.getFullYear(),0,1);
return d.getFullYear()+"-W"+Math.ceil((((d-o)/86400000)+o.getDay()+1)/7);
}

/* ===== UI ===== */
function renderBank(){
const b=document.getElementById("bank");b.innerHTML="";
bankData.forEach(u=>{
const d=document.createElement("div");
d.innerHTML=`<strong>${u.uv}</strong><br>`;
u.ex.forEach(n=>{
const btn=document.createElement("button");
btn.className="btn";btn.textContent=n;
btn.onclick=()=>{selection.push({name:n,duration:5,done:false});renderSelection();}
d.appendChild(btn);
});
b.appendChild(d);
});
}

function renderSelection(){
const s=document.getElementById("selection");s.innerHTML="";
selection.forEach((e,i)=>{
s.innerHTML+=`
<div class="sequence-item ${i===idx?"active":""} ${e.done?"done":""}">
${e.name}<br>
<input type="number" value="${e.duration}" min="1"
onchange="selection[${i}].duration=Number(this.value)"> min
<button onclick="selection.splice(${i},1);renderSelection()">‚ùå</button>
</div>`;
});
}

function renderGoals(){
const g=document.getElementById("goalsView");g.innerHTML="";
const wk=weekKey(),tot={};
history.forEach(s=>s.week===wk&&s.exercises.forEach(e=>{
tot[e.name]=(tot[e.name]||0)+e.minutes;
}));
Object.keys(goals).forEach(n=>{
const d=tot[n]||0,t=goals[n];
g.innerHTML+=`${n} ${d}/${t} min<progress value="${Math.min(100,d/t*100)}"></progress>`;
});
}

/* ===== TRAINING ===== */
function startTraining(){
if(trainingActive||!selection.length)return;
trainingActive=true;
idx=0;selection.forEach(e=>e.done=false);

currentSession={date:new Date().toLocaleString(),week:weekKey(),exercises:[]};
history.push(currentSession);
localStorage.setItem("tj-history",JSON.stringify(history));

speech("Commen√ßons l'entra√Ænement");
runExercise();
}

function runExercise(){
if(idx>=selection.length){
trainingActive=false;
speech("Fin de l'entra√Ænement");
renderGoals();renderSelection();
return;
}
const ex=selection[idx];
remaining=ex.duration*60;
updateOverlay(ex.name);
speech("Exercice "+ex.name);
tick();renderSelection();
}

function tick(){
if(!trainingActive||paused)return;
document.getElementById("oTimer").textContent=
Math.floor(remaining/60)+":"+String(remaining%60).padStart(2,"0");
document.getElementById("oProgress").value=
100*(1-remaining/(selection[idx].duration*60));
if(remaining--<=0){
selection[idx].done=true;
currentSession.exercises.push({name:selection[idx].name,minutes:selection[idx].duration});
localStorage.setItem("tj-history",JSON.stringify(history));
idx++;runExercise();return;
}
timer=setTimeout(tick,1000);
}

/* ===== CONTROLS ===== */
function pause(){paused=true;clearTimeout(timer)}
function resume(){if(!paused)return;paused=false;tick()}
function showOverlay(){overlay.style.display="flex"}
function hideOverlay(){overlay.style.display="none"}
function updateOverlay(t){oTitle.textContent=t}

/* ===== VOICE ===== */
function speech(t){
try{
const u=new SpeechSynthesisUtterance(t);
u.lang="fr-FR";speechSynthesis.speak(u);
}catch(e){}
}

/* ===== GOALS ===== */
function editGoals(){
selection.forEach(e=>{
const v=prompt("Objectif pour "+e.name,goals[e.name]||30);
if(v)goals[e.name]=Number(v);
});
localStorage.setItem("tj-goals",JSON.stringify(goals));
renderGoals();
}

/* ===== HISTORY ===== */
function showHistory(){
const box=document.getElementById("historyBox");
box.style.display="block";
box.innerHTML="<h3>üìú Historique</h3>";
if(!history.length){box.innerHTML+="Aucune s√©ance";return;}
history.forEach((s,i)=>{
let tot=0;
box.innerHTML+=`<strong>S√©ance ${i+1}</strong><br>${s.date}<ul>`;
s.exercises.forEach(e=>{tot+=e.minutes;box.innerHTML+=`<li>${e.name} ${e.minutes} min</li>`});
box.innerHTML+=`</ul>Total ${tot} min<hr>`;
});
}

/* INIT */
renderBank();renderSelection();renderGoals();
</script>
</body>
</html>
