<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tai-Jitsu Coach</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<style>
*{box-sizing:border-box}
body{margin:0;font-family:'Fredoka',Arial,sans-serif;background-image:linear-gradient(120deg,#84fab0 0%,#8fd3f4 100%)}
.container{padding:12px}
.card{background:#fff;border-radius:18px;padding:14px;margin-bottom:14px;box-shadow:0 6px 12px rgba(0,0,0,.1)}
h1,h2,h3{text-align:center}
button{border:none;border-radius:14px;padding:10px 14px;font-family:'Fredoka';cursor:pointer;margin:4px 0}
.btn-primary{background-image:linear-gradient(to right,#fa709a,#fee140);color:#fff}
.btn-secondary{background:#84fab0;color:#fff}
.btn-danger{background:#ff6b6b;color:#fff}
button.active{background-image:linear-gradient(to top,#30cfd0,#330867);color:#fff}
.accordion-header{font-weight:600;display:flex;justify-content:space-between;cursor:pointer}
.accordion-content{display:none;margin-top:10px}
.exercise{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px dashed #ddd}
.exercise.active{background:#fff3cd;border-radius:10px;padding:6px}
.progress{width:100%;height:10px;background:#eee;border-radius:10px;overflow:hidden;margin:6px 0}
.progress-bar{height:100%;background-image:linear-gradient(to right,#fa709a,#fee140)}
.timers{text-align:center;font-weight:600}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;padding:12px}
.modal-content{background:#fff;border-radius:18px;padding:14px;width:100%;max-height:90vh;overflow:auto}
textarea{width:100%;border-radius:12px;padding:8px}
.rating{display:flex;justify-content:space-between;font-size:12px}
</style>
</head>
<body>

<div class="container">
<h1>ü•ã Tai-Jitsu Coach</h1>

<!-- OBJECTIFS -->
<div class="card">
  <div class="accordion-header" onclick="toggleAccordion(this)">
    üéØ Objectifs hebdomadaires <span>‚¨áÔ∏è</span>
  </div>
  <div class="accordion-content" id="objectifs">Chargement‚Ä¶</div>
</div>

<!-- BANQUE -->
<div class="card">
  <div class="accordion-header" onclick="toggleAccordion(this)">
    üìö Banque d'exercices <span>‚¨áÔ∏è</span>
  </div>
  <div class="accordion-content" id="bank"></div>
</div>

<!-- S√âLECTION -->
<div class="card">
  <h3>üìù S√©ance s√©lectionn√©e</h3>
  <div id="selection"></div>
  <button class="btn-secondary" onclick="clearSelection()">Vider</button>
</div>

<!-- SESSION -->
<div class="card">
  <h3>‚è±Ô∏è S√©ance</h3>
  <div class="progress"><div class="progress-bar" id="globalProgress"></div></div>
  <div class="timers" id="timers">00:00 | 00:00</div>
  <button class="btn-primary" id="startBtn" onclick="startSession()">Commencer</button>
  <button class="btn-secondary" id="pauseBtn" onclick="pauseResume()">Pause</button>
  <button class="btn-danger" onclick="stopSession()">Stop</button>
</div>

</div>
<div class="card">
 <button class="btn-primary" onclick="generatePDF()">üìÑ G√©n√©rer le bilan PDF</button>

</div>
<div class="card">
  <h3>üìä Analyse des √©valuations</h3>
  <input type="date" id="fromDate">
  <input type="date" id="toDate">
  <button class="btn-primary" onclick="showStats()">Afficher</button>
  <canvas id="statsChart"></canvas>
</div>

<!-- √âVALUATION -->
<div class="modal" id="evaluationModal">
<div class="modal-content">
<h2>üìù Auto-√©valuation</h2>
<textarea id="notes"></textarea>
<div id="evaluation"></div>
<button class="btn-primary" onclick="saveEvaluation()">Valider</button>
</div>
</div>

<script>
/* ================= CONFIG ================= */
const GOOGLE_API_URL = "https://script.google.com/macros/s/AKfycbw0XUFA42PqPRoROu_Dru3gKie9QfBZq0cVlxT3xxys6kDVUaKIg4d188rPmXebDFxnWg/exec";

/* ================= DONN√âES ================= */
const EXERCISES = [
 {name:'UV1 : Kihon simples',criteria:['pr√©cision','kime','posture']},
 {name:'UV1 : Encha√Ænements',criteria:['pr√©cision','kime','posture']},
 {name:'UV1 : Cibles',criteria:['pr√©cision','kime','posture']},
 {name:'UV2 : Ta√Ø sabaki',criteria:['fluidit√©','distance','contr√¥le']},
 {name:'UV2 : Ippon kumite lent',criteria:['fluidit√©','distance','contr√¥le']},
 {name:'UV2 : Ippon kumite examen',criteria:['fluidit√©','distance','contr√¥le']},
 {name:'UV3 : Kata lent',criteria:['exactitude','kime','√©quilibre']},
 {name:'UV3 : Kata examen',criteria:['exactitude','kime','√©quilibre']},
 {name:'UV3 : Bunka√Ø',criteria:['exactitude','kime','√©quilibre']},
 {name:'UV4: Technique de base',criteria:['r√©alisme','zanchin','protection']},
 {name:'UV5-6 : Self-defense arme',criteria:['r√©alisme','zanchin','protection']},
 {name:'UV5-6 : Self-defense atemi',criteria:['r√©alisme','zanchin','protection']},
 {name:'UV5-6 : Self-defense saisie',criteria:['r√©alisme','zanchin','protection']}
];

let selection=[],currentIndex=0,timer=null,paused=false;
let remainingExercise=0,remainingGlobal=0;

/* ================= OBJECTIFS ================= */
async function fetchObjectivesFromSheet(){
  try{
    const r=await fetch(GOOGLE_API_URL+"?action=fetchObjectives");
    const data=await r.json();
    renderObjectives(data);
  }catch(e){
    document.getElementById("objectifs").innerHTML="Erreur chargement objectifs";
  }
}

function renderObjectives(list){
  const div=document.getElementById("objectifs");
  div.innerHTML="";
  list.forEach(o=>{
    const pct=o.ObjectifHebdo?Math.round((o.R√©alis√©/o.ObjectifHebdo)*100):0;
    div.innerHTML+=`
      <strong>${o.Exercice}</strong>
      <div class="progress">
        <div class="progress-bar" style="width:${pct}%"></div>
      </div>
      <small>${o.R√©alis√©}/${o.ObjectifHebdo} min (${pct}%)</small>
    `;
  });
}

/* ================= UI ================= */
function toggleAccordion(h){
  const c=h.nextElementSibling;
  const a=h.querySelector("span");
  const open=c.style.display==="block";
  c.style.display=open?"none":"block";
  a.textContent=open?"‚¨áÔ∏è":"‚¨ÜÔ∏è";
}

function renderBank(){
  bank.innerHTML="";
  EXERCISES.forEach(e=>{
    bank.innerHTML+=`
    <div class="exercise">
      <span>${e.name}</span>
      <button onclick="addExercise('${e.name}')">‚ûï</button>
    </div>`;
  });
}

function addExercise(n){
  selection.push({name:n,duration:10});
  renderSelection();
}

function renderSelection(){
  selectionDiv.innerHTML="";
  selection.forEach((e,i)=>{
    selectionDiv.innerHTML+=`
    <div class="exercise ${i===currentIndex?'active':''}">
      <span>${e.name}</span>
      <input type="range" min="1" max="60" value="${e.duration}"
        oninput="selection[${i}].duration=parseInt(this.value)">
      <span>${e.duration} min</span>
    </div>`;
  });
}

function clearSelection(){selection=[];renderSelection()}

/* ================= SESSION ================= */
const ding=new Audio("ding.mp3");
const beep=new Audio("beep.mp3");

function speak(t){speechSynthesis.speak(new SpeechSynthesisUtterance(t))}

// ==================== NOUVELLE SYNTH√àSE ====================
function startSession(){
  if(!selection.length) return;
  startBtn.disabled=true;
  remainingGlobal = selection.reduce((s,e)=>s+e.duration*60,0);
  speak("Bonjour, commen√ßons l'entra√Ænement !");
  setTimeout(()=>runExerciseWithSpeech(0),2000);
}

function runExerciseWithSpeech(i){
  if(i>=selection.length){endSession(); return;}
  currentIndex=i;
  renderSelection();
  const ordinals=["premier","deuxi√®me","troisi√®me","quatri√®me","cinqui√®me","sixi√®me","septi√®me","huiti√®me","neuvi√®me","dixi√®me"];
  speak(`${ordinals[i]||i+1} exercice, ${selection[i].name}`);
  remainingExercise = selection[i].duration*60;

  // timer de l'exercice avec rappel 10s
  timer = setInterval(()=>{
    if(!paused){
      remainingExercise--; remainingGlobal--;
      updateTimers(); updateProgress();
      if(remainingExercise===10){
        speak("10 secondes");
      }
      if(remainingExercise<=0){
        clearInterval(timer);
        if(i<selection.length-1){
          ding.play();
          setTimeout(()=>runExerciseWithSpeech(i+1),500);
        } else {
          // dernier exercice
          beep.play();
          setTimeout(()=>endSessionSpeech(),3000);
        }
      }
    }
  },1000);
}

function endSessionSpeech(){
  speak("Fin de l'entra√Ænement, place √† l'auto-√©valuation");
  evaluationModal.style.display="flex";
  renderEvaluation();
  sendSessionToSheet();
  fetchObjectivesFromSheet();
}

// ==================== TIMER ET PROGRESS ====================
function updateTimers(){ timers.textContent=`${fmt(remainingExercise)} | ${fmt(remainingGlobal)}` }
function updateProgress(){
  const total=selection.reduce((s,e)=>s+e.duration*60,0);
  const done=total-remainingGlobal;
  globalProgress.style.width=`${Math.round(done/total*100)}%`;
}
function pauseResume(){
  paused=!paused;
  pauseBtn.textContent=paused?"Reprendre":"Pause";
  pauseBtn.classList.toggle("active",paused);
}
function stopSession(){ clearInterval(timer); endSessionSpeech(); }
function fmt(s){ return String(Math.floor(s/60)).padStart(2,"0")+":"+String(s%60).padStart(2,"0") }

/* ================= GOOGLE SHEET ================= */
function sendSessionToSheet(){
  selection.forEach(ex=>{
    const params=new URLSearchParams({
      action:"addSession",
      exercice:ex.name,
      duree:ex.duration,
      notes:notes.value||""
    });
    fetch(GOOGLE_API_URL+"?"+params.toString());
  });
}

/* ================= √âVALUATION ================= */
function renderEvaluation(){
  evaluation.innerHTML="";
  selection.forEach(e=>{
    const def=EXERCISES.find(x=>x.name===e.name);
    if(!def) return;
    evaluation.innerHTML+=`<h4>${e.name}</h4>`;
    def.criteria.forEach(c=>{
      evaluation.innerHTML+=`
      <div class="rating">
        ${c}
        ${[0,1,2,3,4,5].map(v=>`
          <label>
            <input type="radio" name="${e.name+c}" value="${v}">${v}
          </label>`).join("")}
      </div>`;
    });
  });
}
  async function generatePDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  let y = 10;

  pdf.setFontSize(16);
  pdf.text("Bilan hebdomadaire Tai-Jitsu",10,y);
  y+=10;

  // OBJECTIFS
  const r = await fetch(GOOGLE_API_URL+"?action=fetchObjectives");
  const goals = await r.json();

  pdf.setFontSize(12);
  pdf.text("Objectifs hebdomadaires",10,y);
  y+=6;

  goals.forEach(g=>{
    const pct = Math.round((g.R√©alis√©/g.ObjectifHebdo)*100);
    pdf.text(`${g.Exercice} : ${pct}%`,10,y);
    pdf.rect(10,y+2,100,4);
    pdf.rect(10,y+2,pct,4,"F");
    y+=10;
  });

  // NOTES 7 JOURS
  const e = await fetch(GOOGLE_API_URL+"?action=fetchEvaluations");
  const evals = await e.json();

  pdf.addPage();
  y=10;
  pdf.text("Notes ‚Äì 7 derniers jours",10,y);
  y+=8;

  evals.slice(-7).forEach(ev=>{
    pdf.text(`${ev.Date} ‚Äì ${ev.Exercice}`,10,y);
    y+=5;
    pdf.text(ev.Notes || "",12,y);
    y+=8;
  });

  pdf.save("bilan_tai_jitsu.pdf");
}

function saveEvaluation(){
  const evaluations = [];

  selection.forEach(ex=>{
    const def = EXERCISES.find(e=>e.name===ex.name);
    if(!def) return;

    const criteria = {};
    def.criteria.forEach(c=>{
      const v = document.querySelector(
        `input[name="${ex.name+c}"]:checked`
      );
      if(v) criteria[c] = parseInt(v.value);
    });

    evaluations.push({
      name: ex.name,
      criteria
    });
  });

  const payload = {
    action: "addEvaluation",
    date: new Date().toISOString(),
    notes: notes.value || "",
    evaluations
  };

  fetch(GOOGLE_API_URL,{
    method:"POST",
    body: JSON.stringify(payload)
  });

  location.reload();
}

/* ================= INIT ================= */
const bank=document.getElementById("bank");
const selectionDiv=document.getElementById("selection");
const timers=document.getElementById("timers");
const globalProgress=document.getElementById("globalProgress");
const startBtn=document.getElementById("startBtn");
const pauseBtn=document.getElementById("pauseBtn");
const evaluation=document.getElementById("evaluation");
const evaluationModal=document.getElementById("evaluationModal");
const notes=document.getElementById("notes");

renderBank();
fetchObjectivesFromSheet();
</script>
</body>
</html>
