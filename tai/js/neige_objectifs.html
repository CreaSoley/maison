<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>Tai‚ÄëJitsu Coach ‚Äì Ceinture Noire</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Fredoka', Arial, sans-serif;
      background-image: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);
      color: #333;
      overflow-x: hidden;
    }

    h1, h2, h3 {
      text-align: center;
    }

    .container {
      padding: 12px;
    }

    .card {
      background: white;
      border-radius: 18px;
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }

    button {
      border: none;
      border-radius: 14px;
      padding: 10px 14px;
      font-family: 'Fredoka', Arial, sans-serif;
      font-size: 14px;
      cursor: pointer;
      margin: 4px 0;
    }

    .btn-primary {
      background-image: linear-gradient(to right, #fa709a 0%, #fee140 100%);
      color: #fff;
    }

    .btn-secondary {
      background: #84fab0;
      color: #fff;
    }

    .btn-danger {
      background: #ff6b6b;
      color: #fff;
    }

    .accordion-header {
      font-weight: 600;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .accordion-content {
      display: none;
      margin-top: 10px;
    }

    .exercise {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px dashed #ddd;
    }

    .exercise.active {
      background: #fff3cd;
      border-radius: 10px;
      padding: 6px;
    }

    .exercise.done {
      text-decoration: line-through;
      opacity: 0.5;
    }

    input[type=range] {
      width: 100%;
    }

    .progress {
      width: 100%;
      height: 10px;
      background: #eee;
      border-radius: 10px;
      overflow: hidden;
      margin: 6px 0;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background-image: linear-gradient(to right, #fa709a 0%, #fee140 100%);
      transition: width 0.3s;
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      padding: 12px;
    }

    .modal-content {
      background: white;
      border-radius: 18px;
      padding: 14px;
      max-height: 90vh;
      overflow-y: auto;
      width: 100%;
    }

    textarea {
      width: 100%;
      border-radius: 12px;
      padding: 8px;
      border: 1px solid #ccc;
      font-family: 'Fredoka', Arial, sans-serif;
    }

    .rating {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .rating label {
      font-size: 12px;
    }

  </style>
</head>
<body>

  <div class="container">
    <h1>ü•ã Tai‚ÄëJitsu Coach</h1>

    <!-- STEP 1 OBJECTIFS -->
    <div class="card">
      <div class="accordion-header" onclick="toggleAccordion(this)">
        üéØ Objectifs hebdomadaires
        <span>‚¨áÔ∏è</span>
      </div>
      <div class="accordion-content" id="objectifs"></div>
      <button class="btn-secondary" onclick="editObjectives()">‚úèÔ∏è √âditer les objectifs</button>
    </div>

    <!-- STEP 2 SELECTION -->
    <div class="card">
      <div class="accordion-header" onclick="toggleAccordion(this)">
        üìö Banque d'exercices
        <span>‚¨áÔ∏è</span>
      </div>
      <div class="accordion-content" id="bank"></div>
    </div>

    <div class="card">
      <h3>üìù S√©ance s√©lectionn√©e</h3>
      <div id="selection"></div>
      <button class="btn-secondary" onclick="clearSelection()">Vider la s√©lection</button>
    </div>

    <!-- STEP 4 -->
    <div class="card">
      <h3>‚è±Ô∏è Lancer la s√©ance</h3>
      <div class="progress"><div class="progress-bar" id="globalProgress"></div></div>
      <p id="timers">00:00 | 00:00</p>
      <button class="btn-primary" onclick="startSession()">Commencer la s√©ance</button>
      <button class="btn-secondary" onclick="pauseResume()">Pause / Reprise</button>
      <button class="btn-danger" onclick="stopSession()">Stopper</button>
    </div>
  </div>

  <!-- MODAL EVALUATION -->
  <div class="modal" id="evaluationModal">
    <div class="modal-content">
      <h2>üìù Auto‚Äë√©valuation</h2>
      <textarea id="notes" placeholder="Carnet de notes..."></textarea>
      <div id="evaluation"></div>
      <button class="btn-primary" onclick="saveEvaluation()">Valider</button>
    </div>
  </div>

<script>
const DEFAULT_GOAL = 60;

function getWeekKey(){
  const d = new Date();
  const onejan = new Date(d.getFullYear(),0,1);
  const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
  return `${d.getFullYear()}-W${week}`;
}

function loadObjectives(){
  const weekKey = getWeekKey();
  let data = JSON.parse(localStorage.getItem('objectives')) || {};

  if(!data.week || data.week !== weekKey){
    data = { week: weekKey, goals: {} };
    EXERCISES.forEach(ex => data.goals[ex.name] = { target: DEFAULT_GOAL, done: 0 });
    localStorage.setItem('objectives', JSON.stringify(data));
  }
  return data;
}

function renderObjectives(){
  const data = loadObjectives();
  const div = document.getElementById('objectifs');
  div.innerHTML = '';

  Object.entries(data.goals).forEach(([name,goal])=>{
    const pct = Math.min(100, Math.round((goal.done/goal.target)*100));
    const block = document.createElement('div');
    block.innerHTML = `
      <strong>${name}</strong>
      <div class="progress"><div class="progress-bar" style="width:${pct}%"></div></div>
      <small>${goal.done} / ${goal.target} min (${pct}%)</small>
    `;
    div.appendChild(block);
  });
}

function editObjectives(){
  const data = loadObjectives();
  Object.keys(data.goals).forEach(name=>{
    const val = prompt(`Dur√©e hebdomadaire pour ${name} (minutes)`, data.goals[name].target);
    if(val!==null){
      data.goals[name].target = parseInt(val);
      data.goals[name].done = 0;
    }
  });
  localStorage.setItem('objectives', JSON.stringify(data));
  renderObjectives();
}

const EXERCISES = [
  { name: 'UV1 : Kihon simples', criteria: ['pr√©cision','kime','posture'] },
  { name: 'UV1 : Encha√Ænements', criteria: ['pr√©cision','kime','posture'] },
  { name: 'UV1 : Cibles', criteria: ['pr√©cision','kime','posture'] },
  { name: 'UV2 : Ta√Ø sabaki', criteria: ['fluidit√©','distance','contr√¥le'] },
  { name: 'UV2 : Ippon kumite lent', criteria: ['fluidit√©','distance','contr√¥le'] },
  { name: 'UV2 : Ippon kumite examen', criteria: ['fluidit√©','distance','contr√¥le'] },
  { name: 'UV3 : Kata lent', criteria: ['exactitude','kime','√©quilibre'] },
  { name: 'UV3 : Kata examen', criteria: ['exactitude','kime','√©quilibre'] },
  { name: 'UV3 : Bunka√Ø', criteria: ['exactitude','kime','√©quilibre'] },
  { name: 'UV4 : Technique de base', criteria: ['r√©alisme','zanchin','protection'] },
  { name: 'UV5-6 : Self-defense arme', criteria: ['r√©alisme','zanchin','protection'] },
  { name: 'UV5-6 : Self-defense atemi', criteria: ['r√©alisme','zanchin','protection'] },
  { name: 'UV5-6 : Self-defense saisie', criteria: ['r√©alisme','zanchin','protection'] }
];

renderObjectives();
renderBank(){
  const bank = document.getElementById('bank');
  bank.innerHTML = '';
  EXERCISES.forEach(ex => {
    const div = document.createElement('div');
    div.className = 'exercise';
    div.innerHTML = `<span>${ex.name}</span><button onclick="addExercise('${ex.name}')">‚ûï</button>`;
    bank.appendChild(div);
  });
}

function addExercise(name){
  selection.push({ name, duration: 10 });
  renderSelection();
}

function renderSelection(){
  const sel = document.getElementById('selection');
  sel.innerHTML = '';
  selection.forEach((ex,i)=>{
    const div = document.createElement('div');
    div.className = 'exercise';
    div.innerHTML = `
      <span>${ex.name}</span>
      <input type="range" min="1" max="60" value="${ex.duration}" onchange="setDuration(${i},this.value)">
      <span>${ex.duration} min</span>
    `;
    sel.appendChild(div);
  });
}

function setDuration(i,val){ selection[i].duration = parseInt(val); }
function clearSelection(){ selection = []; renderSelection(); }

function speak(text){
  const u = new SpeechSynthesisUtterance(text);
  speechSynthesis.speak(u);
}

function startSession(){
  if(selection.length===0) return;
  speak('Commen√ßons l\'entra√Ænement');
  setTimeout(()=>runExercise(0),2000);
}

function runExercise(i){
  if(i>=selection.length){ endSession(); return; }
  currentIndex=i;
  speak(`${i+1}√®me exercice, ${selection[i].name}`);
  let remaining = selection[i].duration*60;
  timer = setInterval(()=>{
    if(!paused){
      remaining--;
      if(remaining<=0){ clearInterval(timer); runExercise(i+1); }
    }
  },1000);
}

function pauseResume(){ paused = !paused; }

function stopSession(){ clearInterval(timer); endSession(); }

function endSession(){
  speak('Fin de l\'entra√Ænement, place √† l\'auto‚Äë√©valuation');
  document.getElementById('evaluationModal').style.display='flex';
  renderEvaluation();
}

function renderEvaluation(){
  const div = document.getElementById('evaluation');
  div.innerHTML='';
  selection.forEach(ex=>{
    const def = EXERCISES.find(e=>e.name===ex.name);
    const block = document.createElement('div');
    block.innerHTML = `<h4>${ex.name}</h4>`;
    def.criteria.forEach(c=>{
      const row = document.createElement('div');
      row.className='rating';
      row.innerHTML = `<span>${c}</span>` +
        Array.from({length:6},(_,i)=>`<label><input type='radio' name='${ex.name}-${c}' value='${i}'>${i}</label>`).join('');
      block.appendChild(row);
    });
    div.appendChild(block);
  });
}

function saveEvaluation(){
  const data = {
    id: crypto.randomUUID(),
    date: new Date().toISOString(),
    selection,
    notes: document.getElementById('notes').value
  };
  const hist = JSON.parse(localStorage.getItem('history')||'[]');
  hist.push(data);
  localStorage.setItem('history',JSON.stringify(hist));
  location.reload();
}

renderBank();
</script>
</body>
</html>
