
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tai-Jitsu Coach</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>


<style>
*{box-sizing:border-box}
body{margin:0;font-family:'Fredoka',Arial,sans-serif;background-image:linear-gradient(120deg,#84fab0 0%,#8fd3f4 100%)}
.container{padding:12px}
.card{background:#fff;border-radius:18px;padding:14px;margin-bottom:14px;box-shadow:0 6px 12px rgba(0,0,0,.1)}
h1,h2,h3{text-align:center}
button{border:none;border-radius:14px;padding:10px 14px;font-family:'Fredoka';cursor:pointer;margin:4px 0}
.btn-primary{background-image:linear-gradient(to right,#fa709a,#fee140);color:#fff}
.btn-secondary{background:#84fab0;color:#fff}
.btn-danger{background:#ff6b6b;color:#fff}
button.active{background-image:linear-gradient(to top,#30cfd0,#330867);color:#fff}
.accordion-header{font-weight:600;display:flex;justify-content:space-between;cursor:pointer}
.accordion-content{display:none;margin-top:10px}
.exercise{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px dashed #ddd}
.exercise.active{background:#fff3cd;border-radius:10px;padding:6px}
.progress{width:100%;height:10px;background:#eee;border-radius:10px;overflow:hidden;margin:6px 0}
.progress-bar{height:100%;background-image:linear-gradient(to right,#fa709a,#fee140)}
.timers{text-align:center;font-weight:600}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;padding:12px}
.modal-content{background:#fff;border-radius:18px;padding:14px;width:100%;max-height:90vh;overflow:auto}
textarea{width:100%;border-radius:12px;padding:8px}
.rating{display:flex;justify-content:space-between;font-size:12px}

@font-face {
  font-family: "SuperMeatball";
  src: url("SuperMeatball.ttf") format("truetype");
}
@font-face {
  font-family: "JBCursive";
  src: url("JBCursive.otf") format("opentype");
}
</style>
</head>
<body>

<div class="container">
  <h1>ğŸ¥‹ Tai-Jitsu Coach</h1>

  <!-- OBJECTIFS -->
  <div class="card">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      ğŸ¯ Objectifs hebdomadaires <span>â¬‡ï¸</span>
    </div>
    <div class="accordion-content" id="objectifs">Chargementâ€¦</div>
  </div>

  <!-- BANQUE -->
  <div class="card">
    <div class="accordion-header" onclick="toggleAccordion(this)">
      ğŸ“š Banque d'exercices <span>â¬‡ï¸</span>
    </div>
    <div class="accordion-content" id="bank"></div>
  </div>

  <!-- SÃ‰LECTION -->
  <div class="card">
    <h3>ğŸ“ SÃ©ance sÃ©lectionnÃ©e</h3>
    <div id="selection"></div>
    <button class="btn-secondary" onclick="clearSelection()">Vider</button>
  </div>

  <!-- SESSION -->
  <div class="card">
    <h3>â±ï¸ SÃ©ance</h3>
    <div class="progress"><div class="progress-bar" id="globalProgress"></div></div>
    <div class="timers" id="timers">00:00 | 00:00</div>
    <button class="btn-primary" id="startBtn" onclick="startSession()">Commencer</button>
    <button class="btn-secondary" id="pauseBtn" onclick="pauseResume()">Pause</button>
    <button class="btn-danger" onclick="stopSession()">Stop</button>
  </div>

  <!-- CARNET D'ENTRAINEMENT -->
  <div class="card">
  <div class="accordion-header" onclick="toggleAccordion(this)">
    ğŸ“ Carnet dâ€™entraÃ®nement <span>â¬‡ï¸</span>
  </div>
  <div class="accordion-content" id="journalContent" style="padding:10px;">
    <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
      <label>Choisir la date :
        <input type="date" id="journalDate">
      </label>
      <button class="btn-primary" onclick="loadJournal()">Afficher</button>
      <button class="btn-secondary" onclick="generateJournalPDF()">ğŸ“„ PDF</button>
    </div>
    <div id="journalDetails" style="font-family:Arial;"></div>
    <canvas id="journalChart" style="display:none; margin-top:10px;"></canvas>
  </div>
</div>

  <!-- MOYENNES / GRAPHIQUES -->
  <div class="card">
    <h3>ğŸ“Š Moyennes et graphiques</h3>

    <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px; flex-wrap: wrap;">
      <label>Du <input type="date" id="fromDateChart"></label>
      <label>Au <input type="date" id="toDateChart"></label>

      <button class="btn-primary" onclick="showAverageByExercise()">Moyenne par exercice</button>
      <button class="btn-secondary" onclick="showAverageByCriteria()">Moyenne par critÃ¨re</button>
      <button class="btn-secondary" onclick="showRadarByUV()">ğŸ§­ Radar par UV</button>
      <button class="btn-secondary" onclick="compareUVRadar()">ğŸ§­ Comparer plusieurs UV</button>
      <button class="btn-secondary" onclick="showUVEvolution()">ğŸ“ˆ Ã‰volution dâ€™une UV</button>
      <button class="btn-danger" onclick="hideExerciseChart()">âŒ Replier</button>
    </div>

    <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px; flex-wrap: wrap;">
      <select id="exerciseRadarSelect"></select>
      <button class="btn-secondary" onclick="showRadarByExercise()">ğŸ“¡ Radar par exercice</button>
    </div>

    <canvas id="exerciseChart" style="display:none"></canvas>
  </div>

</div> <!-- Fin container -->

<!-- Ã‰VALUATION -->
<div class="modal" id="evaluationModal">
  <div class="modal-content">
    <h2>ğŸ“ Auto-Ã©valuation</h2>

    <p style="font-size:14px;margin-bottom:6px">
      <strong>Quel est ton ressenti aprÃ¨s cette sÃ©ance ?</strong><br>
      Bilan gÃ©nÃ©ral, points Ã  amÃ©liorer, ce qui a progressÃ©, sensationsâ€¦
    </p>

    <textarea id="notes" rows="4"></textarea>

    <div id="evaluation"></div>

    <button class="btn-primary" onclick="saveEvaluation()">Valider</button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const GOOGLE_API_URL = "https://script.google.com/macros/s/AKfycbx0j_0ec2NhHcNYv8KwPUPM6yV8yG_xXm3A0F03WR5R2mnDtSm1mfzqOA19R4g-sRVikw/exec";

/* ================= DONNÃ‰ES ================= */
const EXERCISES = [
 {name:'UV1 : Kihon simples',criteria:['prÃ©cision','kime','posture']},
 {name:'UV1 : EnchaÃ®nements',criteria:['prÃ©cision','kime','posture']},
 {name:'UV1 : Cibles',criteria:['prÃ©cision','kime','posture']},
 {name:'UV2 : TaÃ¯ sabaki',criteria:['fluiditÃ©','distance','contrÃ´le']},
 {name:'UV2 : Ippon kumite lent',criteria:['fluiditÃ©','distance','contrÃ´le']},
 {name:'UV2 : Ippon kumite examen',criteria:['fluiditÃ©','distance','contrÃ´le']},
 {name:'UV3 : Kata lent',criteria:['exactitude','kime','Ã©quilibre']},
 {name:'UV3 : Kata examen',criteria:['exactitude','kime','Ã©quilibre']},
 {name:'UV3 : BunkaÃ¯',criteria:['exactitude','kime','Ã©quilibre']},
 {name:'UV4 : Technique de base',criteria:['rÃ©alisme','zanchin','protection']},
 {name:'UV5-6 : Self-defense arme',criteria:['rÃ©alisme','zanchin','protection']},
 {name:'UV5-6 : Self-defense atemi',criteria:['rÃ©alisme','zanchin','protection']},
 {name:'UV5-6 : Self-defense saisie',criteria:['rÃ©alisme','zanchin','protection']}
];

/* ================= OBJECTIFS ================= */
async function fetchObjectivesFromSheet(){
  const r = await fetch(GOOGLE_API_URL + "?action=fetchObjectives");
  const data = await r.json();
  const div = document.getElementById("objectifs");
  div.innerHTML = "";

  data.forEach(o => {
    const pct = o.ObjectifHebdo
      ? Math.round((o.RÃ©alisÃ© / o.ObjectifHebdo) * 100)
      : 0;

    div.innerHTML += `
      <strong>${o.Exercice}</strong>
      <div class="progress">
        <div class="progress-bar" style="width:${pct}%"></div>
      </div>
      <small>${o.RÃ©alisÃ©}/${o.ObjectifHebdo} min (${pct}%)</small>
    `;
  });
}

/* ================= BANQUE ================= */
function renderBank(){
  const bank = document.getElementById("bank");
  bank.innerHTML = "";
  EXERCISES.forEach(e=>{
    bank.innerHTML += `
      <div class="exercise">
        <span>${e.name}</span>
        <button onclick="addExercise('${e.name}')">â•</button>
      </div>
    `;
  });
}

/* ================= STATS ================= */
let chart = null;

async function showAverageByExercise(){
  const r = await fetch(GOOGLE_API_URL + "?action=fetchEvaluations");
  const data = await r.json();

  const sum = {}, count = {};
  data.forEach(ev => {
    const crit = JSON.parse(ev.CritÃ¨res);
    const avg = Object.values(crit).reduce((a,b)=>a+b,0) / Object.keys(crit).length;
    sum[ev.Exercice] = (sum[ev.Exercice] || 0) + avg;
    count[ev.Exercice] = (count[ev.Exercice] || 0) + 1;
  });

  const labels = Object.keys(sum);
  const values = labels.map(l => (sum[l]/count[l]).toFixed(2));

  drawChart(labels, values, "Moyenne par exercice");
}

function drawChart(labels, data, title){
  const canvas = document.getElementById("exerciseChart");
  canvas.style.display = "block";
  if(chart) chart.destroy();

  chart = new Chart(canvas, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: title,
        data,
        backgroundColor: "#84fab0"
      }]
    },
    options: {
      scales: { y: { min: 0, max: 5 } }
    }
  });
}

/* ================= CARNET ================= */
let journalChart = null;

async function loadJournal(){
  const date = document.getElementById("journalDate").value;
  const r = await fetch(GOOGLE_API_URL + "?action=fetchEvaluations");
  const data = await r.json();
  const daily = data.filter(ev => ev.Date.startsWith(date));

  const container = document.getElementById("journalDetails");
  container.innerHTML = "";

  if(!daily.length){
    container.innerHTML = "<em>Aucune donnÃ©e</em>";
    return;
  }

  // DurÃ©es
  const dur = {};
  daily.forEach(ev=>{
    dur[ev.Exercice] = (dur[ev.Exercice] || 0) + (ev.DurÃ©e || 0);
  });

  container.innerHTML += "<strong>DurÃ©es :</strong><br>";
  Object.entries(dur).forEach(([k,v])=>{
    container.innerHTML += `${k} : ${v} min<br>`;
  });

  // Notes
  daily.forEach(ev=>{
    if(ev.Notes){
      container.innerHTML += `
        <p style="font-family:JBCursive">${ev.Notes}</p>
      `;
    }
  });
}

/* ================= INIT ================= */
window.addEventListener("DOMContentLoaded", () => {
  renderBank();
  fetchObjectivesFromSheet();
});
</script>


</body>
</html>
