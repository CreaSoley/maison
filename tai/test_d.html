<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Coach Tai Jitsu ‚Äì 2e Dan</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: system-ui;
  background: linear-gradient(to right,#ffecd2,#fcb69f);
  margin:0;
}
h1 { text-align:center; }

.container { max-width:900px; margin:auto; padding:1rem; }

.exercise {
  background:white;
  margin:.4rem 0;
  padding:.6rem;
  border-radius:15px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
  cursor:grab;
}
.exercise.done { text-decoration: line-through; opacity:.6; }
.exercise.current { background:#ffe0f0; }

.controls button {
  padding:.6rem 1.2rem;
  margin:.2rem;
  border:none;
  border-radius:20px;
}

.status, .panel {
  background:white;
  border-radius:20px;
  padding:1rem;
  margin-top:1rem;
}

.slider { width:120px; }

.emoji button {
  font-size:1.6rem;
  margin:.1rem;
  opacity:.3;
}
.emoji button.active { opacity:1; }

.fullscreen {
  position:fixed;
  inset:0;
  background:#000;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:2.5rem;
  z-index:999;
}
</style>
</head>

<body>
<h1>ü•ã Coach Tai Jitsu ‚Äì Passage 2e Dan</h1>
<div class="container">

<h3>üìã Banque d‚Äôexercices</h3>
<div id="bank"></div>

<h3>üß© S√©lection de s√©ance</h3>
<div id="list"></div>
<button onclick="validateSelection()">‚úÖ Valider la s√©lection</button>

<div class="controls">
  <button onclick="start()">‚ñ∂Ô∏è</button>
  <button onclick="pause()">‚è∏</button>
  <button onclick="stop()">‚èπ</button>
  <button onclick="toggleFull()">‚õ∂ Plein √©cran</button>
</div>

<div class="status">
  <div id="current">En attente‚Ä¶</div>
</div>

<div class="panel">
  <h3>üìù Carnet de notes</h3>
  <textarea id="note" rows="3" placeholder="Ressenti du jour..."></textarea>
</div>

<div class="panel">
  <h3>üòÄ √âvaluation par UV</h3>
  <div id="ratings"></div>
</div>

<div class="panel">
  <h3>üéØ Objectifs hebdomadaires (minutes)</h3>
  <div id="goals"></div>
</div>

<div class="panel">
  <h3>üìä Total hebdomadaire (minutes)</h3>
  <div id="weekly"></div>
</div>
</div>

<div class="panel">
  <h3>üìÖ Historique journalier / hebdomadaire</h3>
  <select id="historyMode" onchange="renderHistory()">
    <option value="day">Par jour</option>
    <option value="week">Par semaine</option>
  </select>
  <div id="history"></div>
</div>
</div>

</div>

<div id="fs" class="fullscreen" style="display:none"></div>

<audio id="beep" src="beep.mp3"></audio>
<audio id="ding" src="ding.mp3"></audio>

<script>
const today = new Date().toISOString().slice(0,10);
const weekKey = new Date().getFullYear() + '-W' + getWeek();

const uvCriteria = {
  'UV1':['Kime üí•','Zanshin üëÄ'],
  'UV2':['Maai üìè','R√©activit√© ‚ö°'],
  'UV3':['Fluidit√© üåä','Pr√©cision üéØ'],
  'UV4':['Puissance üî•','Contr√¥le üß†'],
  'UV5':['Engagement ü•ã','Lucidit√© üëÅÔ∏è'],
  'UV6':['Adaptation üîÑ','Endurance ü´Å']
};

const bank = [
  {uv:'UV1', name:'Kihon simple'},
  {uv:'UV1', name:'Encha√Ænement de kihon'},
  {uv:'UV1', name:'Cibles'},
  {uv:'UV2', name:'Ta√Ø sabaki'},
  {uv:'UV2', name:'Slow ippon'},
  {uv:'UV2', name:'Ippon kumite'},
  {uv:'UV3', name:'Slow kata'},
  {uv:'UV3', name:'Kata nidan'},
  {uv:'UV3', name:'Bunka√Ø'},
  {uv:'UV4', name:'Shadow'},
  {uv:'UV5', name:'Shadow randori'},
  {uv:'UV6', name:'Randori libre'}
];

let selection = JSON.parse(localStorage.getItem('selection')) || [];
let sequence = [];

let done = [];
let currentIndex = 0;
let remaining = 0;
let timer = null;
let running = false;

function render(){
  renderBank();
  renderSelection();
}

function renderBank(){
  const b=document.getElementById('bank');
  b.innerHTML='';
  bank.forEach(ex=>{
    const d=document.createElement('div');
    d.className='exercise';
    d.innerHTML=`${ex.uv} ‚Äì ${ex.name} <button>‚ûï</button>`;
    d.querySelector('button').onclick=()=>{
      selection.push({...ex});
      localStorage.setItem('selection',JSON.stringify(selection));
      render();
    };
    b.appendChild(d);
  });
}

function renderSelection(){
  const list=document.getElementById('list');
  list.innerHTML='';
  selection.forEach((ex,i)=>{
    const d=document.createElement('div');
    d.className='exercise';
    d.innerHTML=`
      <span>${ex.uv} ‚Äì ${ex.name}</span>
      <div>
        <button onclick="moveUp(${i})">‚¨ÜÔ∏è</button>
        <button onclick="moveDown(${i})">‚¨áÔ∏è</button>
        <button onclick="removeSel(${i})">‚ùå</button>
      </div>`;
    list.appendChild(d);
  });
}
){
  const list = document.getElementById('list');
  list.innerHTML='';

  sequence.forEach((ex,i)=>{
    const div = document.createElement('div');
    div.className='exercise';
    if(done.includes(i)) div.classList.add('done');
    if(i===currentIndex && running) div.classList.add('current');
    div.draggable=true;
    div.dataset.index=i;

    div.innerHTML=`
      <span>‚ò∞ ${ex.uv} ‚Äì ${ex.name}</span>
      <input class="slider" type="range" min="1" max="60" value="${ex.duration}">
      <span>${ex.duration} min</span>`;

    const slider = div.querySelector('input');
    slider.oninput=()=>{
      ex.duration=+slider.value;
      div.querySelector('span:last-child').textContent=slider.value+' min';
      persist();
    };

    div.addEventListener('dragstart',e=>{
      e.dataTransfer.effectAllowed='move';
      e.dataTransfer.setData('text/plain', i);
    });
    div.addEventListener('dragover',e=>{
      e.preventDefault();
      e.dataTransfer.dropEffect='move';
    });
    div.addEventListener('drop',e=>{
      e.preventDefault();
      const from = Number(e.dataTransfer.getData('text/plain'));
      if (from === i) return;
      const moved = sequence.splice(from,1)[0];
      sequence.splice(i,0,moved);
      persist();
      render();
    });
    });

    list.appendChild(div);
  });
}
render();

function speak(t){ const u=new SpeechSynthesisUtterance(t); u.lang='fr-FR'; speechSynthesis.speak(u); }

function start(){ if(running) return; running=true; if(remaining===0) run(); else runTimer(); }

function run(){
  if(currentIndex>=sequence.length){ speak('Fin de s√©ance'); stop(); return; }
  const ex=sequence[currentIndex];
  remaining=ex.duration*60;
  speak(ex.name);
  document.getElementById('beep').play();
  runTimer();
}

function runTimer(){
  timer=setInterval(()=>{
    remaining--;
    const ex=sequence[currentIndex];
    document.getElementById('current').textContent=`${ex.name} ‚Äì ${Math.floor(remaining/60)}:${String(remaining%60).padStart(2,'0')}`;
    document.getElementById('fs').textContent=document.getElementById('current').textContent;
    if(remaining<=0){
      clearInterval(timer);
      document.getElementById('ding').play();
      logTime(ex);
      done.push(currentIndex);
      currentIndex++; run();
    }
    render();
  },1000);
}

function pause(){ clearInterval(timer); running=false; }
function stop(){ clearInterval(timer); running=false; remaining=0; currentIndex=0; done=[]; render(); }

function renderRatings(){
  const r=document.getElementById('ratings');
  r.innerHTML='';
  const store=JSON.parse(localStorage.getItem('ratings-'+today))||{};

  sequence.forEach(ex=>{
    if(!uvCriteria[ex.uv]) return;
    const box=document.createElement('div');
    box.innerHTML=`<strong>${ex.uv}</strong><br>`;

    uvCriteria[ex.uv].forEach(c=>{
      const row=document.createElement('div');
      row.className='emoji';
      row.textContent=c+' ';
      for(let i=1;i<=5;i++){
        const b=document.createElement('button');
        b.textContent = ['üòê','üôÇ','üòÄ','üòÉ','ü§©'][i-1];
        if(store[ex.uv]?.[c]===i) b.classList.add('active');
        b.onclick=()=>{
          store[ex.uv]=store[ex.uv]||{};
          store[ex.uv][c]=i;
          localStorage.setItem('ratings-'+today,JSON.stringify(store));
          renderRatings();
        };
        row.appendChild(b);
      }
      }
      box.appendChild(row);
    });
    r.appendChild(box);
  });
}
renderRatings();

const note=document.getElementById('note');
note.value=localStorage.getItem('note-'+today)||'';
note.onblur=()=>localStorage.setItem('note-'+today,note.value);

function logTime(ex){
  const w=JSON.parse(localStorage.getItem('week-'+weekKey))||{};
  w[ex.name]=(w[ex.name]||0)+ex.duration;
  localStorage.setItem('week-'+weekKey,JSON.stringify(w));
  renderGoals();
renderWeekly();
renderHistory();
}

function renderGoals(){
  const g=document.getElementById('goals');
  const store=JSON.parse(localStorage.getItem('goals'))||{};
  g.innerHTML='';
  Object.keys(uvCriteria).forEach(uv=>{
    const v=store[uv]||60;
    g.innerHTML+=`${uv} : <input type="number" value="${v}" min="0" style="width:60px"> min<br>`;
  });
  [...g.querySelectorAll('input')].forEach((inp,i)=>{
    inp.onchange=()=>{
      store[Object.keys(uvCriteria)[i]] = +inp.value;
      localStorage.setItem('goals',JSON.stringify(store));
    };
  });
}

function renderWeekly(){
  const w=JSON.parse(localStorage.getItem('week-'+weekKey))||{};
  const d=document.getElementById('weekly');
  d.innerHTML='';
  Object.entries(w).forEach(([k,v])=>d.innerHTML+=`${k} : ${v} min<br>`);
}
renderWeekly();

function renderHistory(){
  const mode=document.getElementById('historyMode').value;
  const h=document.getElementById('history');
  h.innerHTML='';

  if(mode==='day'){
    Object.keys(localStorage).filter(k=>k.startsWith('week-')===false && k.startsWith('ratings-')===false && k.startsWith('note-')).forEach(k=>{});
    Object.keys(localStorage).filter(k=>k.startsWith('week-')).forEach(()=>{});

    Object.keys(localStorage).filter(k=>k.startsWith('note-')).forEach(k=>{
      const d=k.replace('note-','');
      h.innerHTML+=`<strong>${d}</strong><br>${localStorage.getItem(k)||''}<br><br>`;
    });
  }

  if(mode==='week'){
    Object.keys(localStorage).filter(k=>k.startsWith('week-')).forEach(k=>{
      const data=JSON.parse(localStorage.getItem(k));
      h.innerHTML+=`<strong>${k.replace('week-','')}</strong><br>`;
      Object.entries(data).forEach(([ex,v])=>h.innerHTML+=`${ex} : ${v} min<br>`);
      h.innerHTML+='<br>';
    });
  }
}

function validateSelection(){
  sequence = selection.map(ex=>({...ex, duration:5}));
  localStorage.setItem('sequence',JSON.stringify(sequence));
  selection = [];
  localStorage.removeItem('selection');
  render();
  alert('S√©lection valid√©e. R√©glez maintenant les dur√©es.');
}

function moveUp(i){ if(i===0) return; [selection[i-1],selection[i]]=[selection[i],selection[i-1]]; persistSel(); }
function moveDown(i){ if(i===selection.length-1) return; [selection[i+1],selection[i]]=[selection[i],selection[i+1]]; persistSel(); }
function removeSel(i){ selection.splice(i,1); persistSel(); }
function persistSel(){ localStorage.setItem('selection',JSON.stringify(selection)); render(); }

function persist(){ localStorage.setItem('sequence',JSON.stringify(sequence)); }

function toggleFull(){
  const f=document.getElementById('fs');
  f.style.display = f.style.display==='none' ? 'flex' : 'none';
}

function getWeek(){
  const d=new Date(); d.setHours(0,0,0,0);
  d.setDate(d.getDate()+4-(d.getDay()||7));
  const y=new Date(d.getFullYear(),0,1);
  return Math.ceil((((d-y)/86400000)+1)/7);
}
</script>
</body>
</html>
