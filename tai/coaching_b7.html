<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coach Tai Jitsu</title>

<style>
body{
  font-family:system-ui,sans-serif;
  margin:0;
  background:#f2f2f2;
}
h1,h2,h3{margin:.5rem 0}
.container{
  max-width:1100px;
  margin:auto;
  padding:1rem;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:1rem;
}
.panel{
  background:#fff;
  border-radius:12px;
  padding:1rem;
  box-shadow:0 4px 12px rgba(0,0,0,.1);
}
.exercise{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:.4rem .6rem;
  margin:.3rem 0;
  background:#eee;
  border-radius:8px;
}
.exercise.selected{background:#d1f5d3}
.exercise.active{background:#ffe7b3}
.exercise.done{opacity:.5;text-decoration:line-through}
button{
  border:none;
  border-radius:8px;
  padding:.3rem .6rem;
  cursor:pointer;
}
input[type=range]{width:100px}
progress{width:100%;height:16px}

#overlay{
  display:none;
  position:fixed;
  inset:0;
  background:#000;
  color:#fff;
  z-index:999;
  flex-direction:column;
  justify-content:center;
  align-items:center;
}
#overlay h1{font-size:2.5rem}
#overlay #timer{font-size:4rem;margin:1rem 0}
#overlay progress{width:80%;height:24px}

#modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  z-index:1000;
  justify-content:center;
  align-items:center;
}
#modal .box{
  background:#fff;
  color:#000;
  border-radius:12px;
  padding:1rem;
  max-width:600px;
  width:100%;
  max-height:80vh;
  overflow:auto;
}
</style>
</head>

<body>

<h1 style="text-align:center">ü•ã Coach Tai Jitsu</h1>

<div class="container">

<!-- BANQUE -->
<div class="panel">
  <h2>üìö Banque d'exercices</h2>
  <div id="bank"></div>
</div>

<!-- S√âLECTION -->
<div class="panel">
  <h2>üìù S√©ance</h2>
  <input id="sessionName" placeholder="Nom de la s√©ance" style="width:100%;padding:.4rem">
  <div id="selection"></div>

  <textarea id="notes" placeholder="Carnet de notes..." style="width:100%;margin-top:.5rem"></textarea>

  <div style="margin-top:.5rem;display:flex;gap:.4rem;flex-wrap:wrap">
    <button onclick="startSession()">‚ñ∂Ô∏è D√©marrer</button>
    <button onclick="toggleFullscreen()">üì± Plein √©cran</button>
    <button onclick="clearSelection()">üßπ Vider</button>
    <button onclick="showHistory()">üìä Historique</button>
  </div>

  <progress id="progress" value="0" max="100"></progress>
</div>

</div>

<!-- OVERLAY EXERCICE -->
<div id="overlay">
  <h1 id="overlayName"></h1>
  <div id="timer">00:00</div>
  <progress id="overlayProgress" value="0" max="100"></progress>
  <button onclick="toggleFullscreen()" style="margin-top:1rem">‚ùå Quitter</button>
</div>

<!-- MODAL HISTORIQUE -->
<div id="modal">
  <div class="box">
    <h2>üìä Historique</h2>
    <div id="historyContent"></div>
    <button onclick="closeModal()">Fermer</button>
  </div>
</div>

<audio id="beep" src="beep.mp3"></audio>
<audio id="ding" src="ding.mp3"></audio>

<script>
/* ================== DONN√âES ================== */
const bankData=[
 {uv:'UV1 ‚Äì Kihon',items:['Kihon simple','Encha√Ænement','Cibles']},
 {uv:'UV2 ‚Äì D√©placements',items:['Tai sabaki','Slow ippon','Ippon kumite']},
 {uv:'UV3 ‚Äì Kata',items:['Slow kata','Kata nidan','Bunka√Ø']},
 {uv:'UV4 ‚Äì Technique',items:['Shadow']},
 {uv:'UV5-6 ‚Äì Randori',items:['Randori shadow']}
];

let selection=JSON.parse(localStorage.getItem('tj-selection'))||[];

/* sessions NORMALIS√â */
let rawSessions=JSON.parse(localStorage.getItem('tj-sessions'))||[];
let sessions=Array.isArray(rawSessions)?rawSessions:Object.values(rawSessions);

let index=0,timer=null,fullscreen=false;

/* ================== RENDER ================== */
function renderBank(){
 const b=document.getElementById('bank');
 b.innerHTML='';
 bankData.forEach(u=>{
  const d=document.createElement('div');
  d.innerHTML=`<h3>${u.uv}</h3>`;
  u.items.forEach(n=>{
   d.innerHTML+=`
    <div class="exercise">
      <span>${n}</span>
      <button onclick="addExercise('${u.uv}','${n}')">‚ûï</button>
    </div>`;
  });
  b.appendChild(d);
 });
}

function renderSelection(){
 const s=document.getElementById('selection');
 s.innerHTML='';
 if(!selection.length){s.innerHTML='<em>Aucun exercice</em>';return;}
 selection.forEach((e,i)=>{
  s.innerHTML+=`
   <div class="exercise selected">
    ${e.uv} ‚Äì ${e.name}
    <div>
     <input type="range" min="1" max="60" value="${e.duration}"
       oninput="updateDuration(${i},this.value)">
     ${e.duration}min
     <button onclick="moveUp(${i})">‚¨ÜÔ∏è</button>
     <button onclick="moveDown(${i})">‚¨áÔ∏è</button>
     <button onclick="removeExercise(${i})">‚ùå</button>
    </div>
   </div>`;
 });
}

/* ================== ACTIONS ================== */
function addExercise(uv,name){
 selection.push({uv,name,duration:5});
 saveSelection();
}
function updateDuration(i,v){selection[i].duration=+v;saveSelection();}
function moveUp(i){
 if(i>0){[selection[i-1],selection[i]]=[selection[i],selection[i-1]];saveSelection();}
}
function moveDown(i){
 if(i<selection.length-1){[selection[i+1],selection[i]]=[selection[i],selection[i+1]];saveSelection();}
}
function removeExercise(i){selection.splice(i,1);saveSelection();}
function clearSelection(){if(confirm('Vider ?')){selection=[];saveSelection();}}
function saveSelection(){
 localStorage.setItem('tj-selection',JSON.stringify(selection));
 renderSelection();
}

/* ================== VOIX ================== */
function speak(txt,cb){
 const u=new SpeechSynthesisUtterance(txt);
 u.lang='fr-FR';
 u.onend=cb;
 speechSynthesis.speak(u);
}
function format(t){return String(Math.floor(t/60)).padStart(2,'0')+":"+String(t%60).padStart(2,'0');}

/* ================== ENTRA√éNEMENT ================== */
function startSession(){
 if(!selection.length)return alert('Aucun exercice');
 index=0;
 const name=sessionName.value||'S√©ance '+new Date().toLocaleString();
 sessions.push({name,date:new Date().toLocaleString(),exercises:JSON.parse(JSON.stringify(selection)),notes:notes.value});
 localStorage.setItem('tj-sessions',JSON.stringify(sessions));
 speak("Commen√ßons l'entra√Ænement",nextExercise);
}

function nextExercise(){
 if(index>=selection.length){
  speak("Entra√Ænement termin√©, √† bient√¥t !");
  document.getElementById('progress').value=100;
  return;
 }
 const ex=selection[index];
 overlayName.textContent=ex.name;
 updateState();
 speak(`Exercice ${index+1} : ${ex.name}`,()=>{
  setTimeout(()=>{
   beep.play();
   let t=ex.duration*60;
   timerEl=setInterval(()=>{
    t--;
    timer.textContent=format(t);
    overlayProgress.value=((index+(ex.duration*60-t)/(ex.duration*60))/selection.length)*100;
    progress.value=overlayProgress.value;
    if(t<=0){
     clearInterval(timerEl);
     ding.play();
     speak("Fin de l'exercice",()=>{
      index++;
      nextExercise();
     });
    }
   },1000);
  },2000);
 });
}

function updateState(){
 document.querySelectorAll('#selection .exercise').forEach((e,i)=>{
  e.classList.toggle('active',i===index);
  e.classList.toggle('done',i<index);
 });
}

/* ================== UI ================== */
function toggleFullscreen(){
 fullscreen=!fullscreen;
 overlay.style.display=fullscreen?'flex':'none';
}
function showHistory(){
 let html='';
 sessions.forEach(s=>{
  html+=`<strong>${s.name}</strong> (${s.date})<br>`;
  s.exercises.forEach(e=>html+=`- ${e.name} (${e.duration}min)<br>`);
  html+=`Notes: ${s.notes||''}<hr>`;
 });
 historyContent.innerHTML=html||'Aucune s√©ance';
 modal.style.display='flex';
}
function closeModal(){modal.style.display='none';}

/* ================== INIT ================== */
renderBank();
renderSelection();
</script>

</body>
</html>
