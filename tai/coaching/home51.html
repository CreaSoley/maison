<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ü•ã Kihon Trainer üå∏</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&display=swap" rel="stylesheet">

<style>
:root{
  --radius:22px;
  --shadow:0 12px 25px rgba(255,120,180,.25);
}

/* ===== BASE ===== */
body{
  margin:0;
  font-family:'Fredoka',sans-serif;
  background:linear-gradient(180deg,#fff6fb,#ffeef6);
  display:flex;
  justify-content:center;
  padding:20px;
}
main{max-width:980px;width:100%}

.card{
  background:white;
  border-radius:var(--radius);
  padding:22px;
  box-shadow:var(--shadow);
  display:flex;
  flex-direction:column;
  gap:16px;
}

h1{
  text-align:center;
  color:#ff1493;
  margin-bottom:5px;
}

/* ===== FORM CONTROLS ===== */
.controls{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:10px;
}

select,input{
  padding:10px;
  border-radius:14px;
  border:2px solid #ffd6ec;
  font-family:'Fredoka';
}

/* ===== BUTTON BAR ===== */
.button-bar{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
  margin-top:10px;
}

.btn{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:10px;
  padding:14px;
  font-size:.95rem;
  font-weight:600;
  border:none;
  border-radius:16px;
  color:white;
  cursor:pointer;
  box-shadow:0 10px 20px rgba(255,120,180,.35);
  transition:.2s;
}

.btn:hover{transform:translateY(-2px)}
.btn.active{animation:pulse 1.6s infinite}

@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(255,255,255,.6)}
  70%{box-shadow:0 0 0 16px rgba(255,255,255,0)}
  100%{box-shadow:0 0 0 0 rgba(255,255,255,0)}
}

/* ===== BUTTON COLORS ===== */
.btn-train{background:linear-gradient(135deg,#5f2c82,#9f5fff)}
.btn-pause{background:linear-gradient(135deg,#6a3093,#a044ff)}
.btn-stop{background:linear-gradient(135deg,#8e2de2,#ff416c)}
.btn-present{background:linear-gradient(to top,#ff0844,#ffb199)}
.btn-exam{background:linear-gradient(135deg,#ff7a18,#ffb347)}
.btn-reset{background:linear-gradient(135deg,#f83600,#f9d423)}

.hidden{display:none}

/* ===== VISUAL CARD ===== */
#visual{
  position:relative;
  min-height:200px;
  border-radius:20px;
  padding:20px;
  color:white;
  font-size:1.25rem;
  display:flex;
  flex-direction:column;
  justify-content:center;
  text-align:center;
  box-shadow:0 8px 20px rgba(0,0,0,.15);
}

#countdown{
  position:absolute;
  top:12px;
  right:12px;
  font-size:1.8rem;
  background:rgba(255,255,255,.25);
  padding:6px 14px;
  border-radius:16px;
}

/* ===== SHORT TEXTS ===== */
#shortText{
  margin-top:8px;
  font-size:1rem;
  text-align:center;
  color:#333;
}

/* ===== BACKGROUNDS ===== */
.bg-3pas{background:linear-gradient(to top,#30cfd0,#330867)}
.bg-surplace{background:linear-gradient(to top,#888,#444)}
.bg-multi{background:linear-gradient(to top,#f43b47,#453a94)}
.bg-cibles{background-image: linear-gradient(to right, #6a11cb 0%, #2575fc 100%)}

/* ===== RECAP ===== */
#recap{
  margin-top:18px;
  padding:16px;
  border-radius:18px;
  background-image:linear-gradient(15deg,#13547a 0%,#80d0c7 100%);
  color:white;
  box-shadow:var(--shadow);
}

#recap h3{margin-top:0}

.recap-block{
  background-image:linear-gradient(-225deg,#FFFEFF 0%,#D7FFFE 100%);
  color:#444;
  border-radius:14px;
  padding:10px;
  margin:8px 0;
}

.recap-block button{
  width:100%;
  padding:8px;
  border:none;
  border-radius:12px;
  background:#ffffffaa;
  font-family:'Fredoka';
  cursor:pointer;
}
  /* ===== MODAL ===== */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;            /* üî¥ IMPORTANT */
  align-items:center;
  justify-content:center;
  z-index:999;
}

.modal.show{
  display:flex;            /* üî¥ ouverture contr√¥l√©e */
}

.modal-content{
  background:linear-gradient(135deg,#ff9a9e,#fad0c4);
  border-radius:22px;
  padding:22px;
  max-width:420px;
  width:90%;
  box-shadow:0 20px 40px rgba(0,0,0,.3);
  text-align:center;
}

.modal-content h2{
  margin-top:0;
}

.modal-content ul{
  text-align:left;
  padding-left:18px;

}
.hidden{display:none}

  /* ===== GAMMES DISPLAY ===== */
.gamme-romaji {
  font-size: 1.4rem;
  font-weight: 700;
  margin-bottom: 8px;
}

.gamme-fr {
  font-size: 1rem;
  font-style: italic;
  opacity: 0.95;
}

</style>
</head>

<body>
<main>
<div class="card">

<h1>ü•ã Kihon Trainer üå∏</h1>

<!-- ===== MODES ===== -->
<div class="controls">
  <select id="mode">
    <option value="1">üé≤ Exercice 1 ‚Äì Al√©atoire global</option>
    <option value="2">üéØ Exercice 2 ‚Äì Par cat√©gorie</option>
    <option value="3">üìÇ Exercice 3 ‚Äì Cat√©gorie choisie</option>
    <option value="4">üéº Exercice 4 ‚Äì Gammes</option>
    <option value="exam">üìù Mode examen blanc</option>
  </select>

  <select id="categorie">
    <option value="3pas">3 pas</option>
    <option value="surplace">Sur place</option>
    <option value="multi">Multidirectionnel</option>
    <option value="cibles">Cibles</option>
  </select>

  <input type="number" id="count" min="1" value="3">
  <input type="range" id="interval" min="30" max="240" value="60">
  <span id="intervalVal">1m 00s</span>
  <div id="shortText"></div>
</div>

  <label>
  Rythme :
  <select id="speedMode">
    <option value="slow">Lent</option>
    <option value="fast">Rapide</option>
  </select>
</label>

<!-- ===== BUTTONS ===== -->
<div class="button-bar">
  <button id="start" class="btn btn-train">‚ñ∂Ô∏è Lancer l‚Äôentra√Ænement</button>
  <button id="pause" class="btn btn-pause">‚è∏ Pause</button>
  <button id="stop" class="btn btn-stop">‚èπ Stop</button>
  <button id="criteria" class="btn btn-present">üìã Crit√®res d‚Äô√©valuation</button>
  <button id="presentationExam" class="btn btn-present hidden">üì¢ Pr√©sentation examen</button>
  <button id="startExam" class="btn btn-exam hidden">üìù Lancer l‚Äôexamen</button>
  <button id="reset" class="btn btn-reset">üîÑ R√©initialiser</button>
</div>

<!-- ===== VISUAL ===== -->
<div id="visual" class="bg-3pas">
  <div id="text">Pr√™t üå∏</div>
  <div id="countdown"></div>
</div>

<!-- ===== RECAP ===== -->
<div id="recap" class="hidden"></div>

  <!-- ===== MODAL CRIT√àRES D‚Äô√âVALUATION ===== -->
<div id="criteriaModal" class="modal">
  <div class="modal-content">
    <h2>üìã Crit√®res d‚Äô√©valuation</h2>
    <ul>
      <li>Posture stable et √©quilibr√©e</li>
      <li>Trajectoires correctes</li>
      <li>Pr√©cision et intention</li>
      <li>Coordination</li>
      <li>Respiration</li>
    </ul>
    <button id="closeCriteria" class="btn btn-reset">‚ùå Fermer</button>
  </div>
</div>

</main>

<script>
/* ===== DATA ===== */
let DATA = {};
let GAMMES = [];


const CATEGORY_MAP = {
  "3pas": "Sur trois pas",
  "surplace": "Sur place",
  "multi": "Multidirectionnel",
  "cibles": "Cibles"
};

const BG_MAP = {
  "3pas":"bg-3pas",
  "surplace":"bg-surplace",
  "multi":"bg-multi",
  "cibles":"bg-cibles"
};
function normalizeCat(cat){
  if(cat === "Sur trois pas") return "3pas";
  if(cat === "Sur place") return "surplace";
  if(cat === "Multidirectionnel") return "multi";
  if(cat === "Cibles") return "cibles";
  return cat;
}

async function loadData(){
  const res = await fetch("enchainements.json");
  DATA = await res.json();
}
loadData();

  async function loadGammes(){
  const res = await fetch("gammes.json");
  GAMMES = await res.json();
}

/* ===================== ELEMENTS ===================== */
const mode = document.getElementById("mode");
const categorie = document.getElementById("categorie");
const countInput = document.getElementById("count");
const intervalInput = document.getElementById("interval");
const intervalVal = document.getElementById("intervalVal");
const shortText = document.getElementById("shortText");

const startBtn = document.getElementById("start");
const pauseBtn = document.getElementById("pause");
const stopBtn = document.getElementById("stop");
const resetBtn = document.getElementById("reset");
const presentationBtn = document.getElementById("presentationExam");
const startExamBtn = document.getElementById("startExam");

const visual = document.getElementById("visual");
const text = document.getElementById("text");
const countdown = document.getElementById("countdown");
const recap = document.getElementById("recap");

  /* ===================== FENETRE CRITERE ===================== */
const criteriaBtn = document.getElementById("criteria");
const criteriaModal = document.getElementById("criteriaModal");
const closeCriteria = document.getElementById("closeCriteria");

/* s√©curit√© */
if(criteriaBtn && criteriaModal && closeCriteria){

  criteriaBtn.addEventListener("click", () => {
    criteriaModal.classList.add("show");
  });

  closeCriteria.addEventListener("click", () => {
    criteriaModal.classList.remove("show");
  });

}
/* ===================== √âTAT ===================== */
let sequence = [];
let index = 0;
let timer = null;
let paused = false;
let stopped = false;
let examMode = false;
let workedSeconds = 0;
let examRecapData = [];
let trainingRecapData = [];

window.onload = async () => {
  await loadData();
  await loadGammes();
};

/* ===================== UTILS ===================== */
const wait = ms => new Promise(res => setTimeout(res, ms));

function speak(text, rate = 1, lang = "fr-FR") {
  return new Promise(res => {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang;
    u.rate = rate;
    u.onend = res;
    speechSynthesis.speak(u);
  });
}

/* ===== SPEAK JAPONAIS ===== */
function speakJP(text, rate = 0.7) {
  const clean = text.replace(/\s+/g, "");
  return speak(clean, rate, "ja-JP");
}

const fmt=s=>`${Math.floor(s/60)}m ${String(s%60).padStart(2,"0")}s`;

function setActive(btn){
  document.querySelectorAll(".btn").forEach(b=>b.classList.remove("active"));
  if(btn) btn.classList.add("active");
}

intervalInput.oninput = () => { intervalVal.textContent = fmt(+intervalInput.value); };

/* ===================== PICK RANDOM ===================== */
function pickRandom(cat, n = 1){
  const label = CATEGORY_MAP[cat];
  const list = DATA[label] || [];

  if (!list.length) return n === 1 ? null : [];

  const shuffled = [...list].sort(() => Math.random() - 0.5);
  return n === 1 ? shuffled[0] : shuffled.slice(0, n);
}

/* ===================== PR√âSENTATION EXAMEN ===================== */
presentationBtn.onclick = async () => {
  speechSynthesis.cancel();
  await speak(
    "Vous avez choisi le mode examen blanc. La s√©ance comporte quatre parties. " +
    "Premi√®re partie : encha√Ænement sur trois pas. Effectuez l‚Äôencha√Ænement annonc√© sur trois pas, avec soit un demi-tour au terme de l‚Äôaller, soit en reculant ensuite. Vous disposez de quarante cinq secondes par encha√Ænement. " +
    "Deuxi√®me partie : encha√Ænement sur place. Sur place en position de combat, effectuez l‚Äôencha√Ænement annonc√©. Le changement de garde sera annonc√©. Vous disposez de trente secondes par c√¥t√©. " +
    "Troisi√®me partie : encha√Ænement multidirectionnel. Vous allez travailler sur un encha√Ænement de techniques qui doit √™tre ex√©cut√© dans les quatre directions cardinales, en garde gauche puis en garde droite, avec retour √† la position initiale. Le changement de garde sera annonc√©. Vous disposez de quarante-cinq secondes par c√¥t√©. " +
    "Quatri√®me partie : travail sur cibles. Cinq techniques vont √™tes annonc√©es. Vous les r√©aliserez 3 fois chacune, garde de votre choix, avec retour √† la position initiale apr√®s chaque ex√©cution. Vous disposez de trente secondes par techniques" +
    "La pause est autoris√©e.", 0.7
  );
};

/* ===================== BUILD EXAM ===================== */
function buildExam(){
  const seq = [];
  examRecapData.length = 0;

  // Partie 1 ‚Äî 3 pas
  const p1 = pickRandom("3pas", 3);
  examRecapData.push({
  title: "Partie 1 ‚Äì Encha√Ænements sur 3 pas",
  time: 135,
  items: p1.map(x => ({
    catLabel: "Sur trois pas",
    display: x.display
  }))
});

  p1.forEach((ex,i)=>seq.push({
    cat:"3pas", display:ex.display, spoken:ex.spoken, time:45,
    announce:i===0?"Premi√®re partie : encha√Ænements sur trois pas":null
  }));

// Partie 2 ‚Äî Sur place
const p2 = pickRandom("surplace", 1);
const ex2Id = crypto.randomUUID();

examRecapData.push({
  title: "Partie 2 ‚Äì Encha√Ænements sur place",
  time: 60,
  items: [{
    catLabel: "Sur place",
    display: p2.display
  }]
});

seq.push({
  examGroup: ex2Id,
  cat: "surplace",
  display: p2.display,
  spoken: p2.spoken,
  garde: "gauche",
  time: 30,
  announce: "Deuxi√®me partie : encha√Ænements sur place"
});

seq.push({
  examGroup: ex2Id,
  cat: "surplace",
  display: p2.display,
  spoken: p2.spoken,
  garde: "droite",
  time: 30
});


// Partie 3 ‚Äî Multidirectionnel
const p3 = pickRandom("multi", 1);
const ex3Id = crypto.randomUUID();

examRecapData.push({
  title: "Partie 3 ‚Äì Multidirectionnel",
  time: 90,
  items: [{
    catLabel: "Multidirectionnel",
    display: p3.display
  }]
});

seq.push({
  examGroup: ex3Id,
  cat: "multi",
  display: p3.display,
  spoken: p3.spoken,
  garde: "gauche",
  time: 45,
  announce: "Troisi√®me partie : multidirectionnel"
});

seq.push({
  examGroup: ex3Id,
  cat: "multi",
  display: p3.display,
  spoken: p3.spoken,
  garde: "droite",
  time: 45
});


  // Partie 4 ‚Äî Cibles (5 encha√Ænements)
const p4 = pickRandom("cibles", 5);

examRecapData.push({
  title: "Partie 4 ‚Äì Travail sur cibles",
  time: 150,
  items: p4.map(x => ({
    catLabel: "Cibles",
    display: x.display
  }))
});
  
p4.forEach((ex, i) => {
  seq.push({
    cat: "cibles",
    display: ex.display,
    spoken: ex.spoken,
    time: 30,
    announce: i === 0 ? "Quatri√®me partie : travail sur cibles" : null
  });
});


  return seq;
}
/* ===================== RUNGAMMES ===================== */
async function runGammes(list) {
const speedMode = list[0].speed || "slow";
const COUNT_DELAY = speedMode === "fast" ? 1000 : 2000;
const COUNT_SECONDS = COUNT_DELAY / 1000;


  // S√©curit√©
  if (!Array.isArray(list) || !list.length) return;

  /* ===== INTRO COMMUNE ===== */
await speak("Pr√©parez-vous", 1);
await wait(5000);

  let totalSeconds = 0;

  /* ===== RITUEL DE D√âBUT ===== */
  for (const word of ["Re√Ø", "Yo√Ø", "Kama√©"]) {
    await speak(word, 0.65);
    await wait(1000);
    totalSeconds += 1;
  }

  /* ===== BOUCLE SUR LES KIHON ===== */
  for (const g of list) {

    // Affichage visuel

    text.innerHTML = `
  <div class="gamme-romaji">${g.romaji}</div>
  <div class="gamme-fr">${g.fr}</div>
`;

    /* ----- ANNONCE DU KIHON ----- */
   await speakJP(g.katakana, 0.50); // japonais
    await speak(g.fr, 1);           // fran√ßais x1
   

    /* ----- COMPTAGE + MAWATE ----- */
    const countJP = ["Ichi", "Ni", "San", "Shi", "Go"];

     /* ----- PASSAGE ALLER + RETOUR ----- */
   for (let round = 0; round < 2; round++) {

  for (const n of countJP) {
    await speak(n, 0.7);
    await wait(COUNT_DELAY);
    totalSeconds += COUNT_SECONDS;
  }

  await speak("Mawat√©", 0.65);
  await wait(COUNT_DELAY);
  totalSeconds += COUNT_SECONDS;
}

  }

  /* ===== RITUEL DE FIN ===== */
  for (const word of ["Yam√©", "Yassm√©"]) {
    await speak(word, 0.65);
    await wait(1000);
    totalSeconds += 1;
  }

  await speak("Fin de l'entra√Ænement", 1);

  /* ===== R√âCAP GAMMES ===== */
  trainingRecapData = [{
    title: "Entra√Ænement libre ‚Äì Gammes",
    time: totalSeconds,
    items: list.map(g => ({
      catLabel: "Gamme",
      display: `${g.romaji} ‚Äì ${g.fr}`
    }))
  }];

  showRecap();
}

  
/* ===================== RUN ===================== */
async function run() {
  
  // ===== EXERCICE 4 ‚Äì GAMMES =====
  if (!examMode && sequence[0]?.exercise === "4") {
    await runGammes(sequence);
    return;
  }

  /* ===== LATENCE DE D√âMARRAGE (5s) ===== */
  if (index === 0 && !run._started) {
    run._started = true;

    await speak("Pr√©parez-vous", 0.9);

    let prep = 5;
    countdown.textContent = "5s";

    await new Promise(resolve => {
      const prepTimer = setInterval(() => {
        prep--;
        countdown.textContent = prep + "s";
        if (prep <= 0) {
          clearInterval(prepTimer);
          resolve();
        }
      }, 1000);
    });
  }

  if (stopped) return;

  /* ===== FIN ===== */
  if (index >= sequence.length) {

  await speak(examMode ? "Fin de l'examen" : "Fin de l'entra√Ænement", 1);

  if (!examMode) {
    trainingRecapData = [{
  title: "Entra√Ænement libre",
  time: workedSeconds,
  items: sequence.map(e => ({
    catLabel: CATEGORY_MAP[normalizeCat(e.cat)],
    display: e.display
  }))
}];

  }

  showRecap();
  return;
}
  const ex = sequence[index];

  /* ===== AFFICHAGE ===== */
  text.textContent = ex.display;

  /* ===== BACKGROUND ===== */
  const normCat = normalizeCat(ex.cat);
  if (BG_MAP[normCat]) {
    visual.className = BG_MAP[normCat];
  }

  /* =======================================================
     üîä ANNONCES
     ======================================================= */
/* ===== ANNONCE CAT√âGORIE (ENTRA√éNEMENT LIBRE ‚Äì EX 1 & 2) ===== */
if (!examMode && (ex.exercise === "1" || ex.exercise === "2")) {
  const normCat = normalizeCat(ex.cat);
  await speak(CATEGORY_MAP[normCat], 0.8);
}

  /* ===== ANNONCE PARTIE (EXAMEN SEULEMENT) ===== */
  if (examMode && ex.announce) {
    await speak(ex.announce, 0.7);
  }

  /* ===== ANNONCE CAT√âGORIE (ENTRA√éNEMENT LIBRE SEULEMENT) ===== */


if (examMode) {

  // Cas mutualis√© (exercices 2 & 3)
  if (ex.examGroup) {
    run._spokenGroups ??= new Set();

    if (!run._spokenGroups.has(ex.examGroup)) {
      run._spokenGroups.add(ex.examGroup);
      await speak(ex.spoken || ex.display, 0.7);
      await speak(ex.spoken || ex.display, 0.7);
    }
  }

  // Cas normal (parties 1 et 4)
  else {
    await speak(ex.spoken || ex.display, 0.7);
    await speak(ex.spoken || ex.display, 0.7);
  }

} else {
  // Entra√Ænement libre (comportement inchang√©)
  if (!ex._spokenOnce) {
    ex._spokenOnce = true;
    await speak(ex.spoken || ex.display, 0.7);
    await speak(ex.spoken || ex.display, 0.7);
  }
}


  /* ===== GARDE ===== */
  if (ex.garde) {
    await speak("Garde √† " + ex.garde, 1);
  }

  /* ===== D√âMARRAGE ===== */
  await speak("Hajim√©", 1);

  /* =======================================================
     ‚è± TIMER
     ======================================================= */

  let t = ex.time;
  countdown.textContent = fmt(t);

  clearInterval(timer);
  timer = setInterval(() => {
    if (paused || stopped) return;

    t--;
     workedSeconds++;   // üëà AJOUT ICI
    countdown.textContent = fmt(t);
    
    if (t <= 0) {
      clearInterval(timer);
      index++;
      run();
    }
  }, 1000);
}
/* ===================== BUILDR√âCAPGAMMES ===================== */
function buildGammesRecap(list){
  trainingRecapData = [{
    title: "Entra√Ænement libre ‚Äì Gammes",
    time: list.length * 40, // approx
    items: list.map(g => ({
      catLabel: "Gamme",
      display: `${g.romaji} ‚Äì ${g.fr}`
    }))
  }];
}

/* ===================== R√âCAP ===================== */
function showRecap(){
  recap.innerHTML = "<h3>üìÑ R√©capitulatif</h3>";
  const source = examMode ? examRecapData : trainingRecapData;
  source.forEach(r=>{
    recap.innerHTML += `
      <div class="recap-block">
        <strong>${r.title}</strong><br>
        <em>Dur√©e : ${fmt(r.time)}</em>
        <ul>
${r.items.map(i => `
  <li>
    <strong>${i.catLabel}</strong> : ${i.display}
  </li>
`).join("")}
</ul>

      </div>`;
  });
  recap.classList.remove("hidden");
}

/* ===================== EVENTS ===================== */

/* ===== LANCER MODE EXAMEN ===== */
startExamBtn.onclick = async () => {
  examMode = true;
  stopped = false;
  paused = false;
  workedSeconds = 0;
  index = 0;

  recap.classList.add("hidden");
  setActive(startExamBtn);

  sequence = buildExam();
  run._started = false;

  await run();
};

/* ===== LANCER ENTRA√éNEMENT LIBRE ===== */
startBtn.onclick = async () => {
  examMode = false;
  stopped = false;
  paused = false;
  workedSeconds = 0;
  index = 0;
  sequence = [];

  recap.classList.add("hidden");
  setActive(startBtn);

  const m = mode.value;
  const cat = categorie.value;
  const qty = +countInput.value;
  const t = +intervalInput.value;

  // S√©curit√© : donn√©es charg√©es ?
  if (!DATA || Object.keys(DATA).length === 0) {
    alert("Les donn√©es ne sont pas encore charg√©es.");
    return;
  }

  /* ===== EXERCICE 1 ‚Äì AL√âATOIRE GLOBAL ===== */
  if (m === "1") {
    Object.entries(DATA).forEach(([key, list]) => {
      list.forEach(item => {
        sequence.push({
  exercise: "1",
  cat: key,
  display: item.display,
  spoken: item.spoken,
  time: t
});

      });
    });

    sequence = sequence.sort(() => Math.random() - 0.5).slice(0, qty);
  }

  /* ===== EXERCICE 2 ‚Äì UNE PAR CAT√âGORIE ===== */
  if (m === "2") {
Object.entries(DATA).forEach(([key, list]) => {
  const item = list[Math.floor(Math.random() * list.length)];
  sequence.push({
  exercise: "2",
  cat: key,
  display: item.display,
  spoken: item.spoken,
  time: t
});

});

  }

/* ===== EXERCICE 3 ‚Äì CAT√âGORIE CHOISIE ===== */
if (m === "3") {
  const realCat = CATEGORY_MAP[cat];

  if (!DATA[realCat]) {
    alert("Cat√©gorie inexistante.");
    return;
  }

  sequence = [...DATA[realCat]]
    .sort(() => Math.random() - 0.5)
    .slice(0, qty)
    .map(item => ({
      cat: cat,
      display: item.display,
      spoken: item.spoken,
      time: t
    }));
}
 /* ===== EXERCICE 4 ‚Äì GAMMES ===== */

if (m === "4") {

  const speed = document.getElementById("speedMode").value;

  sequence = [...GAMMES]
    .sort(() => Math.random() - 0.5)
    .slice(0, qty)
    .map(g => ({
      exercise: "4",
      katakana: g.jp_katakana,
      romaji: g.jp_romaji,
      fr: g.fr,
      speed   // ‚¨ÖÔ∏è STOCK√â ICI
    }));
}
  
run._started = false;

  await run();
};

/* ===== PAUSE ===== */
pauseBtn.onclick = () => {
  paused = !paused;
  pauseBtn.textContent = paused ? "‚ñ∂Ô∏è Reprendre" : "‚è∏ Pause";
  setActive(paused ? pauseBtn : null);
};

/* ===== STOP ===== */
stopBtn.onclick = () => {
  stopped = true;
  paused = false;

  clearInterval(timer);
  speechSynthesis.cancel();

  text.textContent = "S√©ance arr√™t√©e";
  countdown.textContent = "";

  setActive(stopBtn);
};
mode.dispatchEvent(new Event("change"));

/* ===== RESET ===== */
resetBtn.onclick = () => {
  stopped = true;
  paused = false;

  clearInterval(timer);
  speechSynthesis.cancel();

  index = 0;
  sequence = [];

  text.textContent = "Pr√™t üå∏";
  countdown.textContent = "";
  recap.innerHTML = "";
  recap.classList.add("hidden");

  setActive(null);
};
  const EXERCISE_TEXTS = {
  "1": "Exercice 1 : travail sur un ensemble de techniques choisies al√©atoirement.",
  "2": "Exercice 2 : travail al√©atoire sur trois techniques : trois pas, sur place et multidirectionnel.",
  "3": "Exercice 3 : travail sur la cat√©gorie de votre choix."
};

const CATEGORY_TEXTS = {
  "3pas": "Sur trois pas : effectuez l‚Äôencha√Ænement annonc√© sur trois pas, avec demi-tour ou recul.",
  "surplace": "Sur place : en position de combat, effectuez l‚Äôencha√Ænement annonc√©.",
  "multi": "Multidirectionnel : travaillez dans les quatre directions cardinales, garde gauche puis droite.",
  "cibles": "Cibles : effectuez la technique annonc√©e avec la garde de votre choix."
};

const EXPLANATIONS = {
  "1": "Exercice 1 : travail sur un ensemble de techniques choisies al√©atoirement.",
  "2": "Exercice 2 : travail al√©atoire sur trois types d‚Äôencha√Ænements.",
  "3": "Exercice 3 : travail sur une cat√©gorie choisie.",
  "4": "Exercice 4 ‚Äì Gammes : exercice destin√© √† perfectionner les kihon de base. Choisissez le nombre de techniques √† travailler et le rythme.",
  "exam": "Mode examen blanc : conditions proches de l‚Äôexamen officiel."
};

mode.onchange = () => {
  const exam = mode.value === "exam";

  /* ===== BOUTONS MODE EXAMEN ===== */
  presentationBtn.classList.toggle("hidden", !exam);
  startExamBtn.classList.toggle("hidden", !exam);
  startBtn.classList.toggle("hidden", exam);

  /* ===== D√âSACTIVATION DES CHAMPS ===== */
  categorie.disabled = exam;
  countInput.disabled = exam;
  intervalInput.disabled = exam;

  /* ===== TEXTE COURT ===== */
  shortText.textContent = EXPLANATIONS[mode.value] || "";
};

mode.addEventListener("change", () => {
  if (mode.value === "2") {
    categorie.disabled = true;
  } else if (mode.value !== "exam") {
    categorie.disabled = false;
  }
});

</script>

</body>
</html>
