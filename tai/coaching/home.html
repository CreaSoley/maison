<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ğŸ¥‹ Kihon Trainer ğŸŒ¸</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&display=swap" rel="stylesheet">

<style>
:root{
  --pink:#ff5fc1;
  --hot-pink:#ff1493;
  --purple:#8a2be2;
  --green:#4caf50;
  --blue:#2196f3;
  --yellow:#ffeb3b;
  --bg:linear-gradient(180deg,#fff6fb,#ffeef6);
  --radius:22px;
  --shadow:0 12px 25px rgba(255,120,180,.25);
}
body{
  margin:0;
  font-family:'Fredoka',sans-serif;
  background:var(--bg);
  display:flex;
  justify-content:center;
  padding:20px;
}
main{max-width:900px;width:100%}
.card{
  background:white;
  border-radius:var(--radius);
  padding:20px;
  box-shadow:var(--shadow);
  display:flex;
  flex-direction:column;
  gap:15px;
}
h1{text-align:center;color:var(--hot-pink)}
.controls{display:grid;gap:10px}
select,button,input{
  padding:10px;
  border-radius:12px;
  border:2px solid #ffd6ec;
  font-family:'Fredoka';
}
button{color:white;cursor:pointer;transition:0.2s;}
button.start{background:var(--pink)}
button.stop{background:#ff4d6d}
button.pause{background:#999}
button.reset{background:var(--purple)}
button.examBtn{background:var(--green);margin:3px;padding:5px 10px;border:none;border-radius:12px;cursor:pointer;}
.range-wrap{display:flex;gap:10px;align-items:center}
#visual{
  margin-top:10px;
  border-radius:20px;
  padding:20px;
  min-height:180px;
  color:white;
  text-align:center;
  font-size:1.3rem;
  display:flex;
  flex-direction:column;
  justify-content:center;
  position:relative;
  box-shadow:0 8px 20px rgba(0,0,0,.15);
}
#countdown{
  font-size:2rem;
  font-weight:bold;
  background:rgba(255,255,255,0.3);
  border-radius:15px;
  padding:5px 15px;
  position:absolute;
  top:10px;
  right:10px;
  color:#fff;
}
.bg-3pas{background:linear-gradient(to top,#30cfd0,#330867)}
.bg-surplace{background:linear-gradient(to top,#888,#444)}
.bg-multi{background:linear-gradient(to top,#f43b47,#453a94)}
#recap{
  margin-top:20px;
  background:#fff;
  padding:15px;
  border-radius:15px;
  box-shadow:var(--shadow);
}
#recap ul{list-style:none;padding-left:0;}
#recap li{margin:5px 0;}
</style>
</head>

<body>
<main>
<div class="card">
<h1>ğŸ¥‹ Kihon Trainer ğŸŒ¸</h1>

<div class="controls">
<select id="mode">
  <option value="1">ğŸ² Exercice 1 â€“ AlÃ©atoire global</option>
  <option value="2">ğŸ¯ Exercice 2 â€“ Par catÃ©gorie</option>
  <option value="3">ğŸ“‚ Exercice 3 â€“ CatÃ©gorie choisie</option>
  <option value="exam">ğŸ“ Mode examen blanc</option>
</select>

<select id="categorie">
  <option value="3pas">3 pas</option>
  <option value="surplace">Sur place</option>
  <option value="multi">Multidirectionnel</option>
</select>

<input type="number" id="count" min="1" value="3" style="width:80px">
<input type="range" id="interval" min="30" max="240" value="60">
<span id="intervalVal">60s</span>

<div id="examControls" class="hidden">
  <button id="presentation" class="start">ğŸ“¢ PrÃ©sentation de l'examen</button>
  <button id="startExam" class="start">â–¶ DÃ©marrer l'examen</button>
</div>

<button id="start" class="start">â–¶ Lancer</button>
<button id="pause" class="pause">â¸ Pause</button>
<button id="stop" class="stop">â¹ Stop</button>
<button id="reset" class="reset">ğŸ”„ RÃ©initialiser</button>
</div>

<div id="visual">
  <div id="text">PrÃªt ğŸŒ¸</div>
  <div id="countdown"></div>
</div>

<div id="recap"></div>
</div>
</main>

<script>
const DATA={
"3pas":[
"Avancer en Soto Uke en Zenkutsu Dachi, Gyaku Tsuki Chudan, Mae Geri",
"Avancer en Shuto Uke Kokutsu Dachi, Nukite Chudan",
"Reculer Gedan Barai en Zenkutsu Dachi, Oi Tsuki, Mae Geri",
"Avancer Mae Geri, poser Age Uke suivi de Gyaku Tsuki",
"Kiba Dachi Uraken Uchi, dÃ©placement jambe avant Gyaku Tsuki",
"Avancer sur 3 pas en Zenkutsu Dachi, Jodan Age Uke, HaÃ¯to Uchi, Tate Empi Uchi",
"Uchi Uke Zenkutsu Dachi, Yoko Geri repose Kiba Dachi, Yoko Empi Uchi"
],
"surplace":[
"Sur place : Mae Geri jambe arriÃ¨re, Kizami Tsuki, Gyaku Tsuki",
"Sur place : sursaut arriÃ¨re Soto Uke, Gyaku Tsuki, Mae Geri",
"Sur place : sursaut arriÃ¨re Jodan Age Uke, Gyaku Tsuki, Mae Geri",
"Sur place : sursaut Mae Geri jambe avant, Oi Tsuki, Gyaku Tsuki"
],
"multi":[
"Multidirectionnel : Mae Geri Jambe arriÃ¨re, Gyaku Tsuki Chudan",
"Multidirectionnel : Pas chassÃ© Gyaku Tsuki chudan, ressort pas chassÃ©",
"Multidirectionnel : Avancer Mae Geri, poser Age Uke suivi de Gyaku Tsuki"
]};
const BG={"3pas":"bg-3pas","surplace":"bg-surplace","multi":"bg-multi"};

const modeSelect=document.getElementById("mode");
const catSelect=document.getElementById("categorie");
const countInput=document.getElementById("count");
const intervalInput=document.getElementById("interval");
const intervalVal=document.getElementById("intervalVal");

const startBtn=document.getElementById("start");
const pauseBtn=document.getElementById("pause");
const stopBtn=document.getElementById("stop");
const resetBtn=document.getElementById("reset");

const examControls=document.getElementById("examControls");
const presentationBtn=document.getElementById("presentation");
const startExamBtn=document.getElementById("startExam");

const text=document.getElementById("text");
const countdown=document.getElementById("countdown");
const visual=document.getElementById("visual");
const recapDiv=document.getElementById("recap");

let sequence=[], index=0, timer=null;
let paused=false, stopped=false, workedSeconds=0;
let examRecap=[], examMode=false;

/* ===================== UTILS ===================== */
function fmt(sec){const m=Math.floor(sec/60); const s=sec%60; return `${m}m ${s.toString().padStart(2,"0")}s`;}
async function speak(txt,rate=1){return new Promise(res=>{const u=new SpeechSynthesisUtterance(txt); u.lang="fr-FR"; u.rate=rate; u.onend=res; speechSynthesis.speak(u);});}

intervalInput.oninput=()=>{intervalVal.textContent=fmt(Number(intervalInput.value));};

modeSelect.onchange=()=>{
  examMode = modeSelect.value==="exam";
  examControls.classList.toggle("hidden",!examMode);
  startBtn.classList.toggle("hidden",examMode);
  catSelect.disabled = examMode;
  countInput.disabled = examMode;
  intervalInput.disabled = examMode;
};

/* ===================== PRESENTATION ===================== */
presentationBtn.onclick=async()=>{
  speechSynthesis.cancel();
  await speak("Vous avez choisi le mode examen blanc. La sÃ©ance comporte trois parties. PremiÃ¨re partie : enchaÃ®nement sur trois pas. Trois fois en avanÃ§ant puis trois fois en reculant. DeuxiÃ¨me partie : enchaÃ®nement sur place. Le changement de garde sera annoncÃ©. TroisiÃ¨me partie : enchaÃ®nement multidirectionnel. Le changement de garde sera annoncÃ©. La pause est autorisÃ©e.",0.7);
};

/* ===================== BUILD EXAM ===================== */
function buildExam(){
  examRecap=[]; const seq=[];
  // Partie 1 â€“ 3 pas
  let p1 = [...DATA["3pas"]].sort(()=>Math.random()-.5).slice(0,3);
  examRecap.push({title:"Partie 1 â€“ 3 pas", items:p1});
  p1.forEach(t=>seq.push({cat:"3pas",text:t,time:60}));

  // Partie 2 â€“ Sur place
  let p2 = DATA["surplace"].sort(()=>Math.random()-.5)[0]; 
  examRecap.push({title:"Partie 2 â€“ Sur place", items:[p2]});
  seq.push({cat:"surplace",text:p2,time:30,garde:"gauche"});
  seq.push({cat:"surplace",text:"",time:30,garde:"droite"}); // pas le nom rÃ©pÃ©tÃ©

  // Partie 3 â€“ Multidirectionnel
  let p3 = DATA["multi"].sort(()=>Math.random()-.5)[0]; 
  examRecap.push({title:"Partie 3 â€“ Multidirectionnel", items:[p3]});
  seq.push({cat:"multi",text:p3,time:45,garde:"gauche"});
  seq.push({cat:"multi",text:"",time:45,garde:"droite"}); // pas le nom rÃ©pÃ©tÃ©
  return seq;
}

/* ===================== RUN SEQUENCE ===================== */
async function run(){
  if(stopped) return;
  if(index>=sequence.length){
    if(examMode) await speak("Fin de l'examen",1);
    renderRecap();
    return;
  }

  const ex=sequence[index];
  visual.className=BG[ex.cat];
  text.textContent = ex.text || `Garde Ã  ${ex.garde}`;

  if(ex.partAnnounce) await speak(ex.partAnnounce,0.7);
  if(ex.garde) await speak("Garde Ã  "+ex.garde,1);
  if(ex.text) await speak(ex.text,0.7);
  if(ex.text) await speak(ex.text,0.7);
  await speak("HajimÃ©",1);

  let t=ex.time;
  countdown.textContent=fmt(t);
  timer=setInterval(async()=>{
    if(paused || stopped) return;
    t--; workedSeconds++;
    countdown.textContent=fmt(t);
    if(t<=0){
      clearInterval(timer);
      if(!examMode) await speak("Fin de l'exercice",1);
      index++; run();
    }
  },1000);
}

/* ===================== RECAP ===================== */
function renderRecap(){
  recapDiv.innerHTML="<h3>ğŸ“„ RÃ©capitulatif</h3>";
  examRecap.forEach(p=>{
    recapDiv.innerHTML+=`<strong>${p.title}</strong><ul>`+
      p.items.map(i=>`<li><button class="examBtn" onclick="speak('${i}',0.7)">${i} (${fmt(30)})</button></li>`).join("")+
      "</ul>";
  });
}

/* ===================== EVENTS ===================== */
startExamBtn.onclick=()=>{
  stopped=false; paused=false; index=0; workedSeconds=0;
  sequence=buildExam();
  if(sequence[0]) sequence[0].partAnnounce="PremiÃ¨re partie : enchaÃ®nement sur trois pas";
  if(sequence[2]) sequence[2].partAnnounce="DeuxiÃ¨me partie : enchaÃ®nement sur place";
  if(sequence[4]) sequence[4].partAnnounce="TroisiÃ¨me partie : multidirectionnel";
  run();
};

startBtn.onclick=()=>{
  stopped=false; paused=false; index=0; workedSeconds=0;
  sequence=[];
  const mode = modeSelect.value;
  const cat = catSelect.value;
  const qty = Number(countInput.value);

  if(mode==="1"){
    let all=[]; Object.entries(DATA).forEach(([c,l])=>l.forEach(t=>all.push({cat:c,text:t,time:Number(intervalInput.value)})));
    // suppression doublons
    all = [...new Set(all.map(a=>JSON.stringify(a)))].map(a=>JSON.parse(a));
    sequence=all.sort(()=>Math.random()-.5).slice(0,qty);
  }
  if(mode==="2"){
    Object.entries(DATA).forEach(([c,l])=>{
      const t = l[Math.floor(Math.random()*l.length)];
      if(!sequence.find(e=>e.text===t)) sequence.push({cat:c,text:t,time:Number(intervalInput.value)});
    });
  }
  if(mode==="3"){
    sequence=DATA[cat].slice().sort(()=>Math.random()-.5).slice(0,qty).map(t=>({cat:cat,text:t,time:Number(intervalInput.value)}));
  }
  setTimeout(()=>{if(!stopped) run();},5000);
};

pauseBtn.onclick=()=>{
  paused=!paused;
  pauseBtn.textContent = paused?"â–¶ Reprendre":"â¸ Pause";
};
stopBtn.onclick=()=>{
  stopped=true; clearInterval(timer); speechSynthesis.cancel();
  text.textContent="SÃ©ance arrÃªtÃ©e"; countdown.textContent="";
};
resetBtn.onclick=()=>{
  stopped=true; paused=false; clearInterval(timer); speechSynthesis.cancel();
  text.textContent="PrÃªt ğŸŒ¸"; countdown.textContent=""; recapDiv.innerHTML="";
};
</script>
</body>
</html>
