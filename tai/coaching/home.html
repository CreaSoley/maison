<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ğŸ¥‹ Kihon Trainer ğŸŒ¸</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&display=swap" rel="stylesheet">

<style>
:root{
  --radius:22px;
  --shadow:0 12px 25px rgba(255,120,180,.25);
}

/* ===== BASE ===== */
body{
  margin:0;
  font-family:'Fredoka',sans-serif;
  background:linear-gradient(180deg,#fff6fb,#ffeef6);
  display:flex;
  justify-content:center;
  padding:20px;
}
main{max-width:980px;width:100%}

.card{
  background:white;
  border-radius:var(--radius);
  padding:22px;
  box-shadow:var(--shadow);
  display:flex;
  flex-direction:column;
  gap:16px;
}

h1{
  text-align:center;
  color:#ff1493;
  margin-bottom:5px;
}

/* ===== FORM CONTROLS ===== */
.controls{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:10px;
}

select,input{
  padding:10px;
  border-radius:14px;
  border:2px solid #ffd6ec;
  font-family:'Fredoka';
}

/* ===== BUTTON BAR ===== */
.button-bar{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
  margin-top:10px;
}

.btn{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:10px;
  padding:14px;
  font-size:.95rem;
  font-weight:600;
  border:none;
  border-radius:16px;
  color:white;
  cursor:pointer;
  box-shadow:0 10px 20px rgba(255,120,180,.35);
  transition:.2s;
}

.btn:hover{transform:translateY(-2px)}
.btn.active{animation:pulse 1.6s infinite}

@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(255,255,255,.6)}
  70%{box-shadow:0 0 0 16px rgba(255,255,255,0)}
  100%{box-shadow:0 0 0 0 rgba(255,255,255,0)}
}

/* ===== BUTTON COLORS ===== */
.btn-train{background:linear-gradient(135deg,#5f2c82,#9f5fff)}
.btn-pause{background:linear-gradient(135deg,#6a3093,#a044ff)}
.btn-stop{background:linear-gradient(135deg,#8e2de2,#ff416c)}
.btn-present{background:linear-gradient(to top,#ff0844,#ffb199)}
.btn-exam{background:linear-gradient(135deg,#ff7a18,#ffb347)}
.btn-reset{background:linear-gradient(135deg,#f83600,#f9d423)}

.hidden{display:none}

/* ===== VISUAL CARD ===== */
#visual{
  position:relative;
  min-height:200px;
  border-radius:20px;
  padding:20px;
  color:white;
  font-size:1.25rem;
  display:flex;
  flex-direction:column;
  justify-content:center;
  text-align:center;
  box-shadow:0 8px 20px rgba(0,0,0,.15);
}

#countdown{
  position:absolute;
  top:12px;
  right:12px;
  font-size:1.8rem;
  background:rgba(255,255,255,.25);
  padding:6px 14px;
  border-radius:16px;
}

/* ===== SHORT TEXTS ===== */
#shortText{
  margin-top:8px;
  font-size:1rem;
  text-align:center;
  color:#333;
}

/* ===== BACKGROUNDS ===== */
.bg-3pas{background:linear-gradient(to top,#30cfd0,#330867)}
.bg-surplace{background:linear-gradient(to top,#888,#444)}
.bg-multi{background:linear-gradient(to top,#f43b47,#453a94)}
.bg-cibles{background-image: linear-gradient(to right, #6a11cb 0%, #2575fc 100%)}

/* ===== RECAP ===== */
#recap{
  margin-top:18px;
  padding:16px;
  border-radius:18px;
  background-image:linear-gradient(15deg,#13547a 0%,#80d0c7 100%);
  color:white;
  box-shadow:var(--shadow);
}

#recap h3{margin-top:0}

.recap-block{
  background-image:linear-gradient(-225deg,#FFFEFF 0%,#D7FFFE 100%);
  color:#444;
  border-radius:14px;
  padding:10px;
  margin:8px 0;
}

.recap-block button{
  width:100%;
  padding:8px;
  border:none;
  border-radius:12px;
  background:#ffffffaa;
  font-family:'Fredoka';
  cursor:pointer;
}
  /* ===== MODAL ===== */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;            /* ğŸ”´ IMPORTANT */
  align-items:center;
  justify-content:center;
  z-index:999;
}

.modal.show{
  display:flex;            /* ğŸ”´ ouverture contrÃ´lÃ©e */
}

.modal-content{
  background:linear-gradient(135deg,#ff9a9e,#fad0c4);
  border-radius:22px;
  padding:22px;
  max-width:420px;
  width:90%;
  box-shadow:0 20px 40px rgba(0,0,0,.3);
  text-align:center;
}

.modal-content h2{
  margin-top:0;
}

.modal-content ul{
  text-align:left;
  padding-left:18px;

}
.hidden{display:none}

</style>
</head>

<body>
<main>
<div class="card">

<h1>ğŸ¥‹ Kihon Trainer ğŸŒ¸</h1>

<!-- ===== MODES ===== -->
<div class="controls">
  <select id="mode">
    <option value="1">ğŸ² Exercice 1 â€“ AlÃ©atoire global</option>
    <option value="2">ğŸ¯ Exercice 2 â€“ Par catÃ©gorie</option>
    <option value="3">ğŸ“‚ Exercice 3 â€“ CatÃ©gorie choisie</option>
    <option value="exam">ğŸ“ Mode examen blanc</option>
  </select>

  <select id="categorie">
    <option value="3pas">3 pas</option>
    <option value="surplace">Sur place</option>
    <option value="multi">Multidirectionnel</option>
    <option value="cibles">Cibles</option>
  </select>

  <input type="number" id="count" min="1" value="3">
  <input type="range" id="interval" min="30" max="240" value="60">
  <span id="intervalVal">1m 00s</span>
  <div id="shortText"></div>
</div>

<!-- ===== BUTTONS ===== -->
<div class="button-bar">
  <button id="start" class="btn btn-train">â–¶ï¸ Lancer lâ€™entraÃ®nement</button>
  <button id="pause" class="btn btn-pause">â¸ Pause</button>
  <button id="stop" class="btn btn-stop">â¹ Stop</button>
  <button id="criteria" class="btn btn-present">ğŸ“‹ CritÃ¨res dâ€™Ã©valuation</button>
  <button id="presentationExam" class="btn btn-present hidden">ğŸ“¢ PrÃ©sentation examen</button>
  <button id="startExam" class="btn btn-exam hidden">ğŸ“ Lancer lâ€™examen</button>
  <button id="reset" class="btn btn-reset">ğŸ”„ RÃ©initialiser</button>
</div>

<!-- ===== VISUAL ===== -->
<div id="visual" class="bg-3pas">
  <div id="text">PrÃªt ğŸŒ¸</div>
  <div id="countdown"></div>
</div>

<!-- ===== RECAP ===== -->
<div id="recap" class="hidden"></div>

  <!-- ===== MODAL CRITÃˆRES Dâ€™Ã‰VALUATION ===== -->
<div id="criteriaModal" class="modal">
  <div class="modal-content">
    <h2>ğŸ“‹ CritÃ¨res dâ€™Ã©valuation</h2>
    <ul>
      <li>Posture stable et Ã©quilibrÃ©e</li>
      <li>Trajectoires correctes</li>
      <li>PrÃ©cision et intention</li>
      <li>Coordination</li>
      <li>Respiration</li>
    </ul>
    <button id="closeCriteria" class="btn btn-reset">âŒ Fermer</button>
  </div>
</div>

</main>

<script>
/* ===================== DATA ===================== */
let DATA = {};

const CATEGORY_MAP = {
  "3pas": "Sur trois pas",
  "surplace": "Sur place",
  "multi": "Multidirectionnel",
  "cibles": "Cibles"
};

const BG_MAP = {
  "3pas": "bg-3pas",
  "surplace": "bg-surplace",
  "multi": "bg-multi",
  "cibles": "bg-cibles"
};

function normalizeCat(cat) {
  if (cat === "Sur trois pas") return "3pas";
  if (cat === "Sur place") return "surplace";
  if (cat === "Multidirectionnel") return "multi";
  if (cat === "Cibles") return "cibles";
  return cat;
}

async function loadData() {
  const res = await fetch("enchainements.json");
  DATA = await res.json();
}
loadData();

/* ===================== ELEMENTS ===================== */
const mode = document.getElementById("mode");
const categorie = document.getElementById("categorie");
const countInput = document.getElementById("count");
const intervalInput = document.getElementById("interval");
const intervalVal = document.getElementById("intervalVal");
const shortText = document.getElementById("shortText");

const startBtn = document.getElementById("start");
const startExamBtn = document.getElementById("startExam");
const presentationBtn = document.getElementById("presentationExam");
const pauseBtn = document.getElementById("pause");
const stopBtn = document.getElementById("stop");
const resetBtn = document.getElementById("reset");

const visual = document.getElementById("visual");
const text = document.getElementById("text");
const countdown = document.getElementById("countdown");
const recap = document.getElementById("recap");
  
 /* ===================== FENETRE CRITERE ===================== */
const criteriaBtn = document.getElementById("criteria");
const criteriaModal = document.getElementById("criteriaModal");
const closeCriteria = document.getElementById("closeCriteria");

/* sÃ©curitÃ© */
if(criteriaBtn && criteriaModal && closeCriteria){

  criteriaBtn.addEventListener("click", () => {
    criteriaModal.classList.add("show");
  });

  closeCriteria.addEventListener("click", () => {
    criteriaModal.classList.remove("show");
  });

}
/* ===================== ETAT ===================== */
let sequence = [];
let index = 0;
let timer = null;
let paused = false;
let stopped = false;
let examMode = false;
let workedSeconds = 0;

let examRecapData = [];
let trainingRecapData = [];

/* ===================== UTILS ===================== */
function speak(t, rate = 1) {
  return new Promise(res => {
    const u = new SpeechSynthesisUtterance(t);
    u.lang = "fr-FR";
    u.rate = rate;
    u.onend = res;
    speechSynthesis.speak(u);
  });
}

const fmt = s => `${Math.floor(s / 60)}m ${String(s % 60).padStart(2, "0")}s`;

intervalInput.oninput = () => {
  intervalVal.textContent = fmt(+intervalInput.value);
};

function pickRandom(cat, n = 1) {
  const list = DATA[cat] || [];
  return [...list].sort(() => Math.random() - 0.5).slice(0, n);
}
/* ===================== PRÃ‰SENTATION EXAMEN ===================== */
presentationBtn.onclick = async () => {
  speechSynthesis.cancel();
  await speak(
    "Vous avez choisi le mode examen blanc. La sÃ©ance comporte quatre parties. " +
    "PremiÃ¨re partie : enchaÃ®nement sur trois pas. Effectuez lâ€™enchaÃ®nement annoncÃ© sur trois pas, avec soit un demi-tour au terme de lâ€™aller, soit en reculant ensuite. Vous disposez de trente secondes par enchaÃ®nement. " +
    "DeuxiÃ¨me partie : enchaÃ®nement sur place. Sur place en position de combat, effectuez lâ€™enchaÃ®nement annoncÃ©. Le changement de garde sera annoncÃ©. Vous disposez de trente secondes par cÃ´tÃ©. " +
    "TroisiÃ¨me partie : enchaÃ®nement multidirectionnel. Vous allez travailler sur un enchaÃ®nement de techniques qui doit Ãªtre exÃ©cutÃ© dans les quatre directions cardinales, en garde gauche puis en garde droite, avec retour Ã  la position initiale. Le changement de garde sera annoncÃ©. Vous disposez de quarante-cinq secondes par cÃ´tÃ©. " +
    "QuatriÃ¨me partie : travail sur cibles. Cinq techniques vont Ãªtes annoncÃ©es. Vous les rÃ©aliserez 3 fois chacune, garde de votre choix, avec retour Ã  la position initiale aprÃ¨s chaque exÃ©cution. Vous disposez de vingt secondes par techniques" +
    "La pause est autorisÃ©e.", 0.7
  );
};

/* ===================== BUILD EXAM ===================== */
function buildExam() {
  const seq = [];
  examRecapData = [];

  /* Partie 1 â€” 3 pas */
  const p1 = pickRandom("3pas", 3);
  examRecapData.push({
    title: "Partie 1 â€“ EnchaÃ®nements sur 3 pas",
    items: p1.map(x => x.display),
    time: 135
  });

  p1.forEach((ex, i) => {
    seq.push({
      cat: "3pas",
      display: ex.display,
      spoken: ex.spoken,
      time: 45,
      announce: i === 0 ? "PremiÃ¨re partie : enchaÃ®nements sur trois pas" : null
    });
  });

  /* Partie 2 â€” Sur place */
  const p2 = pickRandom("surplace", 1)[0];
  examRecapData.push({
    title: "Partie 2 â€“ EnchaÃ®nement sur place",
    items: [p2.display],
    time: 60
  });

  seq.push({
    cat: "surplace",
    display: p2.display,
    spoken: p2.spoken,
    announce: "DeuxiÃ¨me partie : enchaÃ®nement sur place",
    phases: [
      { garde: "gauche", time: 30 },
      { garde: "droite", time: 30 }
    ]
  });

  /* Partie 3 â€” Multidirectionnel */
  const p3 = pickRandom("multi", 1)[0];
  examRecapData.push({
    title: "Partie 3 â€“ Multidirectionnel",
    items: [p3.display],
    time: 90
  });

  seq.push({
    cat: "multi",
    display: p3.display,
    spoken: p3.spoken,
    announce: "TroisiÃ¨me partie : enchaÃ®nement multidirectionnel",
    phases: [
      { garde: "gauche", time: 45 },
      { garde: "droite", time: 45 }
    ]
  });

  /* Partie 4 â€” Cibles */
  const p4 = pickRandom("cibles", Math.min(5, DATA.cibles.length));
  examRecapData.push({
    title: "Partie 4 â€“ Travail sur cibles",
    items: p4.map(x => x.display),
    time: 100
  });

  p4.forEach((ex, i) => {
    seq.push({
      cat: "cibles",
      display: ex.display,
      spoken: ex.spoken,
      time: 20,
      announce: i === 0 ? "QuatriÃ¨me partie : travail sur cibles" : null
    });
  });

  return seq;
}

/* ===================== RUN ===================== */
async function run() {
  if (stopped) return;

  if (index >= sequence.length) {
    await speak(examMode ? "Fin de l'examen" : "Fin de l'entraÃ®nement", 1);

    if (!examMode) {
      trainingRecapData = [{
        title: "EntraÃ®nement libre",
        time: workedSeconds,
        items: sequence.map(e => `${CATEGORY_MAP[e.cat]} â€“ ${e.display}`)
      }];
    }

    showRecap();
    return;
  }

  const ex = sequence[index];

  if (ex.phases && ex._phaseIndex === undefined) {
    ex._phaseIndex = 0;
  }

  text.textContent = ex.display;

  visual.className = BG_MAP[normalizeCat(ex.cat)] || "";

  if (examMode && ex.announce) {
    await speak(ex.announce, 0.7);
  }

  if (!ex._spokenOnce) {
    ex._spokenOnce = true;

    if (!examMode) {
      await speak(CATEGORY_MAP[ex.cat], 0.8);
    }

    await speak(ex.spoken || ex.display, 0.7);
    await speak(ex.spoken || ex.display, 0.7);
  }

  const phase = ex.phases ? ex.phases[ex._phaseIndex] : ex;

  if (phase.garde) {
    await speak("Garde Ã  " + phase.garde, 1);
  }

  await speak("HajimÃ©", 1);

  let t = phase.time;
  countdown.textContent = fmt(t);

  clearInterval(timer);
  timer = setInterval(() => {
    if (paused || stopped) return;

    t--;
    workedSeconds++;
    countdown.textContent = fmt(t);

    if (t <= 0) {
      clearInterval(timer);

      if (ex.phases && ex._phaseIndex < ex.phases.length - 1) {
        ex._phaseIndex++;
        run();
      } else {
        index++;
        run();
      }
    }
  }, 1000);
}

/* ===================== RECAP ===================== */
function showRecap() {
  recap.innerHTML = "<h3>ğŸ“„ RÃ©capitulatif</h3>";
  const source = examMode ? examRecapData : trainingRecapData;

  source.forEach(r => {
    recap.innerHTML += `
      <div class="recap-block">
        <strong>${r.title}</strong><br>
        <em>DurÃ©e : ${fmt(r.time)}</em>
        <ul>${r.items.map(i => `<li>${i}</li>`).join("")}</ul>
      </div>`;
  });

  recap.classList.remove("hidden");
}

/* ===================== EVENTS ===================== */
startExamBtn.onclick = async () => {
  examMode = true;
  stopped = false;
  paused = false;
  index = 0;
  workedSeconds = 0;
  run._lastCat = null;

  recap.classList.add("hidden");
  sequence = buildExam();

  await run();
};

startBtn.onclick = async () => {
  examMode = false;
  stopped = false;
  paused = false;
  index = 0;
  workedSeconds = 0;
  run._lastCat = null;

  recap.classList.add("hidden");
  sequence = [];

  const m = mode.value;
  const cat = categorie.value;
  const qty = +countInput.value;
  const t = +intervalInput.value;

  if (m === "2") {
    Object.keys(DATA).forEach(key => {
      const item = pickRandom(key, 1)[0];
      sequence.push({
        cat: key,
        display: item.display,
        spoken: item.spoken,
        time: t
      });
    });
  }

  if (m === "3") {
    sequence = pickRandom(cat, qty).map(item => ({
      cat,
      display: item.display,
      spoken: item.spoken,
      time: t
    }));
  }

  await run();
};

pauseBtn.onclick = () => {
  paused = !paused;
};

stopBtn.onclick = () => {
  stopped = true;
  clearInterval(timer);
  speechSynthesis.cancel();
};
/* ===== RESET ===== */
resetBtn.onclick = () => {
  stopped = true;
  paused = false;

  clearInterval(timer);
  speechSynthesis.cancel();

  index = 0;
  sequence = [];

  text.textContent = "PrÃªt ğŸŒ¸";
  countdown.textContent = "";
  recap.innerHTML = "";
  recap.classList.add("hidden");

  setActive(null);
};
  const EXERCISE_TEXTS = {
  "1": "Exercice 1 : travail sur un ensemble de techniques choisies alÃ©atoirement.",
  "2": "Exercice 2 : travail alÃ©atoire sur trois techniques : trois pas, sur place et multidirectionnel.",
  "3": "Exercice 3 : travail sur la catÃ©gorie de votre choix."
};

const CATEGORY_TEXTS = {
  "3pas": "Sur trois pas : effectuez lâ€™enchaÃ®nement annoncÃ© sur trois pas, avec demi-tour ou recul.",
  "surplace": "Sur place : en position de combat, effectuez lâ€™enchaÃ®nement annoncÃ©.",
  "multi": "Multidirectionnel : travaillez dans les quatre directions cardinales, garde gauche puis droite.",
  "cibles": "Cibles : effectuez la technique annoncÃ©e avec la garde de votre choix."
};

const EXPLANATIONS = {
  "1": "Exercice 1 : travail sur un ensemble de techniques choisies alÃ©atoirement.",
  "2": "Exercice 2 : travail alÃ©atoire sur trois types dâ€™enchaÃ®nements.",
  "3": "Exercice 3 : travail sur une catÃ©gorie choisie.",
  "exam": "Mode examen blanc : conditions proches de lâ€™examen officiel."
};


/* ===================== MODE ===================== */
mode.onchange = () => {
  const exam = mode.value === "exam";

  presentationBtn.classList.toggle("hidden", !exam);
  startExamBtn.classList.toggle("hidden", !exam);
  startBtn.classList.toggle("hidden", exam);

  categorie.disabled = exam || mode.value === "2";
  countInput.disabled = exam;
  intervalInput.disabled = exam;
};
</script>

</body>
</html>
