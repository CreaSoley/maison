<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ğŸ¥‹ Kihon Trainer ğŸŒ¸</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&display=swap" rel="stylesheet">

<style>
:root{
  --radius:22px;
  --shadow:0 12px 25px rgba(255,120,180,.25);
}

/* ===== BASE ===== */
body{
  margin:0;
  font-family:'Fredoka',sans-serif;
  background:linear-gradient(180deg,#fff6fb,#ffeef6);
  display:flex;
  justify-content:center;
  padding:20px;
}
main{max-width:980px;width:100%}

.card{
  background:white;
  border-radius:var(--radius);
  padding:22px;
  box-shadow:var(--shadow);
  display:flex;
  flex-direction:column;
  gap:16px;
}

h1{
  text-align:center;
  color:#ff1493;
  margin-bottom:5px;
}

/* ===== FORM CONTROLS ===== */
.controls{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:10px;
}

select,input{
  padding:10px;
  border-radius:14px;
  border:2px solid #ffd6ec;
  font-family:'Fredoka';
}

/* ===== BUTTON BAR ===== */
.button-bar{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
  margin-top:10px;
}

.btn{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:10px;
  padding:14px;
  font-size:.95rem;
  font-weight:600;
  border:none;
  border-radius:16px;
  color:white;
  cursor:pointer;
  box-shadow:0 10px 20px rgba(255,120,180,.35);
  transition:.2s;
}

.btn:hover{transform:translateY(-2px)}
.btn.active{animation:pulse 1.6s infinite}

@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(255,255,255,.6)}
  70%{box-shadow:0 0 0 16px rgba(255,255,255,0)}
  100%{box-shadow:0 0 0 0 rgba(255,255,255,0)}
}

/* ===== BUTTON COLORS ===== */
.btn-train{background:linear-gradient(135deg,#5f2c82,#9f5fff)}
.btn-pause{background:linear-gradient(135deg,#6a3093,#a044ff)}
.btn-stop{background:linear-gradient(135deg,#8e2de2,#ff416c)}
.btn-present{background:linear-gradient(to top,#ff0844,#ffb199)}
.btn-exam{background:linear-gradient(135deg,#ff7a18,#ffb347)}
.btn-reset{background:linear-gradient(135deg,#f83600,#f9d423)}

.hidden{display:none}

/* ===== VISUAL CARD ===== */
#visual{
  position:relative;
  min-height:200px;
  border-radius:20px;
  padding:20px;
  color:white;
  font-size:1.25rem;
  display:flex;
  flex-direction:column;
  justify-content:center;
  text-align:center;
  box-shadow:0 8px 20px rgba(0,0,0,.15);
}

#countdown{
  position:absolute;
  top:12px;
  right:12px;
  font-size:1.8rem;
  background:rgba(255,255,255,.25);
  padding:6px 14px;
  border-radius:16px;
}

/* ===== BACKGROUNDS ===== */
.bg-3pas{background:linear-gradient(to top,#30cfd0,#330867)}
.bg-surplace{background:linear-gradient(to top,#888,#444)}
.bg-multi{background:linear-gradient(to top,#f43b47,#453a94)}

/* ===== RECAP ===== */
#recap{
  margin-top:18px;
  padding:16px;
  border-radius:18px;
  background-image:linear-gradient(15deg,#13547a 0%,#80d0c7 100%);
  color:white;
  box-shadow:var(--shadow);
}

#recap h3{margin-top:0}

.recap-block{
  background-image:linear-gradient(-225deg,#FFFEFF 0%,#D7FFFE 100%);
  color:#444;
  border-radius:14px;
  padding:10px;
  margin:8px 0;
}

.recap-block button{
  width:100%;
  padding:8px;
  border:none;
  border-radius:12px;
  background:#ffffffaa;
  font-family:'Fredoka';
  cursor:pointer;
}
</style>
</head>

<body>
<main>
<div class="card">

<h1>ğŸ¥‹ Kihon Trainer ğŸŒ¸</h1>

<!-- ===== MODES ===== -->
<div class="controls">
  <select id="mode">
    <option value="1">ğŸ² Exercice 1 â€“ AlÃ©atoire global</option>
    <option value="2">ğŸ¯ Exercice 2 â€“ Par catÃ©gorie</option>
    <option value="3">ğŸ“‚ Exercice 3 â€“ CatÃ©gorie choisie</option>
    <option value="exam">ğŸ“ Mode examen blanc</option>
  </select>

  <select id="categorie">
    <option value="3pas">3 pas</option>
    <option value="surplace">Sur place</option>
    <option value="multi">Multidirectionnel</option>
  </select>

  <input type="number" id="count" min="1" value="3">
  <input type="range" id="interval" min="30" max="240" value="60">
  <span id="intervalVal">1m 00s</span>
</div>

<!-- ===== BUTTONS ===== -->
<div class="button-bar">
  <button id="start" class="btn btn-train">â–¶ï¸ Lancer lâ€™entraÃ®nement</button>
  <button id="pause" class="btn btn-pause">â¸ Pause</button>
  <button id="stop" class="btn btn-stop">â¹ Stop</button>
  <button id="presentationExam" class="btn btn-present hidden">ğŸ“¢ PrÃ©sentation examen</button>
  <button id="startExam" class="btn btn-exam hidden">ğŸ“ Lancer lâ€™examen</button>
  <button id="reset" class="btn btn-reset">ğŸ”„ RÃ©initialiser</button>
</div>

<!-- ===== VISUAL ===== -->
<div id="visual" class="bg-3pas">
  <div id="text">PrÃªt ğŸŒ¸</div>
  <div id="countdown"></div>
</div>

<!-- ===== RECAP ===== -->
<div id="recap" class="hidden"></div>

</main>

<script>
/* ===================== DATA ===================== */
let DATA = {};

async function loadData(){
  const res = await fetch("enchainements.json");
  DATA = await res.json();

  // Ajout catÃ©gorie "Cibles" dans le select pour entraÃ®nement libre
  if(!document.querySelector("#categorie option[value='cibles']")){
    const opt = document.createElement("option");
    opt.value = "cibles";
    opt.textContent = "Cibles";
    categorie.appendChild(opt);
  }
}

/* ===================== BG ===================== */
const BG = {
  "3pas": "bg-3pas",
  "surplace": "bg-surplace",
  "multi": "bg-multi",
  "cibles": "bg-multi" // mÃªme couleur que multi
};

/* ===================== ELEMENTS ===================== */
const mode = document.getElementById("mode");
const categorie = document.getElementById("categorie");
const countInput = document.getElementById("count");
const intervalInput = document.getElementById("interval");
const intervalVal = document.getElementById("intervalVal");

const startBtn = document.getElementById("start");
const pauseBtn = document.getElementById("pause");
const stopBtn = document.getElementById("stop");
const resetBtn = document.getElementById("reset");
const presentationBtn = document.getElementById("presentationExam");
const startExamBtn = document.getElementById("startExam");

const visual = document.getElementById("visual");
const text = document.getElementById("text");
const countdown = document.getElementById("countdown");
const recap = document.getElementById("recap");

/* ===================== Ã‰TAT ===================== */
let sequence = [];
let index = 0;
let timer = null;
let paused = false;
let stopped = false;
let examMode = false;
let workedSeconds = 0;
let examRecapData = [];
let trainingRecapData = [];

window.onload = async () => {
  await loadData();
};

/* ===================== UTILS ===================== */
const fmt = s => `${Math.floor(s/60)}m ${String(s%60).padStart(2,"0")}s`;

function speak(t, rate = 1){
  return new Promise(res=>{
    const u = new SpeechSynthesisUtterance(t);
    u.lang = "fr-FR";
    u.rate = rate;
    u.onend = res;
    speechSynthesis.speak(u);
  });
}

function setActive(btn){
  document.querySelectorAll(".btn").forEach(b=>b.classList.remove("active"));
  if(btn) btn.classList.add("active");
}

intervalInput.oninput = () => {
  intervalVal.textContent = fmt(+intervalInput.value);
};

/* ===================== PICK RANDOM ===================== */
function pickRandom(category, n=1){
  const list = DATA[category];
  const shuffled = list.sort(()=>Math.random()-0.5);
  return n===1 ? shuffled[0] : shuffled.slice(0,n);
}

/* ===================== MODE CHANGE ===================== */
mode.onchange = () => {
  const exam = mode.value === "exam";
  presentationBtn.classList.toggle("hidden", !exam);
  startExamBtn.classList.toggle("hidden", !exam);
  startBtn.classList.toggle("hidden", exam);
  categorie.disabled = exam;
  countInput.disabled = exam;
  intervalInput.disabled = exam;
};

/* ===================== PRÃ‰SENTATION EXAMEN ===================== */
presentationBtn.onclick = async () => {
  speechSynthesis.cancel();
  await speak(
    "Vous avez choisi le mode examen blanc. " +
    "PremiÃ¨re partie : enchaÃ®nements sur trois pas. " +
    "DeuxiÃ¨me partie : enchaÃ®nement sur place, garde annoncÃ©e. " +
    "TroisiÃ¨me partie : multidirectionnel, garde annoncÃ©e. " +
    "QuatriÃ¨me partie : travail sur cibles. " +
    "La pause est autorisÃ©e.", 0.7
  );
};

/* ===================== BUILD EXAM ===================== */
function buildExam(){
  const seq = [];
  examRecapData.length = 0;

  // ===== PARTIE 1 â€” 3 PAS =====
  const p1 = pickRandom("Sur trois pas", 3);
  examRecapData.push({ title:"Partie 1 â€“ EnchaÃ®nements sur 3 pas", items:p1.map(x=>x.display), time:180 });
  p1.forEach((ex,i)=>{
    seq.push({
      cat:"3pas",
      display:ex,
      spoken:ex, // ou phonÃ©tique si dÃ©fini
      time: +intervalInput.value, // durÃ©e individuelle
      announce: i===0 ? "PremiÃ¨re partie : enchaÃ®nements sur trois pas" : null,
      shortText: "Concentrez-vous sur la posture et la prÃ©cision."
    });
  });

  // ===== PARTIE 2 â€” SUR PLACE =====
  const p2 = pickRandom("Sur place");
  examRecapData.push({ title:"Partie 2 â€“ Sur place", items:[p2.display||p2], time:60 });
  seq.push({ cat:"surplace", display:p2, spoken:p2, garde:"gauche", time: +intervalInput.value, announce:"DeuxiÃ¨me partie : enchaÃ®nement sur place" });
  seq.push({ cat:"surplace", garde:"droite", time:+intervalInput.value });

  // ===== PARTIE 3 â€” MULTI =====
  const p3 = pickRandom("Multidirectionnel",1)[0];
  examRecapData.push({ title:"Partie 3 â€“ Multidirectionnel", items:[p3.display||p3], time:90 });
  seq.push({
    cat:"multi",
    display:p3,
    spoken:p3,
    garde:"gauche",
    time:+intervalInput.value,
    announce:"TroisiÃ¨me partie : multidirectionnel",
    shortText: "Travaillez les angles et la fluiditÃ©."
  });
  seq.push({ cat:"multi", garde:"droite", time:+intervalInput.value });

  // ===== PARTIE 4 â€” CIBLES =====
  const p4 = pickRandom("Cibles");
  examRecapData.push({ title:"Partie 4 â€“ Travail sur cibles", items:[p4.display||p4], time:60 });
  seq.push({ cat:"cibles", display:p4, spoken:p4, time:+intervalInput.value, announce:"QuatriÃ¨me partie : travail sur cibles" });

  return seq;
}

/* ===================== RUN ===================== */
async function run(){
  if(stopped) return;
  if(index >= sequence.length){
    await speak(examMode ? "Fin de l'examen" : "Fin de l'exercice", 1);
    showRecap();
    return;
  }

  const ex = sequence[index]; // âœ… dÃ©claration avant usage
  visual.className = BG[ex.cat] || visual.className;

  // Annonce partie si nÃ©cessaire
  if(ex.announce) await speak(ex.announce, 0.7);

  // Affichage + annonce
  if(ex.display){
    text.innerHTML = `<strong>${ex.display}</strong>` + (ex.shortText ? `<br><em>${ex.shortText}</em>` : "");
    await speak(ex.spoken || ex.display, 0.7);
  }

  // Gestion gardes
  if(ex.garde){
    const prev = ex.display || sequence[index-1]?.display || "";
    text.innerHTML = `Garde Ã  ${ex.garde}<br><strong>${prev}</strong>`;
    await speak("Garde Ã  " + ex.garde, 1);
  }

  await speak("HajimÃ©", 1);

  let t = ex.time;
  countdown.textContent = fmt(t);

  timer = setInterval(()=>{
    if(paused || stopped) return;
    t--; workedSeconds++;
    countdown.textContent = fmt(t);
    if(t<=0){
      clearInterval(timer);
      index++; run();
    }
  },1000);
}

/* ===================== RÃ‰CAP ===================== */
function showRecap(){
  recap.innerHTML = "<h3>ğŸ“„ RÃ©capitulatif</h3>";
  const source = examMode ? examRecapData : trainingRecapData;
  source.forEach(r=>{
    recap.innerHTML += `
      <div class="recap-block">
        <strong>${r.title}</strong><br>
        <em>DurÃ©e : ${fmt(r.time)}</em>
        <ul>
          ${r.items.map(i=>`<li>${i}</li>`).join("")}
        </ul>
      </div>
    `;
  });
  recap.classList.remove("hidden");
}

/* ===================== EVENTS ===================== */
startExamBtn.onclick = ()=>{
  examMode = true;
  stopped = false; paused = false; workedSeconds = 0; index = 0;
  sequence = buildExam();
  recap.classList.add("hidden");
  setActive(startExamBtn);
  run();
};

startBtn.onclick = ()=>{
  examMode = false; stopped = false; paused = false; workedSeconds = 0; index = 0;
  sequence = []; recap.classList.add("hidden");
  const m = mode.value, cat = categorie.value, qty = +countInput.value, t = +intervalInput.value;

  if(m==="1"){
    Object.entries(DATA).forEach(([c,l])=>l.forEach(x=>sequence.push({cat:c, display:x, spoken:x, time:t})));
    sequence = sequence.sort(()=>Math.random()-0.5).slice(0,qty);
  }
  if(m==="2"){
    Object.entries(DATA).forEach(([c,l])=>{
      const ex = l[Math.floor(Math.random()*l.length)];
      sequence.push({cat:c, display:ex, spoken:ex, time:t});
    });
  }
  if(m==="3"){
    sequence = DATA[cat].sort(()=>Math.random()-0.5).slice(0,qty)
      .map(x=>({cat:cat, display:x, spoken:x, time:t}));
  }

  // Ajout textes courts pour ex 1 et 3
  sequence.forEach((ex,i)=>{
    if(m==="1" || m==="3"){
      ex.shortText = "RÃ©pÃ©tez avec concentration et prÃ©cision.";
    }
  });

  trainingRecapData = [{ title:"EntraÃ®nement rÃ©alisÃ©", items:sequence.map(e=>e.display), time:0 }];
  setActive(startBtn);
  run();
};

pauseBtn.onclick = ()=>{
  paused = !paused;
  pauseBtn.textContent = paused ? "â–¶ï¸ Reprendre" : "â¸ Pause";
  setActive(paused ? pauseBtn : null);
};

stopBtn.onclick = ()=>{
  stopped = true;
  clearInterval(timer);
  speechSynthesis.cancel();
  text.textContent = "SÃ©ance arrÃªtÃ©e";
  countdown.textContent = "";
  setActive(stopBtn);
};

resetBtn.onclick = ()=>{
  stopped = true; paused = false;
  clearInterval(timer); speechSynthesis.cancel();
  text.textContent = "PrÃªt ğŸŒ¸";
  countdown.textContent = "";
  recap.innerHTML = "";
  recap.classList.add("hidden");
  setActive(null);
};
</script>

</body>
</html>
