<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coach Tai Jitsu â€“ SÃ©ance + Ã‰valuation</title>

<style>
body { font-family: system-ui,sans-serif; margin:0; background:linear-gradient(to right,#ffecd2,#fcb69f);}
h1 { text-align:center; padding:1rem; }
.container { max-width:1100px; margin:auto; padding:1rem; display:grid; grid-template-columns:1fr 1fr; gap:1rem;}
.panel { background:#fff; border-radius:16px; padding:1rem; box-shadow:0 6px 14px rgba(0,0,0,.15);}
.uv { margin-bottom:1rem; }
.exercise { display:flex; justify-content:space-between; align-items:center; padding:.5rem .7rem; border-radius:10px; margin:.3rem 0; background:#f5f5f5;}
.exercise.selected { background:#d1f5d3; }
.exercise button { border:none; border-radius:8px; padding:.3rem .6rem; cursor:pointer; font-size:1rem; }
.controls { margin-top:.8rem; display:flex; gap:.5rem; flex-wrap:wrap; }
input[type=text] { width:100%; padding:.6rem; border-radius:10px; border:1px solid #ccc; margin-bottom:.5rem; }
input[type=range]{ width:120px; margin-left:.5rem; }
#progress { width:100%; height:16px; margin-top:.8rem; }
textarea { width:100%; border-radius:12px; padding:.6rem; margin-top:.5rem; }
label{ font-weight:bold; display:block; margin-top:.5rem; }
.history-item{ border-bottom:1px solid #ccc; padding:.3rem 0; }

/* ğŸ“± Mobile : cards empilÃ©es */
@media (max-width:768px){
  .container{ grid-template-columns:1fr; }
}

/* Overlay plein Ã©cran */
#trainingOverlay {
  display:none; position:fixed; inset:0;
  background:linear-gradient(to right,#84fab0,#8fd3f4);
  z-index:999; flex-direction:column;
  justify-content:center; align-items:center;
}
#trainingOverlay h1 { font-size:3rem; }
#trainingOverlay #timer { font-size:4rem; }
#trainingOverlay progress { width:80%; height:24px; }
#trainingOverlay button { margin-top:2rem;padding:1rem 2rem;font-size:1.2rem;border-radius:12px; cursor:pointer; }
</style>
</head>

<body>
<h1>ğŸ¥‹ Coach Tai Jitsu â€“ SÃ©ance + Ã‰valuation</h1>

<div class="container">
  <div class="panel">
    <h2>ğŸ“š Banque d'exercices</h2>
    <div id="bank"></div>
  </div>

  <div class="panel">
    <h2>ğŸ“ SÃ©ance sÃ©lectionnÃ©e</h2>
    <input type="text" id="sessionName" placeholder="Nom de la sÃ©ance">
    <div id="selection"></div>

    <label>Carnet de notes :</label>
    <textarea id="notes" rows="3"></textarea>

    <div class="controls">
      <button onclick="saveSelection()">ğŸ’¾ Sauvegarder la sÃ©lection</button>
      <button onclick="clearSelection()">ğŸ§¹ Vider la sÃ©lection</button>
      <button onclick="startSession()">â–¶ï¸ Commencer entraÃ®nement</button>
      <button onclick="toggleFullscreen()">ğŸ“± Plein Ã©cran exercice</button>
      <button onclick="showHistory()">ğŸ“Š Historique</button>
    </div>

    <progress id="progress" value="0" max="100"></progress>
    <div id="goals"></div>
  </div>
</div>

<!-- Overlay entraÃ®nement -->
<div id="trainingOverlay">
  <h1 id="exerciseName">Exercice</h1>
  <div id="timer">00:00</div>
  <progress id="sessionProgress" value="0" max="100"></progress>
  <button onclick="toggleFullscreen()">âŒ Quitter plein Ã©cran</button>
</div>

<!-- Modal historique -->
<div id="modal" style="display:none; position:fixed; inset:0;background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center; padding:1rem;">
  <div style="background:#fff; border-radius:16px; padding:1rem; max-width:600px; width:100%;">
    <h2>ğŸ“‹ Historique & Ã‰valuation</h2>
    <div id="historyList"></div>
    <button onclick="closeModal()">âŒ Fermer</button>
  </div>
</div>

<!-- Modal objectif -->
<div id="goalModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1100; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:1rem; border-radius:16px; width:90%; max-width:320px;">
    <h3 id="goalTitle"></h3>
    <label>Objectif hebdomadaire (min)</label>
    <input type="number" id="goalInput">
    <div style="margin-top:1rem; display:flex; gap:.5rem;">
      <button onclick="saveGoal()">ğŸ’¾ Sauvegarder</button>
      <button onclick="closeGoalModal()">âŒ Annuler</button>
    </div>
  </div>
</div>

<audio id="beep" src="beep.mp3"></audio>
<audio id="ding" src="ding.mp3"></audio>

<script>
/* ===== DONNÃ‰ES ===== */
const bankData=[
 {uv:'ğŸ¥‹ UV 1 â€“ Kihon',items:['Kihon simple','EnchaÃ®nement','Cibles'],criteria:['PrÃ©cision','RÃ©activitÃ©','Posture']},
 {uv:'ğŸŒ€ UV 2 â€“ DÃ©placements',items:['TaÃ¯ sabaki','Slow ippon','Ippon kumite'],criteria:['FluiditÃ©','Ã‰quilibre','ContrÃ´le']},
 {uv:'ğŸ“ UV 3 â€“ Kata',items:['Slow kata','Kata nidan','BunkaÃ¯'],criteria:['Exactitude','MaÃ®trise','Kime']},
 {uv:'âš™ï¸ UV 4 â€“ Technique de base',items:['Shadow'],criteria:['RÃ©alisme','Zanchin','Protection']},
 {uv:'ğŸ”¥ UV 5 & 6 â€“ Randori',items:['Randori shadow'],criteria:['RÃ©alisme','Zanchin','Protection']}
];

/* ===== Ã‰TAT ===== */
let selection = JSON.parse(localStorage.getItem('tj-selection')) || [];
let sessions = JSON.parse(localStorage.getItem('tj-sessions')) || {};
let goals = JSON.parse(localStorage.getItem('tj-goals')) || {};
let seqIndex=0,timer=null,fullscreen=false;
let currentSessionName="", currentGoalExercise=null;

/* ===== UTIL ===== */
function weekKey(){
 const d=new Date(),j=new Date(d.getFullYear(),0,1);
 return d.getFullYear()+"-W"+Math.ceil((((d-j)/86400000)+j.getDay()+1)/7);
}
function speak(txt,cb){
 const u=new SpeechSynthesisUtterance(txt);
 u.lang='fr-FR'; u.onend=cb; speechSynthesis.speak(u);
}
function formatTime(s){
 return String(Math.floor(s/60)).padStart(2,'0')+":"+String(s%60).padStart(2,'0');
}

/* ===== BANQUE ===== */
function renderBank(){
 const b=document.getElementById('bank'); b.innerHTML='';
 bankData.forEach(u=>{
  const uv=document.createElement('div'); uv.className='uv';
  uv.innerHTML=`<h4>${u.uv}</h4>`;
  u.items.forEach(n=>{
    const d=document.createElement('div'); d.className='exercise';
    d.innerHTML=`<span>${n}</span><button>â•</button>`;
    d.querySelector('button').onclick=()=>addExercise(u.uv,n);
    uv.appendChild(d);
  });
  b.appendChild(uv);
 });
}

/* ===== SÃ‰LECTION (INCHANGÃ‰E) ===== */
function renderSelection(){
 const s=document.getElementById('selection'); s.innerHTML='';
 if(!selection.length){ s.innerHTML='<em>Aucun exercice</em>'; return; }
 selection.forEach((e,i)=>{
  const div=document.createElement('div'); div.className='exercise selected';
  div.textContent = `${e.uv} â€“ ${e.name} `;
  const range=document.createElement('input');
  range.type='range'; range.min=1; range.max=60; range.value=e.duration;
  range.oninput=(ev)=>updateDuration(i,ev.target.value);
  const span=document.createElement('span'); span.textContent=`${e.duration} min`;
  const up=document.createElement('button'); up.textContent='â¬†ï¸'; up.onclick=()=>moveUp(i);
  const down=document.createElement('button'); down.textContent='â¬‡ï¸'; down.onclick=()=>moveDown(i);
  const del=document.createElement('button'); del.textContent='âŒ'; del.onclick=()=>removeExercise(i);
  div.append(range,span,up,down,del);
  s.appendChild(div);
 });
 renderGoals();
}

/* ===== OBJECTIFS (MODAL UNIQUEMENT) ===== */
function renderGoals(){
 const g=document.getElementById('goals'); g.innerHTML='';
 const wk=weekKey();
 selection.forEach(ex=>{
  if(!goals[ex.name]) goals[ex.name]=30;
  let done=0;
  Object.values(sessions).forEach(s=>{
   if(s.week===wk) s.exercises.forEach(e=>{
    if(e.name===ex.name) done+=e.doneMinutes||0;
   });
  });
  const pct=Math.min(100,Math.round(done/goals[ex.name]*100));
  const d=document.createElement('div');
  d.innerHTML=`
   <strong>${ex.name}</strong><br>
   Objectif :
   <span style="cursor:pointer;text-decoration:underline"
     onclick="openGoalModal('${ex.name}',${goals[ex.name]})">
     ${goals[ex.name]} min
   </span>
   <progress value="${pct}" max="100"></progress> ${pct}%`;
  g.appendChild(d);
 });
 localStorage.setItem('tj-goals',JSON.stringify(goals));
}

function openGoalModal(name,val){
 currentGoalExercise=name;
 goalTitle.textContent=name;
 goalInput.value=val;
 goalModal.style.display='flex';
}
function closeGoalModal(){ goalModal.style.display='none'; }
function saveGoal(){
 goals[currentGoalExercise]=parseInt(goalInput.value);
 renderGoals(); closeGoalModal();
}

/* ===== ACTIONS ===== */
function addExercise(uv,name){ selection.push({uv,name,duration:5,doneMinutes:0}); saveSelection();}
function updateDuration(i,v){ selection[i].duration=parseInt(v); saveSelection();}
function moveUp(i){ if(i>0){ [selection[i-1],selection[i]]=[selection[i],selection[i-1]]; saveSelection();}}
function moveDown(i){ if(i<selection.length-1){ [selection[i+1],selection[i]]=[selection[i],selection[i+1]]; saveSelection();}}
function removeExercise(i){ selection.splice(i,1); saveSelection();}
function saveSelection(){ localStorage.setItem('tj-selection',JSON.stringify(selection)); renderSelection();}
function clearSelection(){ selection=[]; saveSelection(); }

/* ===== ENTRAÃNEMENT (INCHANGÃ‰) ===== */
function startSession(){
 if(!selection.length){ alert("SÃ©lectionnez des exercices"); return; }
 const name=document.getElementById('sessionName').value||"SÃ©ance "+new Date().toLocaleString();
 currentSessionName=name;
 sessions[name]={date:new Date().toLocaleString(),week:weekKey(),exercises:selection.map(e=>({...e})),notes:notes.value};
 localStorage.setItem('tj-sessions',JSON.stringify(sessions));
 seqIndex=0; speak("CommenÃ§ons l'entraÃ®nement",nextExercise);
}

function nextExercise(){
 if(seqIndex>=selection.length){ speak("EntraÃ®nement terminÃ©"); return; }
 const ex=selection[seqIndex];
 exerciseName.textContent=ex.name;
 if(fullscreen) trainingOverlay.style.display='flex';
 speak(ex.name,()=>{
  let remaining=ex.duration*60;
  timer=setInterval(()=>{
   timerDisplay=timer; timerDisplay;
   timer.textContent=formatTime(remaining);
   remaining--;
   if(remaining<0){
    clearInterval(timer);
    sessions[currentSessionName].exercises[seqIndex].doneMinutes=ex.duration;
    localStorage.setItem('tj-sessions',JSON.stringify(sessions));
    seqIndex++; nextExercise();
   }
  },1000);
 });
}

function toggleFullscreen(){
 fullscreen=!fullscreen;
 trainingOverlay.style.display=fullscreen?'flex':'none';
}

/* ===== HISTORIQUE (INCHANGÃ‰) ===== */
function showHistory(){
 modal.style.display='flex';
 historyList.innerHTML='';
 for(const n in sessions){
  const s=sessions[n];
  let d=document.createElement('div');
  d.className='history-item';
  let html=`<strong>${n}</strong> (${s.date})<br>`;
  s.exercises.forEach(e=>html+=`- ${e.name}: ${e.doneMinutes||0} min<br>`);
  html+=`Notes: ${s.notes||''}<br><br>`;
  d.innerHTML=html;
  historyList.appendChild(d);
 }
}
function closeModal(){ modal.style.display='none'; }

/* ===== INIT ===== */
renderBank();
renderSelection();
renderGoals();
</script>
</body>
</html>
