<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coach Tai Jitsu ‚Äì S√©ance + √âvaluation</title>
<style>
body { font-family: system-ui,sans-serif; margin:0; background:linear-gradient(to right,#ffecd2,#fcb69f);}
h1 { text-align:center; padding:1rem; }
.container { max-width:1100px; margin:auto; padding:1rem; display:grid; grid-template-columns:1fr 1fr; gap:1rem;}
.panel { background:#fff; border-radius:16px; padding:1rem; box-shadow:0 6px 14px rgba(0,0,0,.15);}
.uv { margin-bottom:1rem; }
.exercise { display:flex; justify-content:space-between; align-items:center; padding:.5rem .7rem; border-radius:10px; margin:.3rem 0; background:#f5f5f5;}
.exercise.selected { background:#d1f5d3; }
.exercise.active { background:#ffe8b3; }
.exercise.done { text-decoration:line-through; opacity:.6; }
.exercise button { border:none; border-radius:8px; padding:.3rem .6rem; cursor:pointer; font-size:1rem; }
.controls { margin-top:.8rem; display:flex; gap:.5rem; flex-wrap:wrap; }
input[type=text] { width:100%; padding:.6rem; border-radius:10px; border:1px solid #ccc; margin-bottom:.5rem; }
input[type=range]{ width:120px; margin-left:.5rem; }
#progress { width:100%; height:16px; margin-top:.8rem; }
textarea { width:100%; border-radius:12px; padding:.6rem; margin-top:.5rem; }
label{ font-weight:bold; display:block; margin-top:.5rem; }
.history-item{ border-bottom:1px solid #ccc; padding:.3rem 0; }

/* Mobile : empilement */
@media (max-width: 768px) { .container { grid-template-columns: 1fr; } }

/* Overlay plein √©cran */
#trainingOverlay { display:none; position:fixed; inset:0; background:linear-gradient(to right,#84fab0,#8fd3f4); z-index:999; flex-direction:column; justify-content:center; align-items:center; }
#trainingOverlay h1 { font-size:3rem; margin-bottom:1rem; }
#trainingOverlay #timer { font-size:4rem; margin-bottom:1rem; }
#trainingOverlay progress { width:80%; height:24px; }
#trainingOverlay button { margin-top:2rem;padding:1rem 2rem;font-size:1.2rem;border-radius:12px; cursor:pointer; }

/* Modal √©valuation */
#evalModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:1100; justify-content:center; align-items:center; }
#evalModal div { background:#fff; padding:1rem; border-radius:16px; width:90%; max-width:400px; }
#evalModal textarea { height:120px; }
</style>
</head>
<body>
<h1>ü•ã Coach Tai Jitsu ‚Äì S√©ance + √âvaluation</h1>

<div class="container">
  <div class="panel">
    <h2>üìö Banque d'exercices</h2>
    <div id="bank"></div>
  </div>

  <div class="panel">
    <h2>üìù S√©ance s√©lectionn√©e</h2>
    <input type="text" id="sessionName" placeholder="Nom de la s√©ance">
    <div id="selection"></div>

    <label>Carnet de notes :</label>
    <textarea id="notes" rows="3" placeholder="Ressenti du jour..."></textarea>

    <div class="controls">
      <button onclick="saveSelection()">üíæ Sauvegarder la s√©lection</button>
      <button onclick="clearSelection()">üßπ Vider la s√©lection</button>
      <button onclick="startSession()">‚ñ∂Ô∏è Commencer entra√Ænement</button>
      <button id="pauseBtn" onclick="togglePause()" disabled>‚è∏Ô∏è Pause</button>
      <button onclick="toggleFullscreen()">üì± Plein √©cran exercice</button>
      <button onclick="showHistory()">üìä Historique</button>
    </div>

    <progress id="progress" value="0" max="100"></progress>
    <div id="goals"></div>
  </div>
</div>

<div id="trainingOverlay">
  <h1 id="exerciseName">Exercice</h1>
  <div id="timer">00:00</div>
  <progress id="sessionProgress" value="0" max="100"></progress>
  <button onclick="toggleFullscreen()">‚ùå Quitter plein √©cran</button>
</div>

<div id="modal" style="display:none; position:fixed; inset:0;background:rgba(0,0,0,0.6); color:#000; z-index:1000; justify-content:center; align-items:center; padding:1rem; overflow:auto;">
  <div style="background:#fff; border-radius:16px; padding:1rem; max-width:600px; width:100%;">
    <h2>üìã Historique & √âvaluation</h2>
    <div id="historyList"></div>
    <button onclick="closeModal()" style="margin-top:1rem;">‚ùå Fermer</button>
  </div>
</div>

<div id="evalModal">
  <div>
    <h2>C'est le moment de l'√©valuation üìù</h2>
    <p>√âcrivez vos notes ci-dessous :</p>
    <textarea id="evalNotes"></textarea>
    <h3>Auto-√©valuation des exercices</h3>
<div id="selfEvalContainer"></div>

    <button onclick="finishEvaluation()">‚úÖ J'ai fini d'√©crire mes notes</button>
  </div>
</div>

<audio id="beep" src="beep.mp3"></audio>
<audio id="ding" src="ding.mp3"></audio>

<script>
/* ===== DONN√âES ===== */
const bankData=[
 {uv:'ü•ã UV 1 ‚Äì Kihon',items:['Kihon simple','Encha√Ænement','Cibles'],criteria:['Pr√©cision','R√©activit√©','Posture']},
 {uv:'üåÄ UV 2 ‚Äì D√©placements',items:['Ta√Ø sabaki','Slow ippon','Ippon kumite'],criteria:['Fluidit√©','√âquilibre','Contr√¥le']},
 {uv:'üìê UV 3 ‚Äì Kata',items:['Slow kata','Kata nidan','Bunka√Ø'],criteria:['Exactitude','Ma√Ætrise','Kime']},
 {uv:'‚öôÔ∏è UV 4 ‚Äì Technique de base',items:['Shadow'],criteria:['R√©alisme','Zanchin','Protection']},
 {uv:'üî• UV 5 & 6 ‚Äì Randori',items:['Randori shadow'],criteria:['R√©alisme','Zanchin','Protection']}
];

let selection = JSON.parse(localStorage.getItem('tj-selection')) || [];
let sessions = JSON.parse(localStorage.getItem('tj-sessions')) || {};
let goals = JSON.parse(localStorage.getItem('tj-goals')) || {};
let seqIndex=0, timer=null, fullscreen=false;
let currentSessionName="", currentGoalExercise=null;
let paused=false, remainingTime=0;

/* ===== UTIL ===== */
function weekKey(){ const d=new Date(),j=new Date(d.getFullYear(),0,1); return d.getFullYear()+"-W"+Math.ceil((((d-j)/86400000)+j.getDay()+1)/7);}
function speak(txt,cb){ const u=new SpeechSynthesisUtterance(txt); u.lang='fr-FR'; u.onend=cb; speechSynthesis.speak(u);}
function formatTime(s){return String(Math.floor(s/60)).padStart(2,'0')+":"+String(s%60).padStart(2,'0');}

/* ===== BANQUE ===== */
function renderBank(){ const b=document.getElementById('bank'); b.innerHTML=''; bankData.forEach(u=>{ const uvDiv=document.createElement('div'); uvDiv.className='uv'; const h4=document.createElement('h4'); h4.textContent = u.uv; uvDiv.appendChild(h4); u.items.forEach(n=>{ const exDiv=document.createElement('div'); exDiv.className='exercise'; const span=document.createElement('span'); span.textContent=n; const btn=document.createElement('button'); btn.textContent='‚ûï'; btn.onclick = ()=>addExercise(u.uv,n); exDiv.appendChild(span); exDiv.appendChild(btn); uvDiv.appendChild(exDiv); }); b.appendChild(uvDiv); });}

/* ===== S√âLECTION ===== */
function renderSelection(){ 
 const s=document.getElementById('selection'); s.innerHTML=''; 
 if(!selection.length){ s.innerHTML='<em>Aucun exercice</em>'; return; }
 selection.forEach((e,i)=>{
   const criteria = bankData.find(u=>u.uv===e.uv)?.criteria.join(', ') || '';
   const div=document.createElement('div'); div.className='exercise selected';
   if(seqIndex===i) div.classList.add('active');
   if(e.doneMinutes) div.classList.add('done');
   const innerDiv=document.createElement('div');
   div.textContent = `${e.uv} ‚Äì ${e.name} `;
   const range=document.createElement('input'); range.type='range'; range.min=1; range.max=60; range.value=e.duration; range.oninput=(ev)=>updateDuration(i,ev.target.value);
   const spanVal=document.createElement('span'); spanVal.textContent=`${e.duration} min`;
   const btnUp=document.createElement('button'); btnUp.textContent='‚¨ÜÔ∏è'; btnUp.onclick=()=>moveUp(i);
   const btnDown=document.createElement('button'); btnDown.textContent='‚¨áÔ∏è'; btnDown.onclick=()=>moveDown(i);
   const btnDel=document.createElement('button'); btnDel.textContent='‚ùå'; btnDel.onclick=()=>removeExercise(i);
   const criteriaDiv=document.createElement('div'); criteriaDiv.style.fontSize='.8rem'; criteriaDiv.style.color='#555'; criteriaDiv.textContent=`Crit√®res: ${criteria}`;
   innerDiv.appendChild(range); innerDiv.appendChild(spanVal); innerDiv.appendChild(btnUp); innerDiv.appendChild(btnDown); innerDiv.appendChild(btnDel); innerDiv.appendChild(criteriaDiv);
   div.appendChild(innerDiv); s.appendChild(div);
 });
 renderGoals();
}

/* ===== OBJECTIFS ===== */
function renderGoals(){
  const g = document.getElementById('goals');
  g.innerHTML = '';
  const wk = weekKey();

  selection.forEach(ex=>{
    if(!goals[ex.name]) goals[ex.name] = 30;

    let done = 0;
    Object.values(sessions).forEach(s=>{
      if(s.week === wk){
        s.exercises.forEach(e=>{
          if(e.name === ex.name && e.doneMinutes){
            done += e.doneMinutes;
          }
        });
      }
    });

    const pct = Math.min(100, Math.round(done / goals[ex.name] * 100));

    const div = document.createElement('div');
    div.innerHTML = `
      <strong>${ex.name}</strong><br>
      Objectif 
      <input type="number" min="1" value="${goals[ex.name]}"
        onchange="setGoal('${ex.name}', this.value)"> min
      <progress value="${pct}" max="100"></progress> ${pct}%
    `;

    g.appendChild(div);
  });

  localStorage.setItem('tj-goals', JSON.stringify(goals));
}

function openGoalModal(name,val){ currentGoalExercise=name; document.getElementById('goalTitle').textContent=name; document.getElementById('goalValue').value=val; document.getElementById('goalModal').style.display='flex'; }
function closeGoalModal(){ document.getElementById('goalModal').style.display='none'; }
function confirmGoal(){ setGoal(currentGoalExercise, document.getElementById('goalValue').value); closeGoalModal(); }
function setGoal(name,v){goals[name]=parseInt(v); renderGoals();}

/* ===== ACTIONS SELECTION ===== */
function addExercise(uv,name){ selection.push({uv,name,duration:5,doneMinutes:0}); saveSelection();}
function updateDuration(i,v){selection[i].duration=parseInt(v); saveSelection();}
function moveUp(i){ if(i>0){ [selection[i-1],selection[i]]=[selection[i],selection[i-1]]; saveSelection();}}
function moveDown(i){ if(i<selection.length-1){ [selection[i+1],selection[i]]=[selection[i+1],selection[i]]; saveSelection();}}
function removeExercise(i){selection.splice(i,1); saveSelection();}
function saveSelection(){ localStorage.setItem('tj-selection',JSON.stringify(selection)); renderSelection();}
function clearSelection(){ if(confirm("Vider la s√©lection ?")){selection=[];saveSelection();}}

/* ===== ENTRA√éNEMENT ===== */
function startSession(){
 if(!selection.length){ alert("S√©lectionnez des exercices"); return; }
 const name = document.getElementById('sessionName').value || "S√©ance " + new Date().toLocaleString();
 currentSessionName = name;
 sessions[name] = { exercises: selection.map(e=>({...e, doneMinutes:0})), week: weekKey() };
 localStorage.setItem('tj-sessions', JSON.stringify(sessions));
 seqIndex=0; paused=false;
 speak("Commen√ßons l'entra√Ænement", nextExercise);
 document.getElementById('pauseBtn').disabled=false;
}

function nextExercise(){
 if(seqIndex>=selection.length){
  document.getElementById('evalNotes').value =
    document.getElementById('notes').value;

  buildSelfEvaluation();
  document.getElementById('evalModal').style.display = 'flex';
  return;
 }

 const ex = selection[seqIndex];
 document.getElementById('exerciseName').textContent = ex.name;
 if(fullscreen) document.getElementById('trainingOverlay').style.display = 'flex';

 selection.forEach((e,i)=>{
   const el = document.querySelectorAll('.exercise.selected')[i];
   el.classList.toggle('active', i === seqIndex);
 });

 speak(`Exercice ${seqIndex+1} : ${ex.name}`, ()=>{
   setTimeout(()=>{
     document.getElementById('beep').play();
     remainingTime = ex.duration * 60;
     clearInterval(timer);

     timer = setInterval(()=>{
       if(!paused){
         remainingTime--;
         document.getElementById('timer').textContent = formatTime(remainingTime);
         updateProgress();

         if(remainingTime <= 0){
           clearInterval(timer);

           // ‚úÖ comptabilisation correcte
           selection[seqIndex].doneMinutes = ex.duration;
           sessions[currentSessionName].exercises[seqIndex].doneMinutes = ex.duration;

           localStorage.setItem('tj-sessions', JSON.stringify(sessions));

           // ‚úÖ MAJ imm√©diate des objectifs
           renderGoals();

           // UI
           selection.forEach((e,i)=>{
             const el = document.querySelectorAll('.exercise.selected')[i];
             if(i === seqIndex){
               el.classList.remove('active');
               el.classList.add('done');
             }
           });

           speak("Fin de l'exercice", ()=>{
             seqIndex++;
             nextExercise();
           });
         }
       }
     }, 1000);
   }, 2000);
 });
}


function updateProgress(){
 if(!selection.length) return;
 let done=seqIndex;
 if(seqIndex<selection.length && document.getElementById('timer').textContent){
   const ex=selection[seqIndex];
   const t=parseInt(document.getElementById('timer').textContent.split(':')[0])*60+parseInt(document.getElementById('timer').textContent.split(':')[1]);
   done += (ex.duration*60 - t)/(ex.duration*60);
 }
 document.getElementById('progress').value = (done/selection.length)*100;
 document.getElementById('sessionProgress').value = (done/selection.length)*100;
}

function togglePause(){
 paused = !paused;
 document.getElementById('pauseBtn').textContent = paused ? "‚ñ∂Ô∏è Reprendre" : "‚è∏Ô∏è Pause";
}

function finishEvaluation(){
  // auto-√©valuation
  selection.forEach(ex => {
    const stored = sessions[currentSessionName].exercises
      .find(e => e.name === ex.name);
    if(stored){
      stored.selfEval = ex.selfEval || 3;
    }
  });

  // notes finales
  sessions[currentSessionName].notes =
    document.getElementById('evalNotes').value;

  // date de fin r√©elle
  sessions[currentSessionName].endDate =
    new Date().toLocaleString();

  localStorage.setItem('tj-sessions', JSON.stringify(sessions));

  // ‚úÖ rafra√Æchit la progression objectifs
  renderGoals();

  document.getElementById('evalModal').style.display = 'none';
}

function finishEvaluation(){
  // auto-√©valuation
  selection.forEach(ex => {
    const stored = sessions[currentSessionName].exercises
      .find(e => e.name === ex.name);
    if(stored){
      stored.selfEval = ex.selfEval || 3;
    }
  });

  // notes finales
  const finalNotes = document.getElementById('evalNotes').value;
  document.getElementById('notes').value = finalNotes;
  sessions[currentSessionName].notes = finalNotes;

  // date de fin r√©elle
  sessions[currentSessionName].date = new Date().toLocaleString();

  localStorage.setItem('tj-sessions', JSON.stringify(sessions));

  renderGoals();

  document.getElementById('evalModal').style.display = 'none';
  speak("Fin de l'entra√Ænement, √† bient√¥t !");
}


/* ===== PLEIN √âCRAN ===== */
function toggleFullscreen(){ fullscreen=!fullscreen; document.getElementById('trainingOverlay').style.display = fullscreen?'flex':'none'; }

/* ===== HISTORIQUE ===== */
function showHistory(){
 const modal=document.getElementById('modal'); modal.style.display='flex';
 const h=document.getElementById('historyList'); h.innerHTML='';
 for(const n in sessions){
   const s=sessions[n];
   let div=document.createElement('div'); div.className='history-item';
   let html = `<strong>${n}</strong> (${s.date || 'Pas de date'})<br>`;
   if(s.exercises && s.exercises.length){ s.exercises.forEach(e=>{ html += `- ${e.name}: ${e.doneMinutes || 0} min<br>`; }); }
   html += `Notes: ${s.notes||''}<br><br>`;
   div.innerHTML = html;
   h.appendChild(div);
 }
}
function closeModal(){ document.getElementById('modal').style.display='none'; }
function buildSelfEvaluation() {
  const container = document.getElementById('selfEvalContainer');
  container.innerHTML = '';

  selection.forEach(ex => {
    const div = document.createElement('div');
    div.style.marginBottom = '0.8rem';

    div.innerHTML = `
      <strong>${ex.name}</strong><br>
      <input type="range" min="1" max="5" value="${ex.selfEval || 3}" step="1">
      <span>${ex.selfEval || 3}</span>/5
    `;

    const slider = div.querySelector('input');
    const label = div.querySelector('span');

    slider.oninput = () => {
      label.textContent = slider.value;
      ex.selfEval = parseInt(slider.value);
    };

    container.appendChild(div);
  });
}
  function setGoal(name, v){
  goals[name] = parseInt(v);
  renderGoals();
}


/* ===== INIT ===== */
renderBank(); renderSelection(); renderGoals();
</script>
</body>
</html>

