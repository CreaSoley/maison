<script>
/* ===== DONNÃ‰ES ===== */
const bankData=[
 {uv:'ðŸ¥‹ UV 1 â€“ Kihon',items:['Kihon simple','EnchaÃ®nement','Cibles'],criteria:['PrÃ©cision','RÃ©activitÃ©','Posture']},
 {uv:'ðŸŒ€ UV 2 â€“ DÃ©placements',items:['TaÃ¯ sabaki','Slow ippon','Ippon kumite'],criteria:['FluiditÃ©','Ã‰quilibre','ContrÃ´le']},
 {uv:'ðŸ“ UV 3 â€“ Kata',items:['Slow kata','Kata nidan','BunkaÃ¯'],criteria:['Exactitude','MaÃ®trise','Kime']},
 {uv:'âš™ï¸ UV 4 â€“ Technique de base',items:['Shadow'],criteria:['RÃ©alisme','Zanchin','Protection']},
 {uv:'ðŸ”¥ UV 5 & 6 â€“ Randori',items:['Randori shadow'],criteria:['RÃ©alisme','Zanchin','Protection']}
];

let selection = JSON.parse(localStorage.getItem('tj-selection')) || [];
let sessions = JSON.parse(localStorage.getItem('tj-sessions')) || {};
let goals = JSON.parse(localStorage.getItem('tj-goals')) || {};
let seqIndex=0, timer=null, fullscreen=false;
let currentSessionName="", currentGoalExercise=null;
let paused=false, remainingTime=0;
let currentSessionId = null;

/* ===== UTIL ===== */
function weekKey(){ const d=new Date(),j=new Date(d.getFullYear(),0,1); return d.getFullYear()+"-W"+Math.ceil((((d-j)/86400000)+j.getDay()+1)/7);}
function speak(txt,cb){ const u=new SpeechSynthesisUtterance(txt); u.lang='fr-FR'; u.onend=cb; speechSynthesis.speak(u);}
function formatTime(s){return String(Math.floor(s/60)).padStart(2,'0')+":"+String(s%60).padStart(2,'0');}

/* ===== BANQUE ===== */
function renderBank(){ 
  const b=document.getElementById('bank'); 
  b.innerHTML='';
  bankData.forEach(u=>{
    const uvDiv=document.createElement('div'); uvDiv.className='uv'; 
    const h4=document.createElement('h4'); h4.textContent = u.uv; uvDiv.appendChild(h4); 
    u.items.forEach(n=>{
      const exDiv=document.createElement('div'); exDiv.className='exercise'; 
      const span=document.createElement('span'); span.textContent=n; 
      const btn=document.createElement('button'); btn.textContent='âž•'; btn.onclick = ()=>addExercise(u.uv,n); 
      exDiv.appendChild(span); exDiv.appendChild(btn); uvDiv.appendChild(exDiv); 
    }); 
    b.appendChild(uvDiv); 
  });
}

/* ===== SÃ‰LECTION ===== */
function renderSelection(){ 
 const s=document.getElementById('selection'); s.innerHTML=''; 
 if(!selection.length){ s.innerHTML='<em>Aucun exercice</em>'; return; }
 selection.forEach((e,i)=>{
   const criteria = bankData.find(u=>u.uv===e.uv)?.criteria.join(', ') || '';
   const div=document.createElement('div'); div.className='exercise selected';
   if(seqIndex===i) div.classList.add('active');
   if(e.doneMinutes) div.classList.add('done');
   const innerDiv=document.createElement('div');
   div.textContent = `${e.uv} â€“ ${e.name} `;
   const range=document.createElement('input'); range.type='range'; range.min=1; range.max=60; range.value=e.duration; range.oninput=(ev)=>updateDuration(i,ev.target.value);
   const spanVal=document.createElement('span'); spanVal.textContent=`${e.duration} min`;
   const btnUp=document.createElement('button'); btnUp.textContent='â¬†ï¸'; btnUp.onclick=()=>moveUp(i);
   const btnDown=document.createElement('button'); btnDown.textContent='â¬‡ï¸'; btnDown.onclick=()=>moveDown(i);
   const btnDel=document.createElement('button'); btnDel.textContent='âŒ'; btnDel.onclick=()=>removeExercise(i);
   const criteriaDiv=document.createElement('div'); criteriaDiv.style.fontSize='.8rem'; criteriaDiv.style.color='#555'; criteriaDiv.textContent=`CritÃ¨res: ${criteria}`;
   innerDiv.appendChild(range); innerDiv.appendChild(spanVal); innerDiv.appendChild(btnUp); innerDiv.appendChild(btnDown); innerDiv.appendChild(btnDel); innerDiv.appendChild(criteriaDiv);
   div.appendChild(innerDiv); s.appendChild(div);
 });
 renderGoals();
}

/* ===== OBJECTIFS ===== */
function renderGoals() {
  const g = document.getElementById('goals'); g.innerHTML=''; 
  const wk = weekKey();
  selection.forEach(ex => {
    if(goals[ex.name] === undefined) goals[ex.name]=30;
    let done=0;
    Object.values(sessions).forEach(s=>{
      if(s.week===wk){
        s.exercises.forEach(e=>{ if(e.name===ex.name && e.doneMinutes) done+=e.doneMinutes; });
      }
    });
    const pct=Math.min(100,Math.round(done/goals[ex.name]*100));
    const div=document.createElement('div');
    div.innerHTML = `<strong>${ex.name}</strong><br>
      Objectif <input type="number" min="1" value="${goals[ex.name]}" onchange="setGoal('${ex.name}',this.value)"> min
      <progress value="${pct}" max="100"></progress> ${pct}%`;
    g.appendChild(div);
  });
  localStorage.setItem('tj-goals', JSON.stringify(goals));
}
function setGoal(name,value){ goals[name]=parseInt(value); localStorage.setItem('tj-goals',JSON.stringify(goals)); renderGoals(); }

/* ===== ACTIONS SELECTION ===== */
function addExercise(uv,name){ selection.push({uv,name,duration:5,doneMinutes:0}); saveSelection();}
function updateDuration(i,v){ selection[i].duration=parseInt(v); saveSelection(); }
function moveUp(i){ if(i>0){ [selection[i-1],selection[i]]=[selection[i],selection[i-1]]; saveSelection(); } }
function moveDown(i){ if(i<selection.length-1){ [selection[i+1],selection[i]]=[selection[i+1],selection[i]]; saveSelection(); } }
function removeExercise(i){ selection.splice(i,1); saveSelection(); }
function saveSelection(){ localStorage.setItem('tj-selection',JSON.stringify(selection)); renderSelection(); }
function clearSelection(){ if(confirm("Vider la sÃ©lection ?")){ selection=[]; saveSelection(); } }

/* ===== ENTRAÃŽNEMENT ===== */
function startSession(){
 if(!selection.length){ alert("SÃ©lectionnez des exercices"); return; }
 const baseName=document.getElementById('sessionName').value || "SÃ©ance";
 const name=baseName+" â€“ "+new Date().toLocaleString();
 const sessionId=Date.now().toString();
 currentSessionId=sessionId; currentSessionName=name;
 sessions[sessionId]={
   id:sessionId,
   name:name,
   date:new Date().toLocaleString(),
   week:weekKey(),
   exercises:selection.map(e=>({...e,doneMinutes:0})),
   notes:document.getElementById('notes').value
 };
 localStorage.setItem('tj-sessions',JSON.stringify(sessions));
 seqIndex=0; paused=false;
 speak("CommenÃ§ons l'entraÃ®nement", nextExercise);
 document.getElementById('pauseBtn').disabled=false;
}

function nextExercise(){
 if(seqIndex>=selection.length){
   document.getElementById('evalNotes').value=document.getElementById('notes').value;
   buildSelfEvaluation(); document.getElementById('evalModal').style.display='flex'; return;
 }
 const ex=selection[seqIndex];
 document.getElementById('exerciseName').textContent=ex.name;
 if(fullscreen) document.getElementById('trainingOverlay').style.display='flex';
 selection.forEach((e,i)=>{ const el=document.querySelectorAll('.exercise.selected')[i]; el.classList.toggle('active',i===seqIndex); });
 speak(`Exercice ${seqIndex+1} : ${ex.name}`,()=>{
   setTimeout(()=>{
     document.getElementById('beep').play();
     remainingTime=ex.duration*60;
     clearInterval(timer);
     timer=setInterval(()=>{
       if(!paused){
         remainingTime--;
         document.getElementById('timer').textContent=formatTime(remainingTime);
         updateProgress();
         if(remainingTime<=0){
           clearInterval(timer);
           selection[seqIndex].doneMinutes=ex.duration;
           sessions[currentSessionId].exercises[seqIndex].doneMinutes=ex.duration;
           localStorage.setItem('tj-sessions',JSON.stringify(sessions));
           renderGoals();
           selection.forEach((e,i)=>{ const el=document.querySelectorAll('.exercise.selected')[i]; if(i===seqIndex){ el.classList.remove('active'); el.classList.add('done'); }});
           speak("Fin de l'exercice",()=>{ seqIndex++; nextExercise(); });
         }
       }
     },1000);
   },2000);
 });
}

function updateProgress(){
 if(!selection.length) return;
 let done=seqIndex;
 if(seqIndex<selection.length && document.getElementById('timer').textContent){
   const ex=selection[seqIndex];
   const t=parseInt(document.getElementById('timer').textContent.split(':')[0])*60+parseInt(document.getElementById('timer').textContent.split(':')[1]);
   done += (ex.duration*60-t)/(ex.duration*60);
 }
 document.getElementById('progress').value=(done/selection.length)*100;
 document.getElementById('sessionProgress').value=(done/selection.length)*100;
}

function togglePause(){ paused=!paused; document.getElementById('pauseBtn').textContent=paused?"â–¶ï¸ Reprendre":"â¸ï¸ Pause"; }

function finishEvaluation(){
 selection.forEach(ex=>{
   const stored=sessions[currentSessionId].exercises.find(e=>e.name===ex.name);
   if(stored) stored.selfEval=ex.selfEval||3;
 });
 const finalNotes=document.getElementById('evalNotes').value;
 document.getElementById('notes').value=finalNotes;
 sessions[currentSessionId].notes=finalNotes;
 sessions[currentSessionId].date=new Date().toLocaleString();
 localStorage.setItem('tj-sessions',JSON.stringify(sessions));
 renderGoals();
 document.getElementById('evalModal').style.display='none';
 speak("Fin de l'entraÃ®nement, Ã  bientÃ´t !");
}

/* ===== PLEIN Ã‰CRAN ===== */
function toggleFullscreen(){ fullscreen=!fullscreen; document.getElementById('trainingOverlay').style.display=fullscreen?'flex':'none'; }

/* ===== HISTORIQUE ===== */
function showHistory(){
 const modal=document.getElementById('modal'); modal.style.display='flex';
 const h=document.getElementById('historyList'); h.innerHTML='';
 for(const id in sessions){
   const s=sessions[id];
   let div=document.createElement('div'); div.className='history-item';
   let html=`<strong>${s.name}</strong> (${s.date})<br>`;
   if(s.exercises && s.exercises.length) s.exercises.forEach(e=>{ html+=`- ${e.name}: ${e.doneMinutes || 0} min<br>`; });
   html+=`Notes: ${s.notes||''}<br><br>`;
   div.innerHTML=html;
   h.appendChild(div);
 }
}
function closeModal(){ document.getElementById('modal').style.display='none'; }

/* ===== AUTO-EVALUATION ===== */
function buildSelfEvaluation(){
 const container=document.getElementById('selfEvalContainer');
 container.innerHTML='';
 selection.forEach(ex=>{
   const div=document.createElement('div'); div.style.marginBottom='0.8rem';
   div.innerHTML=`<strong>${ex.name}</strong><br><input type="range" min="1" max="5" value="${ex.selfEval || 3}" step="1"><span>${ex.selfEval || 3}</span>/5`;
   const slider=div.querySelector('input'); const label=div.querySelector('span');
   slider.oninput=()=>{ label.textContent=slider.value; ex.selfEval=parseInt(slider.value); };
   container.appendChild(div);
 });
}

/* ===== INIT ===== */
renderBank(); renderSelection(); renderGoals();
</script>
