<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>PrÃ©paration 2Ã¨me Dan â€“ Kata</title>

  <!-- Material Icons + Police Spicy -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  
  <!-- IMPORTANT : Ajout de la bibliothÃ¨que PapaParse -->
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>

  <link rel="stylesheet" href="style-ippon.css">
  <link rel="stylesheet" href="../banner.css">
</head>

<body data-title="Ippon kumite â€“ EntraÃ®nement">

  <div id="bannerContainer"></div>

<script>
fetch("../banner.html")
  .then(r => r.text())
  .then(html => {
    document.getElementById("bannerContainer").innerHTML = html;

    // 1) prioritÃ© : data-title sur <body>
    let pageTitle =
      document.body.dataset.title ||
      document.querySelector("h1")?.textContent ||
      document.querySelector("title")?.textContent ||
      "";

    const target = document.querySelector(".header-text .title");
    if (target && pageTitle) {
      target.textContent = pageTitle;
    }
  });
</script>

  <div id="bannerContainer"></div>

<!-- Boutons fiches PDF sous la banniÃ¨re -->
<div class="container" style="text-align:center; margin-bottom:20px;">
  <button onclick="window.open('tai/fiche1.pdf','_blank')">Fiche 1</button>
  <button onclick="window.open('tai/fiche2.pdf','_blank')">Fiche 2</button>
  <button onclick="window.open('tai/fiche3.pdf','_blank')">Fiche 3</button>
  <button onclick="window.open('tai/fiche4.pdf','_blank')">Fiche 4</button>
  <button onclick="window.open('tai/fiche5.pdf','_blank')">Fiche 5</button>
</div>

<div class="container">
<div class="grid">

<!-- ============ ENCARt 1 ================= -->
<div class="card">
  <h3>ğŸ“š Techniques dÃ©taillÃ©es</h3>
  SÃ©rie :
  <select id="fSerie"></select>
  CÃ´tÃ© :
  <select id="fCote"><option value="">Tous</option><option value="gauche">Gauche</option><option value="droite">Droite</option></select>
  <div id="encart1note" class="state">ğŸ” Choisis une sÃ©rie et/ou un cÃ´tÃ©</div>
  <div id="encart1"></div>
</div>

<!-- ============ ENCARt 2 ================= -->
<div class="card">
  <h3>ğŸ¤ EntraÃ®nement vocal (sÃ©ries complÃ¨tes)</h3>
  SÃ©rie :
  <select id="serieSelect"></select><br><br>
  RÃ©pÃ©ter :
  <input type="number" id="repeatCount" value="1" min="1" max="20"><br><br>
  â±ï¸ Intervalle entre assauts :
  <input type="range" id="tempo" min="5" max="60" value="8"><span id="tempoValue">8</span>s<br><br>
  Voix :
  <select id="voiceType"><option value="female">FÃ©minine</option><option value="male">Masculine</option></select><br><br>
  <button id="startBtn">â–¶ï¸ Lancer</button>
  <button id="pauseBtn">â¸ï¸ Pause</button>
  <button id="stopBtn">â›” Stop</button>
  <div id="vocalState" class="state">â›” En attente</div>
  <div class="output" id="displayText"></div>
</div>

<!-- ============ ENCARt 3 ================= -->
<div class="card">
  <h3>ğŸ–¼ï¸ Fiches PNG</h3>
  CÃ´tÃ© :
  <select id="filterSide">
    <option value="all">Tous</option>
    <option value="gauche">Gauche</option>
    <option value="droite">Droite</option>
  </select>
  Technique :
  <select id="filterTech">
    <option value="all">Toutes</option>
  </select>
  <div id="ficheZone"></div>
</div>

<!-- ============ ENCARt 4 ================= -->
<div class="card">
  <h3>ğŸ§ EntraÃ®nement alÃ©atoire continu</h3>
  Rythme :
  <input type="range" id="randTempo" min="3" max="60" value="6"><span id="randTempoValue">6</span>s<br><br>
  <button id="randStart">ğŸš€ DÃ©marrer</button>
  <button id="randStop">ğŸ›‘ ArrÃªter</button>
  <div id="randState" class="state">â›” arrÃªt</div>
  <div class="output" id="randDisplay"></div>
</div>

</div>
</div>

<script>
/* ---------------- SPEECH ---------------- */
function speak(text, lang="fr-FR", gender="female"){
  if(!text) return;
  const u=new SpeechSynthesisUtterance(text);
  u.lang=lang;
  const voices=speechSynthesis.getVoices();
  const found=voices.find(v=>gender==="female"?v.name.toLowerCase().includes("f"):v.name.toLowerCase().includes("m"));
  if(found) u.voice=found;
  speechSynthesis.speak(u);
}

/* ------------ ENCARt 1 -------------------- */
let baseData=[];
fetch("ippon.json").then(r=>r.json()).then(data=>{
  baseData=data;
  const s=[...new Set(data.map(x=>x.serie))];
  const sel=document.getElementById("fSerie");
  sel.innerHTML=`<option value="">Toutes</option>`;
  s.forEach(v=>sel.innerHTML+=`<option value="${v}">SÃ©rie ${v}</option>`);
});

function refreshEncart1(){
  const serie=document.getElementById("fSerie").value;
  const cote=document.getElementById("fCote").value;
  const zone=document.getElementById("encart1");
  zone.innerHTML="";
  let list=baseData;
  if(serie) list=list.filter(x=>x.serie==serie);
  if(cote) list=list.filter(x=>x.cote==cote);
  if(list.length===0){ encart1note.innerText="ğŸ©· Aucun rÃ©sultat"; return;}
  encart1note.innerText="âœ”ï¸ rÃ©sultats affichÃ©s";
  list.forEach(t=>{
    zone.innerHTML+=`
      <div class="accordion-item">
        <div class="accordion-title">${t.attaque} â€” ${t.cote}</div>
        <div class="accordion-content">
          Tai sabaki : ${t["tai sabaki"]}<br>
          Blocage : ${t.blocage}<br>
          DÃ©fense : ${t.defense}<br>
          <iframe width="100%" height="190" src="${t.video}" allowfullscreen></iframe>
        </div>
      </div>`;
  });
  document.querySelectorAll("#encart1 .accordion-title").forEach(t=>{
    t.onclick=()=>{ let c=t.nextElementSibling; c.style.display=c.style.display==="block"?"none":"block"; };
  });
}
document.getElementById("fSerie").onchange=refreshEncart1;
document.getElementById("fCote").onchange=refreshEncart1;

/* ------------ ENCARt 2 -------------------- */
let vocalData=[];
let playing=false, paused=false, timerId=null;
fetch("ipponvocal.json").then(r=>r.json()).then(data=>{
  vocalData=data;
  const s=[...new Set(data.map(x=>x["SÃ©rie"]))];
  s.forEach(v=>serieSelect.innerHTML+=`<option value="${v}">SÃ©rie ${v}</option>`);
});

tempo.oninput=e=>tempoValue.innerText=e.target.value;

startBtn.onclick=()=>{
  if(!serieSelect.value) return alert("Choisis une sÃ©rie");
  vocalState.innerText="â–¶ï¸ lecture en cours";
  playing=true; paused=false;
  const serie=parseInt(serieSelect.value);
  const delay=parseInt(tempo.value)*1000;
  const repeat=parseInt(repeatCount.value);
  const gender=voiceType.value;
  const G=vocalData.filter(x=>x["SÃ©rie"]===serie && x["CÃ´tÃ©"]==="gauche");
  const D=vocalData.filter(x=>x["SÃ©rie"]===serie && x["CÃ´tÃ©"]==="droit");

  let seq=[];
  for(let n=0;n<repeat;n++){
    seq.push({type:"fr",text:"CommenÃ§ons l'entraÃ®nement",wait:5000});
    seq.push({type:"fr",text:"cÃ´tÃ© gauche",wait:2000});
    G.forEach(t=>{
      seq.push({type:"ja",text:t.Assaut,wait:3000});
      seq.push({type:"ja",text:t.blocage,wait:3000});
      seq.push({type:"ja",text:t.contre,wait:delay});
    });
    seq.push({type:"fr",text:"cÃ´tÃ© droit",wait:3000});
    D.forEach(t=>{
      seq.push({type:"ja",text:t.Assaut,wait:3000});
      seq.push({type:"ja",text:t.blocage,wait:3000});
      seq.push({type:"ja",text:t.contre,wait:delay});
    });
  }
  seq.push({type:"fr",text:"fin de l'entraÃ®nement",wait:0});

  let i=0;
  function step(){
    if(!playing) return;
    if(paused){timerId=setTimeout(step,300); return;}
    const e=seq[i++];
    displayText.innerText=e.text;
    speak(e.text,e.type==="ja"?"ja-JP":"fr-FR",gender);
    if(i<seq.length) timerId=setTimeout(step,e.wait);
    else { playing=false; vocalState.innerText="âœ”ï¸ terminÃ©"; }
  }
  setTimeout(step,5000);
};

pauseBtn.onclick=()=>{
  if(!playing) return;
  paused=!paused;
  paused?(vocalState.innerText="â¸ï¸ en pause", speechSynthesis.pause())
        :(vocalState.innerText="â–¶ï¸ lecture en cours", speechSynthesis.resume());
};
stopBtn.onclick=()=>{
  playing=false; paused=false; clearTimeout(timerId); speechSynthesis.cancel();
  vocalState.innerText="â›” arrÃªtÃ©"; displayText.innerText="";
};

/* ------------ ENCARt 3 -------------------- */
let ficheData=[
  {Assaut:"OÃ¯ tsuki jodan",CÃ´tÃ©:"gauche",img:"construction.jpg"},
  {Assaut:"OÃ¯ tsuki chudan",CÃ´tÃ©:"gauche",img:"construction.jpg"},
  {Assaut:"Mae geri",CÃ´tÃ©:"gauche",img:"construction.jpg"},
  {Assaut:"Mawashi geri",CÃ´tÃ©:"gauche",img:"construction.jpg"},
  {Assaut:"Yoko geri",CÃ´tÃ©:"gauche",img:"construction.jpg"},
  {Assaut:"OÃ¯ tsuki jodan",CÃ´tÃ©:"droite",img:"construction.jpg"},
  {Assaut:"OÃ¯ tsuki chudan",CÃ´tÃ©:"droite",img:"construction.jpg"},
  {Assaut:"Mae geri",CÃ´tÃ©:"droite",img:"construction.jpg"},
  {Assaut:"Mawashi geri",CÃ´tÃ©:"droite",img:"construction.jpg"},
  {Assaut:"Yoko geri",CÃ´tÃ©:"droite",img:"construction.jpg"}
];

const techSet=[...new Set(ficheData.map(x=>x.Assaut))];
const filterTech=document.getElementById("filterTech");
techSet.forEach(t=>filterTech.innerHTML+=`<option value="${t}">${t}</option>`);

function refreshFiches(){
  const cote=document.getElementById("filterSide").value;
  const tech=document.getElementById("filterTech").value;
  const zone=document.getElementById("ficheZone");
  zone.innerHTML="";
  let list=ficheData;
  if(cote!=="all") list=list.filter(x=>x.CÃ´tÃ©===cote);
  if(tech!=="all") list=list.filter(x=>x.Assaut===tech);
  if(list.length===0) zone.innerHTML="ğŸ©· Aucun rÃ©sultat";
  list.forEach(f=>{
    zone.innerHTML+=`
      <div class="accordion-item">
        <div class="accordion-title">${f.Assaut} â€” ${f.CÃ´tÃ©}</div>
        <div class="accordion-content">
          <img src="${f.img}" class="fiche-img">
        </div>
      </div>`;
  });
  document.querySelectorAll("#ficheZone .accordion-title").forEach(t=>{
    t.onclick=()=>{ let c=t.nextElementSibling; c.style.display=c.style.display==="block"?"none":"block"; };
  });
}
document.getElementById("filterSide").onchange=refreshFiches;
document.getElementById("filterTech").onchange=refreshFiches;
refreshFiches();

/* ------------ ENCARt 4 ALEATOIRE -------------------- */
randTempo.oninput=e=>randTempoValue.innerText=e.target.value;

let run=false;
randStart.onclick=()=>{
  run=true;
  randState.innerText="â–¶ï¸ en cours";
  function loop(){
    if(!run) return;
    const tech=["Oi tsuki jodan Ã  gauche","Mae geri Ã  gauche","Mawashi geri Ã  gauche","Yoko geri Ã  gauche","Oi tsuki chudan Ã  gauche","Oi tsuki jodan Ã  droite","Mae geri Ã  droite","Mawashi geri Ã  droite","yoko geri Ã  droite", "Oi tsuki chudan Ã  droite"];
    const t=tech[Math.floor(Math.random()*tech.length)];
    randDisplay.innerText=t;
    speak(t,"fr-FR"); // voix franÃ§aise
    setTimeout(loop,randTempo.value*1000);
  }
  setTimeout(loop,1000);
};
randStop.onclick=()=>{
  run=false;
  randDisplay.innerText="";
  randState.innerText="â›” arrÃªt";
  speechSynthesis.cancel();
};
</script>
</body>
</html>
