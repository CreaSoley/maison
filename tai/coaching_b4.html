<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coach Tai Jitsu ‚Äì S√©ance + √âvaluation</title>
<style>
body { font-family: system-ui,sans-serif; margin:0; background:linear-gradient(to right,#ffecd2,#fcb69f);}
h1 { text-align:center; padding:1rem; }
.container { max-width:1100px; margin:auto; padding:1rem; display:grid; grid-template-columns:1fr 1fr; gap:1rem;}
.panel { background:#fff; border-radius:16px; padding:1rem; box-shadow:0 6px 14px rgba(0,0,0,.15);}
.uv { margin-bottom:1rem; }
.exercise { display:flex; justify-content:space-between; align-items:center; padding:.5rem .7rem; border-radius:10px; margin:.3rem 0; background:#f5f5f5;}
.exercise.selected { background:#d1f5d3; }
.exercise.active { background:#ffe8b3; }
.exercise.done { text-decoration:line-through; opacity:.6; }
.exercise button { border:none; border-radius:8px; padding:.3rem .6rem; cursor:pointer; font-size:1rem; }
.controls { margin-top:.8rem; display:flex; gap:.5rem; flex-wrap:wrap; }
input[type=text] { width:100%; padding:.6rem; border-radius:10px; border:1px solid #ccc; margin-bottom:.5rem; }
input[type=range]{ width:120px; margin-left:.5rem; }
#progress { width:100%; height:16px; margin-top:.8rem; }
/* Overlay plein √©cran */
#trainingOverlay { display:none; position:fixed; inset:0; background:linear-gradient(to right,#84fab0,#8fd3f4); z-index:999; flex-direction:column; justify-content:center; align-items:center; color:#000; font-family:system-ui,sans-serif;}
#trainingOverlay h1 { font-size:3rem; margin-bottom:1rem; }
#trainingOverlay #timer { font-size:4rem; margin-bottom:1rem; }
#trainingOverlay progress { width:80%; height:24px; }
#trainingOverlay button { margin-top:2rem;padding:1rem 2rem;font-size:1.2rem;border-radius:12px; cursor:pointer; }
textarea { width:100%; border-radius:12px; padding:.6rem; margin-top:.5rem; }
label{ font-weight:bold; display:block; margin-top:.5rem; }
.emoji-btn{ font-size:1.5rem; cursor:pointer; margin-right:.5rem; }
.selected-emoji{ border:2px solid #333; border-radius:6px; }
.history-item{ border-bottom:1px solid #ccc; padding:.3rem 0; }
</style>
</head>
<body>
<h1>ü•ã Coach Tai Jitsu ‚Äì S√©ance + √âvaluation</h1>

<div class="container">
  <!-- BANQUE -->
  <div class="panel">
    <h2>üìö Banque d'exercices</h2>
    <div id="bank"></div>
  </div>

  <!-- S√âLECTION + NOTES + CONTROLS -->
  <div class="panel">
    <h2>üìù S√©ance s√©lectionn√©e</h2>
    <input type="text" id="sessionName" placeholder="Nom de la s√©ance">
    <div id="selection"></div>
    <label>Carnet de notes :</label>
    <textarea id="notes" rows="3" placeholder="Ressenti du jour..."></textarea>
    <div class="controls">
      <button onclick="saveSession()">üíæ Sauvegarder la s√©ance</button>
      <button onclick="clearSelection()">üßπ Vider la s√©lection</button>
      <button onclick="startSession()">‚ñ∂Ô∏è Commencer entra√Ænement</button>
      <button onclick="toggleFullscreen()">üì± Plein √©cran</button>
      <button onclick="showHistory()">üìä Historique</button>
    </div>
    <progress id="progress" value="0" max="100"></progress>
  </div>
</div>

<!-- Overlay plein √©cran exercice -->
<div id="trainingOverlay">
  <h1 id="exerciseName">Exercice</h1>
  <div id="timer">00:00</div>
  <progress id="sessionProgress" value="0" max="100"></progress>
  <button onclick="toggleFullscreen()">‚ùå Quitter plein √©cran</button>
</div>

<!-- Modal historique et √©valuation -->
<div id="modal" style="display:none; position:fixed; inset:0;background:rgba(0,0,0,0.6); color:#000; z-index:1000; justify-content:center; align-items:center; padding:1rem; overflow:auto;">
  <div style="background:#fff; border-radius:16px; padding:1rem; max-width:600px; width:100%;">
    <h2>üìã Historique & √âvaluation</h2>
    <div id="historyList"></div>
    <button onclick="closeModal()" style="margin-top:1rem;">‚ùå Fermer</button>
  </div>
</div>

<audio id="beep" src="beep.mp3"></audio>
<audio id="ding" src="ding.mp3"></audio>

<script>
/* ------------------ BANQUE ------------------ */
const bankData = [
  { uv:'ü•ã UV 1 ‚Äì Kihon', items:['Kihon simple','Encha√Ænement de kihon','Cibles'], criteria:['Pr√©cision','R√©activit√©','Posture'] },
  { uv:'üåÄ UV 2 ‚Äì D√©placements', items:['Ta√Ø sabaki','Slow ippon','Ippon kumite'], criteria:['Fluidit√©','√âquilibre','Contr√¥le'] },
  { uv:'üìê UV 3 ‚Äì Kata', items:['Slow kata','Kata nidan','Bunka√Ø'], criteria:['Exactitude','Ma√Ætrise','Kime'] },
  { uv:'‚öôÔ∏è UV 4 ‚Äì Technique de base', items:['Shadow'], criteria:['R√©alisme','Zanchin','Protection'] },
  { uv:'üî• UV 5 & 6 ‚Äì Randori', items:['Randori shadow'], criteria:['R√©alisme','Zanchin','Protection'] }
];

/* ------------------ √âTAT ------------------ */
let selection = JSON.parse(localStorage.getItem('tj-selection')) || [];
let sessions  = JSON.parse(localStorage.getItem('tj-sessions')) || {};
let seqIndex = 0, timer=null, fullscreen=false;

/* ------------------ RENDER BANQUE ------------------ */
function renderBank(){
  const bank=document.getElementById('bank'); bank.innerHTML='';
  bankData.forEach(u=>{
    const div=document.createElement('div'); div.className='uv'; div.innerHTML=`<h3>${u.uv}</h3>`;
    u.items.forEach(name=>{
      const ex=document.createElement('div'); ex.className='exercise';
      ex.innerHTML=`<span>${name}</span> <button onclick="addExercise('${u.uv}','${name}')">‚ûï</button>`;
      div.appendChild(ex);
    });
    bank.appendChild(div);
  });
}

/* ------------------ RENDER S√âLECTION ------------------ */
function renderSelection(){
  const sel=document.getElementById('selection'); sel.innerHTML='';
  if(selection.length===0){ sel.innerHTML='<em>Aucun exercice s√©lectionn√©</em>'; return;}
  selection.forEach((ex,i)=>{
    const d=document.createElement('div'); d.className='exercise selected';
    let criteria=bankData.find(u=>u.uv===ex.uv).criteria.join(', ');
    d.innerHTML=`
      <span>${ex.uv} ‚Äì ${ex.name}</span>
      <div>
        <input type="range" min="1" max="60" value="${ex.duration}" oninput="updateDuration(${i},this.value)">
        <span>${ex.duration} min</span>
        <button onclick="moveUp(${i})">‚¨ÜÔ∏è</button>
        <button onclick="moveDown(${i})">‚¨áÔ∏è</button>
        <button onclick="removeExercise(${i})">‚ùå</button>
        <div style="font-size:.8rem; color:#555;">Crit√®res: ${criteria}</div>
      </div>`;
    sel.appendChild(d);
  });
}

function updateDuration(i,val){ selection[i].duration=parseInt(val); saveSelection(); }

function addExercise(uv,name){ selection.push({uv,name,duration:5}); saveSelection(); }
function removeExercise(i){ selection.splice(i,1); saveSelection(); }
function moveUp(i){ if(i>0){ [selection[i-1],selection[i]]=[selection[i],selection[i-1]]; saveSelection(); }}
function moveDown(i){ if(i<selection.length-1){ [selection[i+1],selection[i]]=[selection[i+1],selection[i]]; saveSelection(); }}
function saveSelection(){ localStorage.setItem('tj-selection',JSON.stringify(selection)); renderSelection(); }
function clearSelection(){ if(confirm('Vider la s√©lection ?')){ selection=[]; saveSelection(); } }

function saveSession(){
  const name=document.getElementById('sessionName').value.trim();
  if(!name){ alert('Nom obligatoire'); return; }
  sessions[name]={exercises:[...selection], notes:document.getElementById('notes').value, evaluation:null, date:new Date().toLocaleString()};
  localStorage.setItem('tj-sessions',JSON.stringify(sessions));
  alert('S√©ance sauvegard√©e ‚úîÔ∏è');
}

/* ------------------ SYNTH√àSE VOCALE & ENTRA√éNEMENT ------------------ */
function speak(txt,cb){ const u=new SpeechSynthesisUtterance(txt); u.onend=cb; speechSynthesis.speak(u); }

function startSession(){
  if(selection.length===0){ alert('S√©lectionnez des exercices'); return;}
  seqIndex=0;
  nextExercise();
}

function toggleFullscreen(){ fullscreen=!fullscreen; document.getElementById('trainingOverlay').style.display=fullscreen?'flex':'none'; }

function nextExercise(){
  if(seqIndex>=selection.length){ endSessionEvaluation(); return;}
  const ex=selection[seqIndex];
  const timerEl=document.getElementById('timer');
  const progressEl=document.getElementById('sessionProgress');
  document.getElementById('exerciseName').textContent=ex.name;
  updateState();
  speak(`Exercice ${seqIndex+1} : ${ex.name}`,()=>{
    setTimeout(()=>{
      document.getElementById('beep').play();
      let t=ex.duration*60; timerEl.textContent=formatTime(t);
      timer=setInterval(()=>{
        t--; timerEl.textContent=formatTime(t);
        progressEl.value=((seqIndex+(ex.duration*60-t)/(ex.duration*60))/selection.length)*100;
        if(t<=0){ clearInterval(timer); document.getElementById('ding').play();
          speak("Fin de l'exercice",()=>{ seqIndex++; setTimeout(nextExercise,1000); });
        }
      },1000);
    },2000);
  });
}

function updateState(){
  document.querySelectorAll('#selection .exercise').forEach((e,i)=>{
    e.classList.toggle('active',i===seqIndex);
    e.classList.toggle('done',i<seqIndex);
  });
}

function formatTime(sec){ const m=Math.floor(sec/60); const s=sec%60; return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; }

/* ------------------ √âVALUATION FINALE ------------------ */
function endSessionEvaluation(){
  // Masquer overlay mais garder l'entra√Ænement termin√©
  fullscreen=false; document.getElementById('trainingOverlay').style.display='none';
  // Cr√©er interface √©valuation
  let html='<h3>üìù √âvaluation finale</h3>';
  selection.forEach(ex=>{
    const criteria=bankData.find(u=>u.uv===ex.uv).criteria;
    html+=`<div style="margin-bottom:.5rem;"><strong>${ex.uv} ‚Äì ${ex.name}</strong><br>`;
    criteria.forEach(c=>{
      html+=`${c}: <span class="emoji-btn" onclick="selectEmoji(this,'${ex.name}','${c}')">üòê</span><span class="emoji-btn" onclick="selectEmoji(this,'${ex.name}','${c}')">üòÉ</span><span class="emoji-btn" onclick="selectEmoji(this,'${ex.name}','${c}')">üò°</span><br>`;
    });
    html+='</div>';
  });
  html+='<button onclick="saveEvaluation()">üíæ Enregistrer √©valuation</button>';
  const modal=document.getElementById('modal'); modal.style.display='flex'; document.getElementById('historyList').innerHTML=html;
}

/* Stockage temporaire des √©valuations */
let tempEvaluation={};
function selectEmoji(el,exName,crit){ 
  if(!tempEvaluation[exName]) tempEvaluation[exName]={};
  tempEvaluation[exName][crit]=el.textContent;
  // marquer s√©lection
  Array.from(el.parentNode.children).forEach(sib=>sib.classList.remove('selected-emoji'));
  el.classList.add('selected-emoji');
}

function saveEvaluation(){
  const name=document.getElementById('sessionName').value.trim();
  if(!name){ alert('Nom obligatoire'); return;}
  if(!sessions[name]) sessions[name]={exercises:[...selection], notes:document.getElementById('notes').value};
  sessions[name].evaluation=tempEvaluation;
  sessions[name].date=new Date().toLocaleString();
  localStorage.setItem('tj-sessions',JSON.stringify(sessions));
  alert('√âvaluation enregistr√©e ‚úîÔ∏è');
  tempEvaluation={};
  document.getElementById('modal').style.display='none';
}

/* ------------------ HISTORIQUE ------------------ */
function showHistory(){
  let html='<h3>üìä Historique des s√©ances</h3>';
  for(const name in sessions){
    const s=sessions[name];
    html+=`<div class="history-item"><strong>${name}</strong> (${s.date})<br>`;
    html+=`Notes: ${s.notes}<br>`;
    if(s.evaluation){
      html+=`√âvaluation:<br>`;
      for(const ex in s.evaluation){
        html+=`${ex}: `;
        for(const c in s.evaluation[ex]) html+=`${c}=${s.evaluation[ex][c]} `;
        html+='<br>';
      }
    }
    html+='</div>';
  }
  const modal=document.getElementById('modal'); modal.style.display='flex';
  document.getElementById('historyList').innerHTML=html;
}

function closeModal(){ document.getElementById('modal').style.display='none'; }

/* ------------------ INIT ------------------ */
renderBank(); renderSelection();
</script>
</body>
</html>
