<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Coach Tai Jitsu ‚Äì 2e Dan</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      min-height: 100vh;
      background-image: linear-gradient(to right, #ffecd2 0%, #fcb69f 100%);
    }
    h1 {
      text-align: center;
      padding: 1rem;
    }
    .container {
      max-width: 900px;
      margin: auto;
      padding: 1rem;
    }
    .uv {
      background: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);
      border-radius: 20px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }
    .uv h2 {
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    .exercise {
      background: #fff;
      border-radius: 15px;
      padding: .75rem;
      margin: .5rem 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 10px rgba(0,0,0,.1);
    }
    .exercise.dragging { opacity: .5; }
    .controls button {
      border: none;
      border-radius: 50px;
      padding: .6rem 1.2rem;
      margin: .2rem;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,.2);
    }
    .controls button.active {
      background: #84fab0;
      color: #000;
    }
    .status {
      background: #fff;
      border-radius: 20px;
      padding: 1rem;
      margin-top: 1rem;
      box-shadow: 0 6px 12px rgba(0,0,0,.15);
    }
    .highlight {
      background: #ffe0f0 !important;
    }
    textarea {
      width: 100%;
      border-radius: 15px;
      padding: .75rem;
      border: none;
      box-shadow: inset 0 2px 6px rgba(0,0,0,.15);
    }
  </style>
</head>
<body>
<h1>ü•ã Coach Tai Jitsu ‚Äì Passage 2e Dan</h1>
<div class="container" id="app"></div>

<audio id="beep" src="beep.mp3"></audio>
<audio id="ding" src="ding.mp3"></audio>

<script>
const synth = window.speechSynthesis;

const data = JSON.parse(localStorage.getItem('tj-exercises')) || [
  { uv: 'ü•ã UV 1 ‚Äì Kihon', items: [
    { name: 'Kihon simple', duration: 15 },
    { name: 'Encha√Ænement de kihon', duration: 20 },
    { name: 'Cibles', duration: 10 }
  ]},
  { uv: 'üåÄ UV 2 ‚Äì D√©placements', items: [
    { name: 'Ta√Ø sabaki', duration: 10 },
    { name: 'Slow ippon', duration: 10 },
    { name: 'Ippon kumite', duration: 10 }
  ]},
  { uv: 'üìê UV 3 ‚Äì Kata', items: [
    { name: 'Slow kata', duration: 10 },
    { name: 'Kata nidan', duration: 10 },
    { name: 'Bunka√Ø', duration: 5 }
  ]},
  { uv: '‚öôÔ∏è UV 4 ‚Äì Technique de base', items: [
    { name: 'Shadow', duration: 10 }
  ]},
  { uv: 'üî• UV 5 & 6 ‚Äì Randori', items: [
    { name: 'Shadow randori', duration: 10 }
  ]}
];

let sequence = [];
let currentIndex = 0;
let timer = null;
let remaining = 0;

function render() {
  const app = document.getElementById('app');
  app.innerHTML = '';
  data.forEach((uv, uvi) => {
    const block = document.createElement('div');
    block.className = 'uv';
    block.innerHTML = `<h2>${uv.uv}</h2>`;
    uv.items.forEach((ex, exi) => {
      const div = document.createElement('div');
      div.className = 'exercise';
      div.draggable = true;
      div.innerHTML = `
        <span>${ex.name}</span>
        <input type="range" min="1" max="60" value="${ex.duration}" 
          oninput="this.nextElementSibling.textContent=this.value+' min'; data[${uvi}].items[${exi}].duration=this.value; save();" />
        <span>${ex.duration} min</span>`;
      block.appendChild(div);
    });
    app.appendChild(block);
  });

  const controls = document.createElement('div');
  controls.className = 'controls';
  controls.innerHTML = `
    <button onclick="start()">‚ñ∂Ô∏è Lecture</button>
    <button onclick="pause()">‚è∏ Pause</button>
    <button onclick="stop()">‚èπ Stop</button>
    <button onclick="exportCSV()">üíæ Export CSV</button>`;
  app.appendChild(controls);

  const status = document.createElement('div');
  status.className = 'status';
  status.innerHTML = `
    <h3>üìç Suivi de s√©ance</h3>
    <div id="current"></div>
    <h4>üìù Carnet de notes</h4>
    <textarea rows="4" placeholder="Ressenti du jour..." onblur="saveNote(this.value)">${localStorage.getItem('tj-note')||''}</textarea>
    <h4>‚≠ê √âvaluation</h4>
    Kime üí• <input type="range" min="1" max="5" />
    Zanshin üëÄ <input type="range" min="1" max="5" />
    R√©activit√© ‚ö° <input type="range" min="1" max="5" />
  `;
  app.appendChild(status);
}

function speak(text, delay=0) {
  setTimeout(() => {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'fr-FR';
    synth.speak(u);
  }, delay);
}

function buildSequence() {
  sequence = [];
  data.forEach(uv => uv.items.forEach(ex => sequence.push(ex)));
}

function start() {
  buildSequence();
  currentIndex = 0;
  speak('Commen√ßons la s√©ance');
  setTimeout(runExercise, 1000);
}

function runExercise() {
  if (currentIndex >= sequence.length) {
    speak("Fin de l'entra√Ænement, √† bient√¥t !");
    return;
  }
  const ex = sequence[currentIndex];
  document.getElementById('beep').play();
  speak(`Exercice ${currentIndex+1} : ${ex.name}`);
  remaining = ex.duration * 60;
  updateStatus(ex);
  timer = setInterval(() => {
    remaining--;
    updateStatus(ex);
    if (remaining <= 0) {
      clearInterval(timer);
      document.getElementById('ding').play();
      speak('Fin de l\'exercice');
      currentIndex++;
      setTimeout(runExercise, 1000);
    }
  }, 1000);
}

function updateStatus(ex) {
  document.getElementById('current').innerText = `${ex.name} ‚Äì Temps restant : ${Math.floor(remaining/60)}:${String(remaining%60).padStart(2,'0')}`;
}

function pause() {
  clearInterval(timer);
}

function stop() {
  clearInterval(timer);
  currentIndex = 0;
  document.getElementById('current').innerText = 'S√©ance arr√™t√©e';
}

function exportCSV() {
  let csv = 'Exercice;Dur√©e (min)\n';
  sequence.forEach(e => csv += `${e.name};${e.duration}\n`);
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'entrainement_taijitsu.csv';
  a.click();
}

function save() {
  localStorage.setItem('tj-exercises', JSON.stringify(data));
}
function saveNote(v) {
  localStorage.setItem('tj-note', v);
}

render();
</script>
</body>
</html>
