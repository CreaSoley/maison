<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Coach Tai Jitsu â€“ 2e Dan</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: system-ui;
  background: linear-gradient(to right,#ffecd2,#fcb69f);
  margin:0;
}
h1 { text-align:center; }

.container { max-width:900px; margin:auto; padding:1rem; }

.exercise {
  background:white;
  margin:.4rem 0;
  padding:.6rem;
  border-radius:15px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
  cursor:grab;
}
.exercise.done { text-decoration: line-through; opacity:.6; }
.exercise.current { background:#ffe0f0; }

.controls button {
  padding:.6rem 1.2rem;
  margin:.2rem;
  border:none;
  border-radius:20px;
}

.status, .panel {
  background:white;
  border-radius:20px;
  padding:1rem;
  margin-top:1rem;
}

.slider { width:120px; }
.emoji button { font-size:1.4rem; margin:.1rem; }
</style>
</head>

<body>
<h1>ğŸ¥‹ Coach Tai Jitsu â€“ Passage 2e Dan</h1>
<div class="container">

<h3>ğŸ“‹ SÃ©quence</h3>
<div id="list"></div>

<div class="controls">
  <button onclick="start()">â–¶ï¸</button>
  <button onclick="pause()">â¸</button>
  <button onclick="stop()">â¹</button>
</div>

<div class="status">
  <div id="current">En attenteâ€¦</div>
</div>

<div class="panel">
  <h3>ğŸ“ Carnet de notes</h3>
  <textarea id="note" rows="3" placeholder="Ressenti du jour..."></textarea>
</div>

<div class="panel">
  <h3>ğŸ˜€ Ã‰valuation du jour</h3>
  <div id="ratings"></div>
</div>

<div class="panel">
  <h3>ğŸ“Š Total hebdomadaire (minutes)</h3>
  <div id="weekly"></div>
</div>

</div>

<audio id="beep" src="beep.mp3"></audio>
<audio id="ding" src="ding.mp3"></audio>

<script>
/* ================== DATA ================== */

const today = new Date().toISOString().slice(0,10);
const weekKey = new Date().getFullYear() + '-W' + getWeek();

let sequence = JSON.parse(localStorage.getItem('sequence')) || [
 {uv:'UV1', name:'Kihon simple', duration:5},
 {uv:'UV1', name:'EnchaÃ®nement kihon', duration:5},
 {uv:'UV2', name:'Tai sabaki', duration:5},
 {uv:'UV3', name:'Slow kata', duration:5}
];

let done = [];
let currentIndex = 0;
let remaining = 0;
let timer = null;
let running = false;

/* ================== RENDER ================== */

function render(){
  const list = document.getElementById('list');
  list.innerHTML='';

  sequence.forEach((ex,i)=>{
    const div = document.createElement('div');
    div.className='exercise';
    if(done.includes(i)) div.classList.add('done');
    if(i===currentIndex && running) div.classList.add('current');
    div.draggable=true;
    div.dataset.index=i;

    div.innerHTML=`
      <span>â˜° ${ex.uv} â€“ ${ex.name}</span>
      <input class="slider" type="range" min="1" max="60" value="${ex.duration}">
      <span>${ex.duration} min</span>
    `;

    const slider = div.querySelector('input');
    slider.oninput=()=>{
      ex.duration=+slider.value;
      div.querySelector('span:last-child').textContent=slider.value+' min';
      persist();
    };

    div.addEventListener('dragstart',e=>e.dataTransfer.setData('i',i));
    div.addEventListener('dragover',e=>e.preventDefault());
    div.addEventListener('drop',e=>{
      const from=+e.dataTransfer.getData('i');
      const moved=sequence.splice(from,1)[0];
      sequence.splice(i,0,moved);
      persist(); render();
    });

    list.appendChild(div);
  });
}

render();

/* ================== PLAYER ================== */

function speak(t){
  const u=new SpeechSynthesisUtterance(t);
  u.lang='fr-FR'; speechSynthesis.speak(u);
}

function start(){
  if(running) return;
  running=true;
  if(remaining===0){
    speak('CommenÃ§ons la sÃ©ance');
    setTimeout(run,1000);
  } else runTimer();
}

function run(){
  if(currentIndex>=sequence.length){
    speak('Fin de lâ€™entraÃ®nement, Ã  bientÃ´t');
    stop(); return;
  }
  const ex=sequence[currentIndex];
  remaining=ex.duration*60;
  document.getElementById('beep').play();
  speak(`Exercice ${currentIndex+1} : ${ex.name}`);
  runTimer();
}

function runTimer(){
  timer=setInterval(()=>{
    remaining--;
    document.getElementById('current').textContent=
      `${sequence[currentIndex].name} â€“ ${Math.floor(remaining/60)}:${String(remaining%60).padStart(2,'0')}`;

    if(remaining<=0){
      clearInterval(timer);
      document.getElementById('ding').play();
      logTime(sequence[currentIndex]);
      done.push(currentIndex);
      currentIndex++; run();
    }
    render();
  },1000);
}

function pause(){ clearInterval(timer); running=false; }
function stop(){ clearInterval(timer); running=false; remaining=0; currentIndex=0; done=[]; render(); }

/* ================== NOTES & RATINGS ================== */

const criteria=['Kime ğŸ’¥','Zanshin ğŸ‘€','Maai ğŸ“','RÃ©activitÃ© âš¡'];

function renderRatings(){
  const r=document.getElementById('ratings');
  const saved=JSON.parse(localStorage.getItem('ratings-'+today))||{};
  r.innerHTML='';
  criteria.forEach(c=>{
    const d=document.createElement('div');
    d.innerHTML=`${c} `;
    for(let i=1;i<=5;i++){
      const b=document.createElement('button');
      b.textContent='ğŸ˜€';
      if(saved[c]===i) b.style.opacity=1;
      b.onclick=()=>{ saved[c]=i; localStorage.setItem('ratings-'+today,JSON.stringify(saved)); };
      d.appendChild(b);
    }
    r.appendChild(d);
  });
}
renderRatings();

const note=document.getElementById('note');
note.value=localStorage.getItem('note-'+today)||'';
note.onblur=()=>localStorage.setItem('note-'+today,note.value);

/* ================== WEEKLY ================== */

function logTime(ex){
  const w=JSON.parse(localStorage.getItem('week-'+weekKey))||{};
  w[ex.name]=(w[ex.name]||0)+ex.duration;
  localStorage.setItem('week-'+weekKey,JSON.stringify(w));
  renderWeekly();
}

function renderWeekly(){
  const w=JSON.parse(localStorage.getItem('week-'+weekKey))||{};
  const d=document.getElementById('weekly');
  d.innerHTML='';
  Object.entries(w).forEach(([k,v])=>{
    d.innerHTML+=`${k} : ${v} min<br>`;
  });
}
renderWeekly();

/* ================== UTILS ================== */

function persist(){ localStorage.setItem('sequence',JSON.stringify(sequence)); }

function getWeek(){
  const d=new Date(); d.setHours(0,0,0,0);
  d.setDate(d.getDate()+4-(d.getDay()||7));
  const y=new Date(d.getFullYear(),0,1);
  return Math.ceil((((d-y)/86400000)+1)/7);
}
</script>
</body>
</html>
