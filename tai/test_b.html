<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ¥‹ EntraÃ®nement KaratÃ©</title>

<style>
:root{
 --grad:linear-gradient(120deg,#84fab0,#8fd3f4);
}
body{margin:0;font-family:system-ui;background:#f5f5f5}
header{text-align:center;padding:14px;background:var(--grad)}
.container{padding:16px;max-width:900px;margin:auto}

button{
 padding:12px 18px;border:none;border-radius:18px;
 margin:6px;font-size:16px;
 box-shadow:0 4px 8px rgba(0,0,0,.2)
}
.primary{background:#84fab0}
.warn{background:#ffd86f}
.danger{background:#ff8a8a}

ul{list-style:none;padding:0}
li{
 background:white;margin:10px 0;padding:14px;
 border-radius:16px;
 box-shadow:0 4px 10px rgba(0,0,0,.15)
}
.active{border:3px solid #84fab0}
.done{opacity:.5;text-decoration:line-through}

.progress{height:8px;background:#eee;border-radius:8px;margin-top:6px}
.progress div{height:100%;background:var(--grad)}

.timeline{height:14px;background:#ddd;border-radius:10px}
.timeline div{height:100%;background:var(--grad)}

.modal{
 position:fixed;inset:0;
 background:rgba(0,0,0,.5);
 display:none;
 align-items:center;
 justify-content:center;
 z-index:9999
}
.card{
 background:white;border-radius:18px;
 padding:18px;width:90%;max-width:520px;
 max-height:90%;overflow:auto
}

.smile{font-size:26px;cursor:pointer;padding:6px}
.smile.active{transform:scale(1.3)}

canvas{max-width:100%}
textarea{width:100%}
</style>
</head>

<body>

<header>
<h1>ğŸ¥‹ Carnet dâ€™entraÃ®nement</h1>
<p id="stateLabel">â¹ Inactif</p>
</header>

<div class="container">

<button class="primary" onclick="start()">â–¶ Start / Reprendre</button>
<button class="warn" onclick="pause()">â¸ Pause</button>
<button class="danger" onclick="stop()">â¹ Stop</button>
<button onclick="openEval()">ğŸ“ Auto-Ã©valuation</button>

<h3>Progression globale</h3>
<div class="timeline"><div id="global"></div></div>

<ul id="program"></ul>

<h3>ğŸ“Š Radar (7 jours)</h3>
<canvas id="radar" width="320" height="320"></canvas>

</div>

<!-- MODAL -->
<div class="modal" id="evalModal">
 <div class="card">
  <h2>ğŸ“ Auto-Ã©valuation</h2>
  <div id="evalContent"></div>

  <h4>ğŸ’¬ Commentaire</h4>
  <textarea id="comment" rows="3"></textarea>

  <button class="primary" onclick="saveEval()">ğŸ’¾ Enregistrer</button>
  <button onclick="closeEval()">Fermer</button>
 </div>
</div>

<script>
/* ========= CONFIG ========= */
const UV={
 Kihon:["distance","kime","prÃ©cision","posture","rythme"],
 Kata:["prÃ©cision","Ã©quilibre","fluiditÃ©","kime","regard"],
 Randori:["distance","timing","tai sabaki","engagement","luciditÃ©"]
};
const synth=speechSynthesis;

/* ========= STATE ========= */
let trainingState="idle"; // idle | running | paused | finished
let timer=null;
let index=0;
let remaining=0;

let exercises=[
 {name:"Kihon",uv:"Kihon",duration:10,progress:0,done:false},
 {name:"Kata",uv:"Kata",duration:8,progress:0,done:false},
 {name:"Randori",uv:"Randori",duration:8,progress:0,done:false}
];

/* ========= INIT ========= */
render();updateLabel();drawRadar();

/* ========= CORE ========= */
function start(){
 if(trainingState==="running") return;

 if(trainingState==="finished"){
  resetTraining();
 }

 trainingState="running";
 updateLabel();
 runCurrent();
}

function runCurrent(){
 if(index>=exercises.length){
  trainingState="finished";
  updateLabel();
  speak("Fin de l'entraÃ®nement");
  return;
 }

 const ex=exercises[index];
 if(!remaining){
  remaining=ex.duration*60*(1-ex.progress/100);
  speak(ex.name);
 }

 timer=setInterval(()=>{
  remaining--;
  ex.progress=100*(1-remaining/(ex.duration*60));
  render();
  updateGlobal();

  if(remaining<=0){
   clearInterval(timer);
   timer=null;
   remaining=0;
   ex.done=true;
   speak("Fin de l'exercice");
   index++;
   runCurrent();
  }
 },1000);
}

function pause(){
 if(timer){clearInterval(timer);timer=null}
 synth.cancel();
 trainingState="paused";
 updateLabel();
}

function stop(){
 pause();
 trainingState="idle";
 index=0;
 remaining=0;
 exercises.forEach(e=>{e.progress=0;e.done=false});
 render();updateGlobal();updateLabel();
}

function resetTraining(){
 index=0;
 remaining=0;
 exercises.forEach(e=>{e.progress=0;e.done=false});
}

/* ========= AUTO-EVAL ========= */
function openEval(){
 pause();

 const modal=document.getElementById("evalModal");
 const c=document.getElementById("evalContent");
 const com=document.getElementById("comment");
 c.innerHTML="";com.value="";

 const done=exercises.filter(e=>e.done);
 if(!done.length){
  c.innerHTML="<p>Aucun exercice terminÃ©.</p>";
  modal.style.display="flex";
  return;
 }

 const data=loadEval();
 const today=data[todayKey()]||{exercises:{},comment:""};
 com.value=today.comment||"";

 done.forEach(ex=>{
  c.innerHTML+=`<h4>${ex.name}</h4>`;
  UV[ex.uv].forEach(cr=>{
   c.innerHTML+=`<div>${cr} : `;
   [1,2,3,4,5].forEach(v=>{
    const a=today.exercises?.[ex.name]?.[cr]===v?"active":"";
    c.innerHTML+=`<span class="smile ${a}" data-ex="${ex.name}" data-cr="${cr}" data-v="${v}">
     ${["ğŸ˜","ğŸ˜","ğŸ™‚","ğŸ˜„","ğŸ”¥"][v-1]}</span>`;
   });
   c.innerHTML+="</div>";
  });
  c.innerHTML+="<hr>";
 });

 document.querySelectorAll(".smile").forEach(s=>{
  s.onclick=()=>{
   s.parentNode.querySelectorAll(".smile").forEach(x=>x.classList.remove("active"));
   s.classList.add("active");
  };
 });

 modal.style.display="flex";
}

function saveEval(){
 const data=loadEval();
 const d=todayKey();
 if(!data[d]) data[d]={exercises:{},comment:""};

 document.querySelectorAll(".smile.active").forEach(s=>{
  const ex=s.dataset.ex,cr=s.dataset.cr,v=+s.dataset.v;
  data[d].exercises[ex]=data[d].exercises[ex]||{};
  data[d].exercises[ex][cr]=v;
 });

 data[d].comment=document.getElementById("comment").value;
 localStorage.setItem("evals",JSON.stringify(data));
 closeEval();drawRadar();
}

function closeEval(){
 document.getElementById("evalModal").style.display="none";
}

/* ========= UI ========= */
function render(){
 const ul=document.getElementById("program");
 ul.innerHTML="";
 exercises.forEach((e,i)=>{
  ul.innerHTML+=`
   <li class="${i===index?"active":""} ${e.done?"done":""}">
    <strong>${e.name}</strong>
    <div class="progress"><div style="width:${e.progress}%"></div></div>
   </li>`;
 });
}
function updateGlobal(){
 const t=exercises.reduce((a,e)=>a+e.duration,0);
 const d=exercises.reduce((a,e)=>a+e.duration*(e.progress/100),0);
 document.getElementById("global").style.width=(d/t*100)+"%";
}
function updateLabel(){
 const map={
  idle:"â¹ Inactif",
  running:"â–¶ En cours",
  paused:"â¸ En pause",
  finished:"âœ… TerminÃ©"
 };
 document.getElementById("stateLabel").innerText=map[trainingState];
}

/* ========= RADAR ========= */
function drawRadar(){
 const c=document.getElementById("radar");
 const ctx=c.getContext("2d");
 ctx.clearRect(0,0,320,320);

 const data=loadEval();
 const acc={};
 Object.values(data).forEach(d=>{
  Object.values(d.exercises||{}).forEach(ex=>{
   Object.entries(ex).forEach(([k,v])=>{
    acc[k]=acc[k]||[];acc[k].push(v);
   });
  });
 });

 const keys=Object.keys(acc);
 if(!keys.length) return;

 const cx=160,cy=160,r=120;
 keys.forEach((k,i)=>{
  const a=2*Math.PI/keys.length*i-Math.PI/2;
  const avg=acc[k].reduce((a,b)=>a+b)/acc[k].length;
  ctx.beginPath();
  ctx.moveTo(cx,cy);
  ctx.lineTo(cx+Math.cos(a)*r*avg/5,cy+Math.sin(a)*r*avg/5);
  ctx.stroke();
  ctx.fillText(k,cx+Math.cos(a)*(r+8),cy+Math.sin(a)*(r+8));
 });
}

/* ========= UTILS ========= */
function speak(t){synth.cancel();synth.speak(new SpeechSynthesisUtterance(t))}
function todayKey(){return new Date().toISOString().slice(0,10)}
function loadEval(){return JSON.parse(localStorage.getItem("evals")||"{}")}
</script>
</body>
</html>
