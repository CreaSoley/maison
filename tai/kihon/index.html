
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tai-Jitsu ‚Äì Entra√Ænement</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="tai/banner.css">


  <style>
    @font-face { font-family: "Spicy"; src: url("Spicy Sale.ttf"); }

    :root{
      --pink-1:#fff0f6;
      --pink-2:#ffd6ec;
      --accent:#ff5fc1;
      --card-shadow: 0 10px 24px rgba(255,120,180,0.12);
      --hot-pink:#ff1493;
      --bg-gradient: linear-gradient(180deg,#fff6fb 0%, #ffeef6 100%);
      --text:#222;
      --radius:20px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: 'Fredoka', Arial, sans-serif;
      color:var(--text);
      background: var(--bg-gradient);
      -webkit-font-smoothing:antialiased;
    }
    a{ color:inherit; text-decoration: none; }

    @media (max-width:900px){ .grid{ grid-template-columns: 1fr; } }

    .card-kawaii {
        background: white;
        border: 3px solid var(--pink-2);
        border-radius: var(--radius);
        padding: 25px;
        box-shadow: 0 8px 15px rgba(255, 182, 193, 0.4);
        margin-bottom: 20px;
        overflow: visible;
    }

    .module-title {
        font-family: "Spicy", sans-serif;
        color: var(--hot-pink);
        font-size: 1.8rem;
        text-align: center;
        margin-bottom: 20px;
        text-shadow: 2px 2px 0px var(--pink-2);
    }

    .sub-section {
        background: var(--pink-1);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px dashed var(--accent);
    }

    .sub-section h3 {
        color: var(--hot-pink);
        margin-top: 0;
        font-size: 1.2rem;
        margin-bottom: 10px;
    }

    .result-display {
        background: #fff;
        border: 2px solid var(--pink-2);
        border-radius: 12px;
        padding: 15px;
        min-height: 50px;
        text-align: center;
        font-weight: bold;
        color: #c9184a;
        margin: 10px 0;
    }

    input, select {
        padding: 10px;
        border-radius: 10px;
        border: 2px solid var(--pink-2);
        font-family: 'Fredoka', sans-serif;
        margin-bottom: 10px;
        width: 100%;
    }

    .btn-kawaii {
        width: 100%;
        font-family: "Spicy", sans-serif;
        background: var(--accent);
        color: white;
        border: none;
        padding: 12px;
        border-radius: 50px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 0px #d6459b;
        margin-top: 5px;
    }

    .btn-kawaii:hover { transform: scale(1.02); }
    .btn-kawaii:active { transform: translateY(3px); box-shadow: none; }
    .btn-kawaii:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .btn-ghost { background: #fff; color: var(--accent); border: 2px solid var(--accent); box-shadow: none; }

    /* Boutons avec d√©grad√©s */
    .btn-stop {
        background-image: linear-gradient(to right, #ff8177 0%, #ff867a 0%, #ff8c7f 21%, #f99185 52%, #cf556c 78%, #b12a5b 100%);
        box-shadow: 0 4px 0px #8a1a40;
    }
    .btn-start {
        background-image: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);
        color: #333;
        box-shadow: 0 4px 0px #5cb88a;
    }
    .btn-read {
        background-image: linear-gradient(to top, #30cfd0 0%, #330867 100%);
        box-shadow: 0 4px 0px #1a0436;
    }

    /* Vid√©o - Mobile */
    .video-container iframe,
    #techVideo { 
        width: 100%; 
        border-radius: 10px; 
        margin-top: 10px; 
        height: 200px;
    }
    
    /* Vid√©o - Desktop : hauteur ~10cm (380px) */
    @media (min-width: 901px) {
        .video-container iframe,
        #techVideo {
            height: 380px !important;
        }
    }

    .hidden { display: none !important; }

    .suggestions-container {
        background: white;
        border-radius: 15px;
        border: 2px solid var(--pink-2);
        margin-top: 5px;
        overflow: hidden;
        box-shadow: var(--card-shadow);
    }
    .suggestion-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid var(--pink-1);
        font-size: 0.9rem;
        transition: 0.2s;
    }
    .suggestion-item:hover { background-color: var(--pink-1); }
    .suggestion-item:last-child { border-bottom: none; }

    .category-list {
        max-height: 400px;
        overflow-y: auto;
        margin-top: 10px;
    }
    .category-item {
        padding: 12px 15px;
        background: white;
        margin-bottom: 8px;
        border-radius: 10px;
        border: 2px solid var(--pink-2);
        cursor: pointer;
        transition: 0.2s;
    }
    .category-item:hover {
        background: var(--pink-1);
        transform: translateX(5px);
    }

    .clickable-term {
        cursor: pointer;
        text-decoration: underline;
        text-decoration-style: dotted;
        text-underline-offset: 3px;
        transition: 0.2s;
    }
    .clickable-term:hover { color: var(--accent); }

    input[type="range"] { accent-color: var(--accent); }

    .pdf-row { display: flex; gap: 10px; margin-bottom: 15px; }
    .pdf-btn { 
        flex: 1; text-align: center; background: #000; color: #fff; 
        padding: 8px; border-radius: 10px; font-size: 0.8rem; 
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        margin-left: 10px;
    }
    .status-active { background: #4CAF50; color: white; }
    .status-waiting { background: #FF9800; color: white; }

    .technique-unique {
        font-size: 1.3rem;
        padding: 20px;
        text-align: center;
        animation: fadeIn 0.5s;
    }
    /* --- BIBLIOTH√àQUE KAWAII --- */
.library-shelf {
  position: relative;
  padding-top: 25px;
}

.book-shelf {
  display: flex;
  gap: 25px;
  align-items: flex-end;
  padding-bottom: 20px;
}

/* Styles essentiels pour .book-kawaii */
.book-kawaii {
  width: 75px;
  height: 150px;
  background: var(--color, #ffd7f6);
  border-radius: 4px;
  padding: 10px 5px;
  text-align: center;
  font-family: "Spicy", cursive;
  text-decoration: none;
  color: #333;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  cursor: pointer;
  background-image: linear-gradient(135deg, rgba(255,255,255,0.35) 0%, rgba(255,255,255,0) 40%);
  box-shadow: 0 6px 10px rgba(0,0,0,0.25);
  transition: transform 0.25s, box-shadow 0.25s;
}

/* Hauteurs vari√©es + inclinaisons pr√©d√©finies */
.book-kawaii:nth-child(1) { height: 140px; transform: rotate(-4deg); }
.book-kawaii:nth-child(2) { height: 165px; transform: rotate(3deg); }
.book-kawaii:nth-child(3) { height: 155px; transform: rotate(-2deg); }
.book-kawaii:nth-child(4) { height: 170px; transform: rotate(5deg); }
.book-kawaii:nth-child(5) { height: 150px; transform: rotate(-3deg); }

/* tranche r√©aliste */
.book-kawaii::before {
  content: "";
  position: absolute;
  right: -8px;
  top: 0;
  height: 100%;
  width: 8px;
  background: rgba(255,255,255,0.6);
  border-radius: 0 4px 4px 0;
  box-shadow: inset -2px 0 3px rgba(0,0,0,0.15);
}

/* Hover (redressement) */
.book-kawaii:hover {
  transform: rotate(0deg) translateY(-8px);
  box-shadow: 0 12px 18px rgba(0,0,0,0.35);
}

/* Tooltip via data-info */
.book-kawaii::after {
  content: attr(data-info);
  visibility: hidden;
  opacity: 0;
  position: absolute;
  bottom: calc(100% + 10px);
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: #fff;
  font-size: 0.85rem;
  padding: 6px 10px;
  border-radius: 8px;
  white-space: nowrap;
  transition: opacity 0.3s;
  pointer-events: none;
}

.book-kawaii:hover::after {
  visibility: visible;
  opacity: 1;
}

/* √©tag√®re */
.shelf-bar {
  height: 12px;
  background: #8b5c3c;
  border-radius: 6px;
  box-shadow: 0 6px 10px rgba(0,0,0,0.3) inset;
}

/* MOBILE : r√©duction douce */
@media (max-width: 800px) {
  .logo-big { max-width: 120px; }
  .header-text .title { font-size: 2.2rem; }
  .header-text .subtitle { font-size: 1.4rem; }
}

/* MOBILE encore plus petit */
@media (max-width: 500px) {
  .logo-big { max-width: 100px; }
  .header-text .title { font-size: 1.8rem; }
  .header-text .subtitle { font-size: 1.2rem; }
}

/* MOBILE ‚Äî r√©duction de la taille des livres kawaii */
@media (max-width: 600px) {
  .book-kawaii {
    width: 55px;
    height: 110px;
    padding: 8px 4px;
    font-size: 0.75rem;
  }

  .book-kawaii:nth-child(1) { height: 100px; }
  .book-kawaii:nth-child(2) { height: 120px; }
  .book-kawaii:nth-child(3) { height: 110px; }
  .book-kawaii:nth-child(4) { height: 125px; }
  .book-kawaii:nth-child(5) { height: 105px; }

  .book-kawaii::before {
    width: 6px;
    right: -6px;
  }

  .book-kawaii::after {
    font-size: 0.75rem;
  }

  .book-shelf {
    gap: 15px;
  }
}

  </style>
</head>
<body>

<div id="bannerContainer"></div>

<script>
  fetch("tai/banner.html")
    .then(r => r.text())
    .then(html => {
      document.getElementById("bannerContainer").innerHTML = html;

      // optionnel : injecter le titre automatiquement
      const title = document.querySelector("title")?.textContent || "";
      const titleDiv = document.querySelector(".header-text .title");
      if (titleDiv && title) titleDiv.textContent = title;
    });
</script>


<div class="main-wrapper">
    <div class="grid">
        
        <!-- COLONNE GAUCHE : SCRIPT 1 (KIHON SIMPLE) -->
        <div class="card-kawaii">
            <div class="module-title">ü•ã Kihon Simple</div>
            
            <div class="sub-section">
                <div class="controls-column">
                    <input id="searchKihon" type="search" placeholder="Rechercher une technique...">
                    <select id="filterCategorie">
                        <option value="">Toutes cat√©gories</option>
                    </select>
                    <button id="btnRandomKihon" class="btn-kawaii btn-ghost">‚ú® Surprise (Al√©atoire)</button>
                </div>
                <div id="kihonList"></div>
                <div id="categoryList" class="category-list"></div>
            </div>

            <div id="kihonResult" class="sub-section hidden">
                <h3 id="techNom" style="margin-bottom:5px;"></h3>
                <p id="techCat" style="font-weight:bold; color:var(--accent); margin-bottom: 10px;"></p>
                
                <div class="result-display" id="techDesc" style="font-size: 0.9rem; text-align: left; font-weight: normal; min-height: auto;">
                </div>

                <div class="media-container" style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                    <img id="techPhoto" src="" alt="Photo technique" style="width:100%; border-radius:10px; border:2px solid var(--pink-2); display:none;">
                    <div class="video-container">
                        <iframe id="techVideo" src="" frameborder="0" allowfullscreen style="display:none;"></iframe>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLONNE DROITE : SCRIPTS 2 & 3 -->
        <div>
            <!-- SCRIPT 2 : ENCHA√éNEMENT -->
            <div class="card-kawaii">
                <div class="module-title">üí´ Encha√Ænement</div>

                <div class="pdf-row">
                    <a href="pdf/ippon_kumite.pdf" class="pdf-btn">üìÑ Ippon Kumite</a>
                    <a href="pdf/tai_sabaki.pdf" class="pdf-btn">üìÑ Tai Sabaki</a>
                </div>

                <div id="enchainementSection"></div>
            </div>

            <!-- SCRIPT 3 : TECHNIQUE CIBLE UNIQUE -->
            <div class="card-kawaii" id="cibleSection">
                <div class="module-title">üéØ Technique Cible</div>
                
                <div class="sub-section">
                    <button id="btnNouveauCible" class="btn-kawaii">üé≤ Nouveau tirage</button>
                    
                    <div class="result-display technique-unique" id="cibleResult">
                        <span style="color: #999;">Cliquez pour commencer</span>
                    </div>
                </div>

                <div class="sub-section">
                    <h3>üîä Contr√¥les Audio</h3>
                    
                    <button id="btnLectureFR" class="btn-kawaii btn-read">üîä Lire en fran√ßais</button>
                    
                    <div style="margin-top: 10px;">
                        <label style="font-weight: bold; color: var(--accent);">
                            Beeper : <span id="cibleBeeperFreqValue">3s</span>
                        </label>
                        <input type="range" id="cibleBeeperFreqSlider" min="1" max="10" step="1" value="3">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <button id="btnStartCibleBeeper" class="btn-kawaii btn-start" style="flex:1;">üîî D√©marrer</button>
                        <button id="btnStopCibleBeeper" class="btn-kawaii btn-stop" style="flex:1;">‚èπ Stop</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- SCRIPT 1 : KIHON SIMPLE -->
<script>
let techniques = [];

fetch("tjkihon.json")
  .then(res => res.json())
  .then(data => {
    techniques = data;
    populateCategories();
    displayList([]);
  })
  .catch(err => console.error("Erreur chargement JSON:", err));

function populateCategories() {
  const select = document.getElementById("filterCategorie");
  if (!select) return;
  const cats = [...new Set(techniques.map(t => t.categorie))];
  cats.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    select.appendChild(opt);
  });
}

const searchInput = document.getElementById("searchKihon");
const kihonList = document.getElementById("kihonList");
const categoryListContainer = document.getElementById("categoryList");
const filterCategorie = document.getElementById("filterCategorie");

searchInput.addEventListener("input", (e) => {
  const query = e.target.value.toLowerCase().trim();
  categoryListContainer.innerHTML = "";
  
  if (query.length === 0) {
    displayList([]);
    document.getElementById("kihonResult").classList.add("hidden");
    if (filterCategorie.value) {
      displayCategoryList(filterCategorie.value);
    }
    return;
  }

  let filtered = techniques.filter(t => 
    t.nom.toLowerCase().includes(query) || 
    t.categorie.toLowerCase().includes(query)
  );
  
  if (filterCategorie.value) {
    filtered = filtered.filter(t => t.categorie === filterCategorie.value);
  }

  displayList(filtered);

  if (filtered.length === 1) {
    showTechnique(filtered[0]);
  } 
  else if (filtered.length > 1 && filtered[0].nom.toLowerCase() === query) {
    showTechnique(filtered[0]);
  }
});

filterCategorie.addEventListener("change", (e) => {
  const category = e.target.value;
  searchInput.value = "";
  displayList([]);
  document.getElementById("kihonResult").classList.add("hidden");
  
  if (category) {
    displayCategoryList(category);
  } else {
    categoryListContainer.innerHTML = "";
  }
});

function displayCategoryList(category) {
  const filtered = techniques.filter(t => t.categorie === category);
  categoryListContainer.innerHTML = "";
  
  if (filtered.length === 0) {
    categoryListContainer.innerHTML = '<p style="color:#999; text-align:center;">Aucune technique dans cette cat√©gorie</p>';
    return;
  }
  
  filtered.forEach(t => {
    const item = document.createElement("div");
    item.className = "category-item";
    item.innerHTML = `<strong>${t.nom}</strong>`;
    item.addEventListener("click", () => {
      showTechnique(t);
      document.getElementById("kihonResult").scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });
    categoryListContainer.appendChild(item);
  });
}

function displayList(list) {
  kihonList.innerHTML = "";
  const maxSuggestions = list.slice(0, 5);

  if (maxSuggestions.length === 0 || (list.length === 1 && searchInput.value.toLowerCase() === list[0].nom.toLowerCase())) {
    return; 
  }

  const container = document.createElement("div");
  container.className = "suggestions-container"; 

  maxSuggestions.forEach(t => {
    const item = document.createElement("div");
    item.className = "suggestion-item";
    item.innerHTML = `<strong>${t.nom}</strong> <small style="color:var(--accent)">(${t.categorie})</small>`;
    
    item.addEventListener("click", () => {
      showTechnique(t);
      searchInput.value = t.nom;
      kihonList.innerHTML = "";
    });
    container.appendChild(item);
  });

  kihonList.appendChild(container);
}

function showTechnique(t) {
  const resultDiv = document.getElementById("kihonResult");
  resultDiv.classList.remove("hidden");

  document.getElementById("techNom").textContent = t.nom;
  document.getElementById("techCat").textContent = "ü•ã " + t.categorie;
  document.getElementById("techDesc").innerHTML = t.description.replace(/\n/g, "<br>");

  const img = document.getElementById("techPhoto");
  if (t.photo && t.photo !== "") {
    img.src = t.photo;
    img.style.display = "block";
  } else {
    img.style.display = "none";
  }

  const video = document.getElementById("techVideo");
  if (t.video && t.video !== "") {
    let url = t.video.replace("watch?v=", "embed/");
    url = url.replace("youtu.be/", "www.youtube.com/embed/");
    video.src = url;
    video.style.display = "block";
  } else {
    video.style.display = "none";
    video.src = "";
  }
}

document.getElementById("btnRandomKihon").addEventListener("click", () => {
  let pool = techniques;
  if (filterCategorie.value) {
    pool = techniques.filter(t => t.categorie === filterCategorie.value);
  }
  if (pool.length === 0) {
    alert("Aucune technique disponible");
    return;
  }
  const t = pool[Math.floor(Math.random() * pool.length)];
  showTechnique(t);
  kihonList.innerHTML = "";
  searchInput.value = "";
});
</script>

<!-- SCRIPT 2 : ENCHA√éNEMENT AVANC√â -->
<script>
let enchainementsData = [];
let techniquesDescriptions = [];
let currentEnchainement = null;
let selectedCategorie = null;
let enchainementBeeper = null;
let enchainementTimeouts = [];
let isReadingEnchainement = false;
let enchainementSpeechRate = 0.7;

async function loadEnchainementData() {
    try {
        const response1 = await fetch("kihon_maj2025.json");
        enchainementsData = await response1.json();
        
        if (typeof techniques !== 'undefined' && techniques.length > 0) {
            techniquesDescriptions = techniques;
        } else {
            const response2 = await fetch("tjkihon.json");
            techniquesDescriptions = await response2.json();
        }
        
        initEnchainementUI();
        populateSpecialites();
    } catch (err) {
        console.error("‚ùå Erreur chargement donn√©es enchainements :", err);
    }
}

function initEnchainementUI() {
    const container = document.getElementById("enchainementSection");
    if (!container) return;
    
    const controls = document.createElement("div");
    controls.id = "enchainementControls";
    controls.innerHTML = `
        <div class="sub-section">
            <h3>üîó G√©n√©rateur d'Encha√Ænement</h3>
            <div>
                <label style="font-weight: bold; color: var(--accent);">Filtrer par sp√©cialit√© :</label>
                <select id="filterSpecialite">
                    <option value="">Toutes les sp√©cialit√©s</option>
                </select>
            </div>
            
            <button id="btnNouveauEnchainement" class="btn-kawaii">üé≤ Nouveau tirage</button>
            
            <div id="categorieAnnonce" style="text-align: center; font-size: 1.1rem; color: var(--accent); font-weight: bold; margin-top: 10px; min-height: 25px;"></div>
            
            <div id="enchainementResult" class="result-display" style="min-height: 100px; display: flex; flex-direction: column; justify-content: center; text-align: center;">
                <p style="color: #999;">Cliquez pour commencer</p>
            </div>
        </div>

        <div class="sub-section">
            <h3>üîä Contr√¥les Audio <span id="audioStatus"></span></h3>
            
            <div>
                <label style="font-weight: bold; color: var(--accent);">
                    Vitesse lecture JP : <span id="enchainementSpeedValue">√ó0.7</span>
                </label>
                <input type="range" id="enchainementSpeedSlider" min="0.3" max="2" step="0.1" value="0.7">
            </div>
            
            <button id="btnLectureJP" class="btn-kawaii btn-read">‚ñ∂Ô∏è Lire en japonais (2 fois)</button>
            <p style="font-size: 0.8rem; color: #666; margin: 5px 0;">‚ö° Le beeper d√©marre auto 5s apr√®s la 2√®me lecture</p>
            
            <div style="margin-top: 10px;">
                <label style="font-weight: bold; color: var(--accent);">
                    Beeper : <span id="beeperFreqValue">3s</span>
                </label>
                <input type="range" id="beeperFreqSlider" min="1" max="10" step="1" value="3">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 5px;">
                <button id="btnStartBeeper" class="btn-kawaii btn-start" style="flex:1;">üîî D√©marrer</button>
                <button id="btnStopBeeper" class="btn-kawaii btn-stop" style="flex:1;">‚èπ Stop</button>
            </div>
        </div>
    `;
    container.appendChild(controls);
    
    attachEnchainementEvents();
}

function populateSpecialites() {
    const select = document.getElementById("filterSpecialite");
    if (!select) return;
    
    const allSpecs = new Set();
    enchainementsData.forEach(e => {
        if (e.specialite && Array.isArray(e.specialite)) {
            e.specialite.forEach(s => allSpecs.add(s));
        }
    });
    
    allSpecs.forEach(spec => {
        const option = document.createElement("option");
        option.value = spec;
        option.textContent = spec;
        select.appendChild(option);
    });
}

function attachEnchainementEvents() {
    document.getElementById("btnNouveauEnchainement")?.addEventListener("click", nouveauEnchainement);
    
    const speedSlider = document.getElementById("enchainementSpeedSlider");
    speedSlider?.addEventListener("input", (e) => {
        enchainementSpeechRate = parseFloat(e.target.value);
        document.getElementById("enchainementSpeedValue").textContent = `√ó${enchainementSpeechRate.toFixed(1)}`;
    });
    
    document.getElementById("btnLectureJP")?.addEventListener("click", lireEnchainementJaponais);
    
    const beeperSlider = document.getElementById("beeperFreqSlider");
    beeperSlider?.addEventListener("input", (e) => {
        document.getElementById("beeperFreqValue").textContent = `${e.target.value}s`;
    });
    
    document.getElementById("btnStartBeeper")?.addEventListener("click", startEnchainementBeeper);
    document.getElementById("btnStopBeeper")?.addEventListener("click", stopEnchainementBeeper);
}

// Nouveau tirage avec s√©quence compl√®te
async function nouveauEnchainement() {
    const specialite = document.getElementById("filterSpecialite")?.value;
    let filtered = enchainementsData;
    
    if (specialite) {
        filtered = enchainementsData.filter(e => e.specialite && e.specialite.includes(specialite));
    }
    
    if (filtered.length === 0) {
        alert("Aucun enchainement trouv√© pour cette sp√©cialit√©");
        return;
    }
    
    // Nettoyer
    enchainementTimeouts.forEach(t => clearTimeout(t));
    enchainementTimeouts = [];
    stopEnchainementBeeper();
    speechSynthesis.cancel();
    
    // S√©lection al√©atoire
    currentEnchainement = filtered[Math.floor(Math.random() * filtered.length)];
    
    // S√©lection cat√©gorie al√©atoire
    if (currentEnchainement.specialite && currentEnchainement.specialite.length > 0) {
        const randomIndex = Math.floor(Math.random() * currentEnchainement.specialite.length);
        selectedCategorie = currentEnchainement.specialite[randomIndex];
    } else {
        selectedCategorie = "Technique";
    }
    
    const resultDiv = document.getElementById("enchainementResult");
    const categorieDiv = document.getElementById("categorieAnnonce");
    const btn = document.getElementById("btnNouveauEnchainement");
    const statusSpan = document.getElementById("audioStatus");
    
    btn.disabled = true;
    isReadingEnchainement = true;
    
    resultDiv.innerHTML = `
        <div style="animation: fadeIn 0.4s;">
            <p style="font-size: 1.5rem; color: var(--accent);">‚è≥</p>
            <p id="countdown" style="font-size: 1.2rem; color: #666;">Pr√©paration...</p>
        </div>
    `;
    categorieDiv.innerHTML = "";
    
    await unlockSpeechSynthesis();
    
    // Phase 1 : Pr√©paration 5s
    statusSpan.innerHTML = '<span class="status-badge status-waiting">Pr√©paration 5s</span>';
    updateCountdown("Pr√©paration... 5s");
    
    enchainementTimeouts.push(setTimeout(async () => {
        // Annonce cat√©gorie FR
        categorieDiv.innerHTML = `üè∑Ô∏è ${selectedCategorie}`;
        statusSpan.innerHTML = '<span class="status-badge status-active">Annonce cat√©gorie</span>';
        updateCountdown(`Cat√©gorie : ${selectedCategorie}`);
        
        await speakFrench(selectedCategorie);
        
        // Phase 2 : Lecture JP 1
        statusSpan.innerHTML = '<span class="status-badge status-active">Lecture JP 1/2</span>';
        updateCountdown("Lecture japonaise 1/2...");
        
        speakJapanese(currentEnchainement.jp, () => {
            // Pause 5s
            statusSpan.innerHTML = '<span class="status-badge status-waiting">Pause 5s</span>';
            updateCountdown("Pause... 5s");
            
            enchainementTimeouts.push(setTimeout(() => {
                // Phase 3 : Lecture JP 2
                statusSpan.innerHTML = '<span class="status-badge status-active">Lecture JP 2/2</span>';
                updateCountdown("Lecture japonaise 2/2...");
                
                speakJapanese(currentEnchainement.jp, () => {
                    // Phase 4 : Attente 5s puis beeper + affichage
                    statusSpan.innerHTML = '<span class="status-badge status-waiting">Beeper dans 5s</span>';
                    updateCountdown("Beeper dans 5s...");
                    
                    enchainementTimeouts.push(setTimeout(() => {
                        // AFFICHER LA TECHNIQUE ICI
                        afficherEnchainement();
                        
                        // D√©marrer le beeper
                        statusSpan.innerHTML = '<span class="status-badge status-active">Beeper actif</span>';
                        btn.disabled = false;
                        isReadingEnchainement = false;
                        startEnchainementBeeper();
                    }, 5000));
                });
            }, 5000));
        });
    }, 5000));
}

function updateCountdown(text) {
    const el = document.getElementById("countdown");
    if (el) el.textContent = text;
}

function speakFrench(text) {
    return new Promise((resolve) => {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = "fr-FR";
        utterance.rate = 0.9;
        utterance.onend = resolve;
        utterance.onerror = resolve;
        speechSynthesis.speak(utterance);
    });
}

function afficherEnchainement() {
    const resultDiv = document.getElementById("enchainementResult");
    if (!resultDiv || !currentEnchainement) return;
    
    resultDiv.innerHTML = `
        <div style="animation: fadeIn 0.4s;">
            <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 8px; color: #333;">
                ${createClickableTerms(currentEnchainement.fr)}
            </div>
            <div style="font-size: 1.1rem; color: #666; font-style: italic;">
                ${currentEnchainement.jp}
            </div>
            <div style="margin-top: 8px; font-size: 0.8rem; color: var(--accent);">
                <em>Cliquez sur une technique pour la description</em>
            </div>
        </div>
    `;
}

function createClickableTerms(text) {
    const terms = text.split(/[,‚Üí]/);
    return terms.map(term => {
        const trimmed = term.trim();
        return `<span class="clickable-term" onclick="showTechniquePopup('${trimmed.replace(/'/g, "\\'")}')">${trimmed}</span>`;
    }).join(' ‚Üí ');
}

function showTechniquePopup(termName) {
    const technique = techniquesDescriptions.find(t => 
        t.nom.toLowerCase() === termName.toLowerCase() ||
        t.nom.toLowerCase().includes(termName.toLowerCase()) ||
        termName.toLowerCase().includes(t.nom.toLowerCase())
    );
    
    const existingPopup = document.getElementById("techniquePopup");
    if (existingPopup) existingPopup.remove();
    const existingOverlay = document.getElementById("popupOverlay");
    if (existingOverlay) existingOverlay.remove();
    
    const popup = document.createElement("div");
    popup.id = "techniquePopup";
    popup.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; padding: 25px; border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 9999;
        max-width: 90%; width: 500px; max-height: 80vh; overflow-y: auto;
        animation: fadeIn 0.3s;
    `;
    
    if (technique) {
        let videoEmbed = '';
        if (technique.video) {
            let url = technique.video.replace("watch?v=", "embed/").replace("youtu.be/", "www.youtube.com/embed/");
            videoEmbed = `<iframe src="${url}" style="width: 100%; height: 200px; margin-top: 15px; border-radius: 10px;" frameborder="0" allowfullscreen></iframe>`;
        }
        
        popup.innerHTML = `
            <button onclick="this.parentElement.remove(); document.getElementById('popupOverlay')?.remove();" style="float: right; background: #ff4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px;">√ó</button>
            <h2 style="color: var(--accent); margin-bottom: 10px;">${technique.nom}</h2>
            <p style="font-style: italic; color: #666; margin-bottom: 10px;">Cat√©gorie: ${technique.categorie}</p>
            <p style="line-height: 1.6;">${technique.description.replace(/\n/g, '<br>')}</p>
            ${videoEmbed}
        `;
    } else {
        popup.innerHTML = `
            <button onclick="this.parentElement.remove(); document.getElementById('popupOverlay')?.remove();" style="float: right; background: #ff4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">√ó</button>
            <h3 style="color: var(--accent);">${termName}</h3>
            <p style="color: #666;">Description non trouv√©e dans la base de donn√©es.</p>
        `;
    }
    
    document.body.appendChild(popup);
    
    const overlay = document.createElement("div");
    overlay.id = "popupOverlay";
    overlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); z-index: 9998;";
    overlay.onclick = () => {
        popup.remove();
        overlay.remove();
    };
    document.body.appendChild(overlay);
}

async function lireEnchainementJaponais() {
    if (!currentEnchainement || isReadingEnchainement) return;
    
    isReadingEnchainement = true;
    const btn = document.getElementById("btnLectureJP");
    const statusSpan = document.getElementById("audioStatus");
    const originalText = btn.textContent;
    
    btn.disabled = true;
    
    enchainementTimeouts.forEach(t => clearTimeout(t));
    enchainementTimeouts = [];
    
    await unlockSpeechSynthesis();
    
    btn.textContent = "‚è≥ Pr√©paration (5s)...";
    statusSpan.innerHTML = '<span class="status-badge status-waiting">Pr√©paration</span>';
    
    enchainementTimeouts.push(setTimeout(() => {
        btn.textContent = "üîä Lecture 1/2...";
        statusSpan.innerHTML = '<span class="status-badge status-active">Lecture 1</span>';
        
        speakJapanese(currentEnchainement.jp, () => {
            btn.textContent = "‚è∏ Pause (5s)...";
            statusSpan.innerHTML = '<span class="status-badge status-waiting">Pause</span>';
            
            enchainementTimeouts.push(setTimeout(() => {
                btn.textContent = "üîä Lecture 2/2...";
                statusSpan.innerHTML = '<span class="status-badge status-active">Lecture 2</span>';
                
                speakJapanese(currentEnchainement.jp, () => {
                    btn.textContent = "‚è≥ Beeper dans 5s...";
                    statusSpan.innerHTML = '<span class="status-badge status-waiting">Bient√¥t beeper</span>';
                    
                    enchainementTimeouts.push(setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                        isReadingEnchainement = false;
                        statusSpan.innerHTML = '<span class="status-badge status-active">Beeper actif</span>';
                        
                        startEnchainementBeeper();
                    }, 5000));
                });
            }, 5000));
        });
    }, 5000));
}

function speakJapanese(text, callback) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "ja-JP";
    utterance.rate = enchainementSpeechRate;
    utterance.onend = callback;
    utterance.onerror = () => {
        console.error("Erreur synth√®se vocale");
        if (callback) callback();
    };
    speechSynthesis.speak(utterance);
}

function startEnchainementBeeper() {
    stopEnchainementBeeper();
    const freq = parseInt(document.getElementById("beeperFreqSlider")?.value || 3) * 1000;
    
    const topSound = new Audio("top.mp3");
    topSound.play().catch(e => console.log("Audio n√©cessite une interaction utilisateur"));
    
    enchainementBeeper = setInterval(() => {
        const sound = new Audio("top.mp3");
        sound.play().catch(e => {});
    }, freq);
    
    document.getElementById("btnStartBeeper").style.backgroundImage = "linear-gradient(120deg, #4CAF50 0%, #45a049 100%)";
    document.getElementById("btnStartBeeper").textContent = "üîî Actif";
    
    const statusSpan = document.getElementById("audioStatus");
    if (statusSpan) {
        statusSpan.innerHTML = '<span class="status-badge status-active">Beeper actif</span>';
    }
}

function stopEnchainementBeeper() {
    if (enchainementBeeper) {
        clearInterval(enchainementBeeper);
        enchainementBeeper = null;
        document.getElementById("btnStartBeeper").style.backgroundImage = "linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%)";
        document.getElementById("btnStartBeeper").textContent = "üîî D√©marrer";
        
        const statusSpan = document.getElementById("audioStatus");
        if (statusSpan) {
            statusSpan.innerHTML = '';
        }
    }
    
    enchainementTimeouts.forEach(t => clearTimeout(t));
    enchainementTimeouts = [];
    
    speechSynthesis.cancel();
    
    const btn = document.getElementById("btnLectureJP");
    const btnTirage = document.getElementById("btnNouveauEnchainement");
    if (btn && isReadingEnchainement) {
        btn.textContent = "‚ñ∂Ô∏è Lire en japonais (2 fois)";
        btn.disabled = false;
    }
    if (btnTirage) {
        btnTirage.disabled = false;
    }
    isReadingEnchainement = false;
}

async function unlockSpeechSynthesis() {
    return new Promise(resolve => {
        const utter = new SpeechSynthesisUtterance(".");
        utter.volume = 0.001;
        utter.onend = resolve;
        utter.onerror = resolve;
        speechSynthesis.speak(utter);
    });
}

document.addEventListener("DOMContentLoaded", () => {
    loadEnchainementData();
});
</script>

<!-- SCRIPT 3 : TECHNIQUE CIBLE UNIQUE -->
<script>
const techniquesCible = [
    "Mae Geri (jambe arri√®re, chudan)",
    "Mawashi Geri (jambe arri√®re, jodan/chudan)",
    "Mae Geri jambe avant avec sursaut (chudan)",
    "Mawashi Geri jambe avant avec sursaut (jodan/chudan)",
    "Gyaku Zuki chudan",
    "Kizami/Maete Zuki jodan ‚Üí Gyaku Zuki chudan",
    "O√Ø Zuki jodan ‚Üí retour arri√®re"
];

let cibleBeeper = null;
let currentTechniqueCible = null;

function attachCibleEvents() {
    document.getElementById("btnNouveauCible")?.addEventListener("click", nouveauTirageCible);
    document.getElementById("btnLectureFR")?.addEventListener("click", lireTechniqueFrancais);
    
    const cibleBeeperSlider = document.getElementById("cibleBeeperFreqSlider");
    cibleBeeperSlider?.addEventListener("input", (e) => {
        document.getElementById("cibleBeeperFreqValue").textContent = `${e.target.value}s`;
    });
    
    document.getElementById("btnStartCibleBeeper")?.addEventListener("click", startCibleBeeper);
    document.getElementById("btnStopCibleBeeper")?.addEventListener("click", stopCibleBeeper);
}

function nouveauTirageCible() {
    const randomIndex = Math.floor(Math.random() * techniquesCible.length);
    currentTechniqueCible = techniquesCible[randomIndex];
    afficherTechniqueCible();
}

function afficherTechniqueCible() {
    const resultDiv = document.getElementById("cibleResult");
    resultDiv.innerHTML = `
        <div style="animation: fadeIn 0.5s;">
            <strong>${currentTechniqueCible}</strong>
        </div>
    `;
}

function lireTechniqueFrancais() {
    if (!currentTechniqueCible) {
        alert("Veuillez d'abord faire un tirage");
        return;
    }
    
    speechSynthesis.cancel();
    
    const utterance = new SpeechSynthesisUtterance(currentTechniqueCible);
    utterance.lang = "fr-FR";
    utterance.rate = 0.9;
    speechSynthesis.speak(utterance);
}

function startCibleBeeper() {
    stopCibleBeeper();
    
    const freq = parseInt(document.getElementById("cibleBeeperFreqSlider")?.value || 3) * 1000;
    
    const topSound = new Audio("top.mp3");
    topSound.play().catch(e => console.log("Audio n√©cessite une interaction"));
    
    cibleBeeper = setInterval(() => {
        const sound = new Audio("top.mp3");
        sound.play().catch(e => {});
    }, freq);
    
    document.getElementById("btnStartCibleBeeper").style.backgroundImage = "linear-gradient(120deg, #4CAF50 0%, #45a049 100%)";
    document.getElementById("btnStartCibleBeeper").textContent = "üîî Actif";
}

function stopCibleBeeper() {
    if (cibleBeeper) {
        clearInterval(cibleBeeper);
        cibleBeeper = null;
        document.getElementById("btnStartCibleBeeper").style.backgroundImage = "linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%)";
        document.getElementById("btnStartCibleBeeper").textContent = "üîî D√©marrer";
    }
}

document.addEventListener("DOMContentLoaded", () => {
    attachCibleEvents();
    nouveauTirageCible();
});
</script>

</body>
</html>
