<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coach Tai Jitsu â€“ SÃ©ance + Ã‰valuation</title>
<style>
body { font-family: system-ui,sans-serif; margin:0; background:linear-gradient(to right,#ffecd2,#fcb69f);}
h1 { text-align:center; padding:1rem; }
.container { max-width:1100px; margin:auto; padding:1rem; display:grid; grid-template-columns:1fr 1fr; gap:1rem;}
.panel { background:#fff; border-radius:16px; padding:1rem; box-shadow:0 6px 14px rgba(0,0,0,.15);}
.uv { margin-bottom:1rem; }
.exercise { display:flex; justify-content:space-between; align-items:center; padding:.5rem .7rem; border-radius:10px; margin:.3rem 0; background:#f5f5f5;}
.exercise.selected { background:#d1f5d3; }
.exercise.active { background:#ffe8b3; }
.exercise.done { text-decoration:line-through; opacity:.6; }
.exercise button { border:none; border-radius:8px; padding:.3rem .6rem; cursor:pointer; font-size:1rem; }
.controls { margin-top:.8rem; display:flex; gap:.5rem; flex-wrap:wrap; }
input[type=text], input[type=number] { width:100%; padding:.6rem; border-radius:10px; border:1px solid #ccc; margin-bottom:.5rem; }
input[type=range]{ width:120px; margin-left:.5rem; }
progress { width:100%; height:14px; }
textarea { width:100%; border-radius:12px; padding:.6rem; margin-top:.5rem; }
label{ font-weight:bold; display:block; margin-top:.5rem; }

/* Overlay */
#trainingOverlay { display:none; position:fixed; inset:0; background:linear-gradient(to right,#84fab0,#8fd3f4); z-index:999;
  flex-direction:column; justify-content:center; align-items:center; }
#trainingOverlay h1 { font-size:3rem; }
#trainingOverlay #timer { font-size:4rem; margin:1rem 0; }

/* Objectifs */
.goal { margin-bottom:.7rem; }
.goal small { color:#555; }
</style>
</head>

<body>
<h1>ğŸ¥‹ Coach Tai Jitsu â€“ SÃ©ance + Ã‰valuation</h1>

<div class="container">

<!-- BANQUE -->
<div class="panel">
  <h2>ğŸ“š Banque d'exercices</h2>
  <div id="bank"></div>
</div>

<!-- SÃ‰LECTION -->
<div class="panel">
  <h2>ğŸ“ SÃ©ance sÃ©lectionnÃ©e</h2>
  <input type="text" id="sessionName" placeholder="Nom de la sÃ©ance">
  <div id="selection"></div>

  <label>Carnet de notes :</label>
  <textarea id="notes" rows="3"></textarea>

  <div class="controls">
    <button onclick="saveSelection()">ğŸ’¾ Sauvegarder</button>
    <button onclick="clearSelection()">ğŸ§¹ Vider</button>
    <button onclick="startSession()">â–¶ï¸ DÃ©marrer</button>
    <button onclick="toggleFullscreen()">ğŸ“± Plein Ã©cran</button>
    <button onclick="showHistory()">ğŸ“Š Historique</button>
  </div>

  <progress id="progress" value="0" max="100"></progress>

  <hr>
  <h3>ğŸ¯ Objectifs hebdomadaires</h3>
  <div id="goals"></div>
</div>

</div>

<!-- OVERLAY -->
<div id="trainingOverlay">
  <h1 id="exerciseName"></h1>
  <div id="timer">00:00</div>
  <progress id="sessionProgress" value="0" max="100"></progress>
  <button onclick="toggleFullscreen()">âŒ Quitter</button>
</div>

<audio id="beep" src="beep.mp3"></audio>
<audio id="ding" src="ding.mp3"></audio>

<script>
/* ------------------ DONNÃ‰ES ------------------ */
const bankData = [
  { uv:'ğŸ¥‹ UV 1 â€“ Kihon', items:['Kihon simple','EnchaÃ®nement de kihon','Cibles'], criteria:['PrÃ©cision','RÃ©activitÃ©','Posture'] },
  { uv:'ğŸŒ€ UV 2 â€“ DÃ©placements', items:['TaÃ¯ sabaki','Slow ippon','Ippon kumite'], criteria:['FluiditÃ©','Ã‰quilibre','ContrÃ´le'] },
  { uv:'ğŸ“ UV 3 â€“ Kata', items:['Slow kata','Kata nidan','BunkaÃ¯'], criteria:['Exactitude','MaÃ®trise','Kime'] },
  { uv:'âš™ï¸ UV 4 â€“ Technique de base', items:['Shadow'], criteria:['RÃ©alisme','Zanchin','Protection'] },
  { uv:'ğŸ”¥ UV 5 & 6 â€“ Randori', items:['Randori shadow'], criteria:['RÃ©alisme','Zanchin','Protection'] }
];

let selection = JSON.parse(localStorage.getItem('tj-selection')) || [];
let sessions  = JSON.parse(localStorage.getItem('tj-sessions')) || {};
let goals     = JSON.parse(localStorage.getItem('tj-goals')) || {};
let seqIndex=0, timer=null, fullscreen=false;

/* ------------------ UTILS ------------------ */
function weekKey(){
  const d=new Date();
  const jan1=new Date(d.getFullYear(),0,1);
  return d.getFullYear()+"-W"+Math.ceil((((d-jan1)/86400000)+jan1.getDay()+1)/7);
}

/* ------------------ RENDER BANQUE ------------------ */
function renderBank(){
  const b=document.getElementById('bank'); b.innerHTML='';
  bankData.forEach(u=>{
    const d=document.createElement('div'); d.className='uv'; d.innerHTML=`<h3>${u.uv}</h3>`;
    u.items.forEach(n=>{
      d.innerHTML+=`<div class="exercise"><span>${n}</span><button onclick="addExercise('${u.uv}','${n}')">â•</button></div>`;
    });
    b.appendChild(d);
  });
}

/* ------------------ SÃ‰LECTION ------------------ */
function renderSelection(){
  const s=document.getElementById('selection'); s.innerHTML='';
  if(!selection.length){ s.innerHTML='<em>Aucun exercice</em>'; return;}
  selection.forEach((e,i)=>{
    s.innerHTML+=`
      <div class="exercise selected">
        ${e.uv} â€“ ${e.name}
        <div>
          <input type="range" min="1" max="60" value="${e.duration}" oninput="updateDuration(${i},this.value)">
          ${e.duration} min
          <button onclick="moveUp(${i})">â¬†ï¸</button>
          <button onclick="moveDown(${i})">â¬‡ï¸</button>
          <button onclick="removeExercise(${i})">âŒ</button>
        </div>
      </div>`;
  });
}

function addExercise(uv,name){ selection.push({uv,name,duration:5}); saveSelection(); }
function updateDuration(i,v){ selection[i].duration=parseInt(v); saveSelection(); }
function moveUp(i){ if(i>0){ [selection[i],selection[i-1]]=[selection[i-1],selection[i]]; saveSelection(); }}
function moveDown(i){ if(i<selection.length-1){ [selection[i],selection[i+1]]=[selection[i+1],selection[i]]; saveSelection(); }}
function removeExercise(i){ selection.splice(i,1); saveSelection(); }
function saveSelection(){ localStorage.setItem('tj-selection',JSON.stringify(selection)); renderSelection(); renderGoals(); }
function clearSelection(){ if(confirm('Vider ?')){ selection=[]; saveSelection(); }}

/* ------------------ OBJECTIFS HEBDO ------------------ */
function renderGoals(){
  const g=document.getElementById('goals'); g.innerHTML='';
  const wk=weekKey();

  selection.forEach(ex=>{
    if(!goals[ex.name]) goals[ex.name]=30;

    const done=Object.values(sessions)
      .filter(s=>s.week===wk)
      .flatMap(s=>s.exercises||[])
      .filter(e=>e.name===ex.name)
      .reduce((a,e)=>a+e.duration,0);

    const target=goals[ex.name];
    const pct=Math.min(100,Math.round((done/target)*100));

    g.innerHTML+=`
      <div class="goal">
        <strong>${ex.name}</strong><br>
        Objectif: <input type="number" value="${target}" min="1"
          onchange="setGoal('${ex.name}',this.value)"> min
        <progress value="${pct}" max="100"></progress>
        <small>${pct}% (${done}/${target} min)</small>
      </div>`;
  });
  localStorage.setItem('tj-goals',JSON.stringify(goals));
}

function setGoal(n,v){ goals[n]=parseInt(v)||0; renderGoals(); }

/* ------------------ INIT ------------------ */
renderBank();
renderSelection();
renderGoals();

/* ======== LECTURE / ENTRAÃNEMENT ======== */

function speak(text, cb){
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'fr-FR';
  u.onend = cb;
  speechSynthesis.speak(u);
}

function startSession(){
  if(selection.length === 0){
    alert("SÃ©lection vide");
    return;
  }

  // sauvegarde automatique de la sÃ©ance
  const name = document.getElementById('sessionName').value || 
               "SÃ©ance " + new Date().toLocaleString();

  sessions[name] = {
    date: new Date().toLocaleString(),
    week: weekKey(),
    exercises: JSON.parse(JSON.stringify(selection)),
    notes: document.getElementById('notes').value
  };
  localStorage.setItem('tj-sessions', JSON.stringify(sessions));

  seqIndex = 0;
  toggleFullscreen();
  speak("CommenÃ§ons l'entraÃ®nement", () => {
    setTimeout(nextExercise, 1000);
  });
}

function nextExercise(){
  if(seqIndex >= selection.length){
    speak("EntraÃ®nement terminÃ©, Ã  bientÃ´t !");
    toggleFullscreen();
    return;
  }

  const ex = selection[seqIndex];
  document.getElementById('exerciseName').textContent = ex.name;

  speak(`Exercice ${seqIndex + 1} : ${ex.name}`, () => {
    setTimeout(() => {
      document.getElementById('beep').play();
      startTimer(ex.duration * 60);
    }, 2000);
  });
}

function startTimer(seconds){
  const timerEl = document.getElementById('timer');
  const prog = document.getElementById('sessionProgress');
  let remaining = seconds;

  clearInterval(timer);
  timer = setInterval(() => {
    remaining--;
    timerEl.textContent = formatTime(remaining);

    const done = (seqIndex + 1) / selection.length * 100;
    prog.value = done;

    if(remaining <= 0){
      clearInterval(timer);
      document.getElementById('ding').play();
      speak("Fin de l'exercice", () => {
        seqIndex++;
        setTimeout(nextExercise, 1000);
      });
    }
  }, 1000);
}
</script>
</body>
</html>
