<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coach Tai Jitsu ‚Äì Entra√Ænement</title>

<style>
body {
  font-family: system-ui, sans-serif;
  margin: 0;
  background: linear-gradient(to right, #ffecd2, #fcb69f);
}
h1 { text-align:center; padding:1rem; }

.container {
  max-width:1100px;
  margin:auto;
  padding:1rem;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:1rem;
}

.panel {
  background:#fff;
  border-radius:16px;
  padding:1rem;
  box-shadow:0 6px 14px rgba(0,0,0,.15);
}

.exercise {
  display:flex;
  justify-content:space-between;
  padding:.4rem .6rem;
  margin:.3rem 0;
  border-radius:10px;
  background:#f5f5f5;
}

.exercise.active { background:#ffe8b3; }
.exercise.done { text-decoration:line-through; opacity:.6; }

button {
  border:none;
  border-radius:10px;
  padding:.4rem .8rem;
  cursor:pointer;
}

progress { width:100%; height:14px; }

/* Overlay entra√Ænement */
#overlay {
  display:none;
  position:fixed;
  inset:0;
  background:linear-gradient(to right,#84fab0,#8fd3f4);
  z-index:1000;
  flex-direction:column;
  justify-content:center;
  align-items:center;
}

#overlay h2 { font-size:2.5rem; }
#overlay #timer { font-size:4rem; margin:1rem 0; }
</style>
</head>

<body>

<h1>ü•ã Coach Tai Jitsu</h1>

<div class="container">

  <div class="panel">
    <h2>üìù S√©lection</h2>
    <div id="selection"></div>
    <button onclick="startTraining()">‚ñ∂Ô∏è Commencer l‚Äôentra√Ænement</button>
  </div>

  <div class="panel">
    <h2>üéØ Objectifs hebdomadaires</h2>
    <div id="goals"></div>
  </div>

</div>

<!-- Overlay entra√Ænement -->
<div id="overlay">
  <h2 id="currentExercise"></h2>
  <div id="timer">00:00</div>
  <progress id="progress" value="0" max="100"></progress>
  <button onclick="hideOverlay()">‚ùå Quitter l‚Äôaffichage</button>
</div>

<audio id="beep" src="beep.mp3"></audio>
<audio id="ding" src="ding.mp3"></audio>

<script>
/* ================= DONN√âES ================= */

const defaultSelection = [
  { name:'Kihon simple', duration:5 },
  { name:'Encha√Ænement de kihon', duration:5 },
  { name:'Cibles', duration:5 },
  { name:'Ta√Ø sabaki', duration:5 },
  { name:'Slow kata', duration:5 }
];

let selection = JSON.parse(localStorage.getItem('tj-selection')) || defaultSelection;
let history   = JSON.parse(localStorage.getItem('tj-history')) || [];
let goals     = JSON.parse(localStorage.getItem('tj-goals')) || {};

let index = 0;
let interval = null;
let running = false;

/* ================= UTILITAIRES ================= */

function speak(text, cb){
  const u = new SpeechSynthesisUtterance(text);
  u.onend = cb || null;
  speechSynthesis.speak(u);
}

function weekKey(){
  const d = new Date();
  const jan1 = new Date(d.getFullYear(),0,1);
  return d.getFullYear() + '-W' +
    Math.ceil((((d - jan1)/86400000) + jan1.getDay()+1)/7);
}

/* ================= RENDER ================= */

function renderSelection(){
  const el = document.getElementById('selection');
  el.innerHTML='';
  selection.forEach((ex,i)=>{
    el.innerHTML += `
      <div class="exercise ${i<index?'done':i===index?'active':''}">
        ${ex.name} ‚Äì ${ex.duration} min
      </div>`;
  });
}

function renderGoals(){
  const el = document.getElementById('goals');
  el.innerHTML='';
  const wk = weekKey();

  selection.forEach(ex=>{
    const target = goals[ex.name] || 30;
    const done = history
      .filter(h=>h.week===wk && h.name===ex.name)
      .reduce((s,h)=>s+h.duration,0);

    el.innerHTML += `
      <div>
        <strong>${ex.name}</strong><br>
        Objectif :
        <input type="number" value="${target}" min="0"
          onchange="setGoal('${ex.name}',this.value)"> min
        <progress value="${done}" max="${target}"></progress>
        ${done}/${target} min
      </div>`;
  });
}

/* ================= OBJECTIFS ================= */

function setGoal(name,val){
  goals[name]=parseInt(val)||0;
  localStorage.setItem('tj-goals',JSON.stringify(goals));
  renderGoals();
}

/* ================= ENTRA√éNEMENT ================= */

function startTraining(){
  if(running) return;
  running = true;
  index = 0;
  showOverlay();
  speak("Commen√ßons l'entra√Ænement", nextExercise);
}

function nextExercise(){
  if(index >= selection.length){
    speak("Entra√Ænement termin√©, √† bient√¥t !");
    running = false;
    hideOverlay();
    renderGoals();
    return;
  }

  renderSelection();
  const ex = selection[index];
  document.getElementById('currentExercise').textContent = ex.name;

  let remaining = ex.duration * 60;
  updateTimer(remaining);

  speak(`Exercice ${index+1} : ${ex.name}`, ()=>{
    setTimeout(()=>{
      document.getElementById('beep').play();
      interval = setInterval(()=>{
        remaining--;
        updateTimer(remaining);
        document.getElementById('progress').value =
          ((index + (ex.duration*60-remaining)/(ex.duration*60)) / selection.length) * 100;

        if(remaining <= 0){
          clearInterval(interval);
          document.getElementById('ding').play();

          history.push({
            name: ex.name,
            duration: ex.duration,
            week: weekKey(),
            date: new Date().toISOString()
          });
          localStorage.setItem('tj-history',JSON.stringify(history));

          speak("Fin de l'exercice", ()=>{
            index++;
            nextExercise();
          });
        }
      },1000);
    },2000);
  });
}

function updateTimer(sec){
  const m = Math.floor(sec/60);
  const s = sec%60;
  document.getElementById('timer').textContent =
    `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

/* ================= OVERLAY ================= */

function showOverlay(){
  document.getElementById('overlay').style.display='flex';
}
function hideOverlay(){
  document.getElementById('overlay').style.display='none';
}

/* ================= INIT ================= */

renderSelection();
renderGoals();
</script>

</body>
</html>
