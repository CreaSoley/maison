<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coach Tai Jitsu ‚Äì Objectifs Hebdomadaires</title>

<style>
body {
  font-family: system-ui, sans-serif;
  margin: 0;
  background: linear-gradient(to right, #ffecd2, #fcb69f);
}
h1 { text-align:center; padding:1rem; }

.container {
  max-width:1200px;
  margin:auto;
  padding:1rem;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:1rem;
}

.panel {
  background:#fff;
  border-radius:16px;
  padding:1rem;
  box-shadow:0 6px 14px rgba(0,0,0,.15);
}

.exercise {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:.4rem .6rem;
  margin:.3rem 0;
  border-radius:10px;
  background:#f5f5f5;
}

.exercise.active { background:#ffe8b3; }
.exercise.done { text-decoration:line-through; opacity:.6; }

button {
  border:none;
  border-radius:10px;
  padding:.4rem .8rem;
  cursor:pointer;
}

progress { width:100%; height:14px; }

input[type=number] { width:60px; }

/* üîë OVERLAY : BIEN CACH√â PAR D√âFAUT */
#trainingOverlay {
  display:none;
  position:fixed;
  inset:0;
  background:linear-gradient(to right,#84fab0,#8fd3f4);
  z-index:999;
  flex-direction:column;
  justify-content:center;
  align-items:center;
}

#timer { font-size:4rem; margin:1rem 0; }
#exerciseName { font-size:2.5rem; }
</style>
</head>

<body>
<h1>ü•ã Coach Tai Jitsu ‚Äì Suivi & Objectifs</h1>

<div class="container">

<!-- S√âLECTION -->
<div class="panel">
  <h2>üìù S√©ance</h2>
  <div id="selection"></div>
  <button onclick="startSession()">‚ñ∂Ô∏è Commencer entra√Ænement</button>
</div>

<!-- OBJECTIFS -->
<div class="panel">
  <h2>üéØ Objectifs hebdomadaires</h2>
  <div id="goals"></div>
</div>

</div>

<!-- OVERLAY ENTRA√éNEMENT -->
<div id="trainingOverlay">
  <div id="exerciseName"></div>
  <div id="timer">00:00</div>
  <progress id="sessionProgress" value="0" max="100"></progress>
  <button onclick="hideOverlay()">‚ùå Quitter affichage</button>
</div>

<audio id="beep" src="beep.mp3"></audio>
<audio id="ding" src="ding.mp3"></audio>

<script>
/* ------------------ DONN√âES ------------------ */
const exercises = [
  'Kihon simple','Encha√Ænement de kihon','Cibles',
  'Ta√Ø sabaki','Slow ippon','Ippon kumite',
  'Slow kata','Kata nidan','Bunka√Ø',
  'Shadow','Randori shadow'
];

let selection = JSON.parse(localStorage.getItem('tj-selection')) ||
  exercises.map(e => ({ name:e, duration:5 }));

let history = JSON.parse(localStorage.getItem('tj-history')) || [];
let goals = JSON.parse(localStorage.getItem('tj-goals')) || {};

let index = 0;
let timer = null;
let trainingRunning = false;

/* ------------------ UTILITAIRES ------------------ */
function speak(txt, cb){
  const u = new SpeechSynthesisUtterance(txt);
  u.onend = cb;
  speechSynthesis.speak(u);
}

function weekKey(){
  const d = new Date();
  const onejan = new Date(d.getFullYear(),0,1);
  return d.getFullYear() + '-W' +
    Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
}

/* ------------------ RENDER ------------------ */
function renderSelection(){
  const div = document.getElementById('selection');
  div.innerHTML='';
  selection.forEach((e,i)=>{
    div.innerHTML += `
      <div class="exercise ${i<index?'done':i===index?'active':''}">
        ${e.name} ‚Äì ${e.duration} min
      </div>`;
  });
}

function renderGoals(){
  const div = document.getElementById('goals');
  div.innerHTML='';
  const wk = weekKey();

  exercises.forEach(ex=>{
    const target = goals[ex] || 30;
    const done = history
      .filter(h=>h.week===wk && h.name===ex)
      .reduce((s,h)=>s+h.duration,0);

    div.innerHTML += `
      <div>
        <strong>${ex}</strong><br>
        Objectif :
        <input type="number" value="${target}" onchange="setGoal('${ex}',this.value)"> min
        <progress value="${done}" max="${target}"></progress>
        ${done}/${target} min
      </div>`;
  });
}

/* ------------------ OBJECTIFS ------------------ */
function setGoal(ex,val){
  goals[ex]=parseInt(val);
  localStorage.setItem('tj-goals',JSON.stringify(goals));
  renderGoals();
}

/* ------------------ ENTRA√éNEMENT ------------------ */
function startSession(){
  if(trainingRunning) return;
  trainingRunning = true;
  index = 0;
  showOverlay();
  speak("Commen√ßons l'entra√Ænement", runExercise);
}

function runExercise(){
  if(index >= selection.length){
    speak("Entra√Ænement termin√©, √† bient√¥t !");
    trainingRunning = false;
    hideOverlay();
    renderGoals();
    return;
  }

  const ex = selection[index];
  document.getElementById('exerciseName').textContent = ex.name;
  let t = ex.duration * 60;

  speak(`Exercice ${index+1} : ${ex.name}`, ()=>{
    setTimeout(()=>{
      document.getElementById('beep').play();
      timer = setInterval(()=>{
        t--;
        document.getElementById('timer').textContent =
          `${Math.floor(t/60).toString().padStart(2,'0')}:${(t%60).toString().padStart(2,'0')}`;

        document.getElementById('sessionProgress').value =
          ((index + (ex.duration*60 - t)/(ex.duration*60)) / selection.length) * 100;

        if(t <= 0){
          clearInterval(timer);
          document.getElementById('ding').play();

          history.push({
            name: ex.name,
            duration: ex.duration,
            week: weekKey(),
            date: new Date().toISOString()
          });
          localStorage.setItem('tj-history', JSON.stringify(history));

          speak("Fin de l'exercice", ()=>{
            index++;
            renderSelection();
            runExercise();
          });
        }
      },1000);
    },2000);
  });
}

/* ------------------ OVERLAY ------------------ */
function showOverlay(){
  document.getElementById('trainingOverlay').style.display='flex';
}
function hideOverlay(){
  document.getElementById('trainingOverlay').style.display='none';
}

/* ------------------ INIT ------------------ */
renderSelection();
renderGoals();
</script>
</body>
</html>
