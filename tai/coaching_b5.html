<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coach Tai Jitsu ‚Äì S√©ance + √âvaluation</title>
<style>
body { font-family: system-ui,sans-serif; margin:0; background:linear-gradient(to right,#ffecd2,#fcb69f);}
h1 { text-align:center; padding:1rem; }
.container { max-width:1100px; margin:auto; padding:1rem; display:grid; grid-template-columns:1fr 1fr; gap:1rem;}
.panel { background:#fff; border-radius:16px; padding:1rem; box-shadow:0 6px 14px rgba(0,0,0,.15);}
.uv { margin-bottom:1rem; }
.exercise { display:flex; justify-content:space-between; align-items:center; padding:.5rem .7rem; border-radius:10px; margin:.3rem 0; background:#f5f5f5;}
.exercise.selected { background:#d1f5d3; }
.exercise.active { background:#ffe8b3; }
.exercise.done { text-decoration:line-through; opacity:.6; }
.exercise button { border:none; border-radius:8px; padding:.3rem .6rem; cursor:pointer; font-size:1rem; }
.controls { margin-top:.8rem; display:flex; gap:.5rem; flex-wrap:wrap; }
input[type=text] { width:100%; padding:.6rem; border-radius:10px; border:1px solid #ccc; margin-bottom:.5rem; }
input[type=range]{ width:120px; margin-left:.5rem; }
#progress { width:100%; height:16px; margin-top:.8rem; }
/* Overlay plein √©cran */
#trainingOverlay { display:none; position:fixed; inset:0; background:linear-gradient(to right,#84fab0,#8fd3f4); z-index:999; flex-direction:column; justify-content:center; align-items:center; color:#000; font-family:system-ui,sans-serif;}
#trainingOverlay h1 { font-size:3rem; margin-bottom:1rem; }
#trainingOverlay #timer { font-size:4rem; margin-bottom:1rem; }
#trainingOverlay progress { width:80%; height:24px; }
#trainingOverlay button { margin-top:2rem;padding:1rem 2rem;font-size:1.2rem;border-radius:12px; cursor:pointer; }
textarea { width:100%; border-radius:12px; padding:.6rem; margin-top:.5rem; }
label{ font-weight:bold; display:block; margin-top:.5rem; }
.emoji-btn{ font-size:1.5rem; cursor:pointer; margin-right:.5rem; }
.selected-emoji{ border:2px solid #333; border-radius:6px; }
.history-item{ border-bottom:1px solid #ccc; padding:.3rem 0; }
</style>
</head>
<body>
<h1>ü•ã Coach Tai Jitsu ‚Äì S√©ance + √âvaluation</h1>

<div class="container">
  <!-- BANQUE -->
  <div class="panel">
    <h2>üìö Banque d'exercices</h2>
    <div id="bank"></div>
  </div>

  <!-- S√âLECTION + NOTES + CONTROLS -->
  <div class="panel">
    <h2>üìù S√©ance s√©lectionn√©e</h2>
    <input type="text" id="sessionName" placeholder="Nom de la s√©ance">
    <div id="selection"></div>
    <label>Carnet de notes :</label>
    <textarea id="notes" rows="3" placeholder="Ressenti du jour..."></textarea>
    <label>üéØ Objectifs hebdomadaires :</label>
    <div id="goals"></div>
    <div class="controls">
      <button onclick="saveSelection()">üíæ Sauvegarder la s√©lection</button>
      <button onclick="clearSelection()">üßπ Vider la s√©lection</button>
      <button onclick="startSession()">‚ñ∂Ô∏è Commencer entra√Ænement</button>
      <button onclick="toggleFullscreen()">üì± Plein √©cran</button>
      <button onclick="showHistory()">üìä Historique</button>
    </div>
    <progress id="progress" value="0" max="100"></progress>
  </div>
</div>

<!-- Overlay plein √©cran exercice -->
<div id="trainingOverlay">
  <h1 id="exerciseName">Exercice</h1>
  <div id="timer">00:00</div>
  <progress id="sessionProgress" value="0" max="100"></progress>
  <button onclick="toggleFullscreen()">‚ùå Quitter plein √©cran</button>
</div>

<audio id="beep" src="beep.mp3"></audio>
<audio id="ding" src="ding.mp3"></audio>

<script>
/* ===== DONN√âES ===== */
const bankData=[
 {uv:'ü•ã UV1 Kihon',items:['Kihon simple','Encha√Ænement','Cibles'],criteria:['Pr√©cision','R√©activit√©','Posture']},
 {uv:'üåÄ UV2 D√©placements',items:['Ta√Ø sabaki','Slow ippon','Ippon kumite'],criteria:['Fluidit√©','√âquilibre','Contr√¥le']},
 {uv:'üìê UV3 Kata',items:['Slow kata','Kata nidan','Bunka√Ø'],criteria:['Exactitude','Ma√Ætrise','Kime']},
 {uv:'‚öôÔ∏è UV4 Technique',items:['Shadow'],criteria:['R√©alisme','Zanchin','Protection']},
 {uv:'üî• UV5-6 Randori',items:['Randori shadow'],criteria:['R√©alisme','Zanchin','Protection']}
];

let selection=JSON.parse(localStorage.getItem('tj-selection'))||[];
let sessions=JSON.parse(localStorage.getItem('tj-sessions'))||{};
let goals=JSON.parse(localStorage.getItem('tj-goals'))||{};
let seqIndex=0,timer=null,fullscreen=false;
let currentSessionName="";

/* ===== DOM ===== */
const exerciseName = document.getElementById('exerciseName');
const timerEl = document.getElementById('timer');
const sessionProgress = document.getElementById('sessionProgress');
const beep = document.getElementById('beep');
const ding = document.getElementById('ding');
const notes = document.getElementById('notes');
const trainingOverlay = document.getElementById('trainingOverlay');

/* ===== UTIL ===== */
function weekKey(){
 const d=new Date(),j=new Date(d.getFullYear(),0,1);
 return d.getFullYear()+"-W"+Math.ceil((((d-j)/86400000)+j.getDay()+1)/7);
}
function speak(txt,cb){
 const u=new SpeechSynthesisUtterance(txt);
 u.lang='fr-FR'; u.onend=cb; speechSynthesis.speak(u);
}
function formatTime(s){return String(Math.floor(s/60)).padStart(2,'0')+":"+String(s%60).padStart(2,'0');}

/* ===== RENDER BANQUE ===== */
function renderBank(){
 const b=document.getElementById('bank'); b.innerHTML='';
 bankData.forEach(u=>{
  const d=document.createElement('div'); d.innerHTML=`<h4>${u.uv}</h4>`;
  u.items.forEach(n=>{
   d.innerHTML+=`<div class="exercise"><span>${n}</span> <button onclick="addExercise('${u.uv}','${n}')">‚ûï</button></div>`;
  });
  b.appendChild(d);
 });
}

/* ===== RENDER S√âLECTION ===== */
function renderSelection(){
 const s=document.getElementById('selection'); s.innerHTML='';
 if(!selection.length){s.innerHTML='<em>Aucun exercice</em>'; return;}
 selection.forEach((e,i)=>{
  s.innerHTML+=`
   <div class="exercise selected">
    ${e.uv} ‚Äì ${e.name}
    <div>
     <input type="range" min="1" max="60" value="${e.duration}" oninput="updateDuration(${i},this.value)">
     ${e.duration} min
     <button onclick="moveUp(${i})">‚¨ÜÔ∏è</button>
     <button onclick="moveDown(${i})">‚¨áÔ∏è</button>
     <button onclick="removeExercise(${i})">‚ùå</button>
    </div>
   </div>`;
 });
}

/* ===== OBJECTIFS HEBDOMADAIRES ===== */
function renderGoals(){
 const g=document.getElementById('goals'); g.innerHTML='';
 const wk=weekKey();
 selection.forEach(ex=>{
  if(!goals[ex.name]) goals[ex.name]=30; // objectif par d√©faut 30 min
  let done=0;
  Object.values(sessions).forEach(s=>{
   if(s.week===wk)
    s.exercises.forEach(e=>{if(e.name===ex.name && e.doneMinutes) done+=e.doneMinutes;});
  });
  const pct=Math.min(100,Math.round(done/goals[ex.name]*100));
  g.innerHTML+=`
   <div>
    <strong>${ex.name}</strong><br>
    Objectif <input type="number" value="${goals[ex.name]}" onchange="setGoal('${ex.name}',this.value)"> min
    <progress value="${pct}" max="100"></progress>
    ${pct}%
   </div>`;
 });
 localStorage.setItem('tj-goals',JSON.stringify(goals));
}

/* ===== ACTIONS ===== */
function addExercise(uv,name){ selection.push({uv,name,duration:5,doneMinutes:0}); saveSelection(); }
function updateDuration(i,v){ selection[i].duration=parseInt(v); saveSelection(); }
function moveUp(i){ if(i>0){ [selection[i-1],selection[i]]=[selection[i],selection[i-1]]; saveSelection();} }
function moveDown(i){ if(i<selection.length-1){ [selection[i+1],selection[i]]=[selection[i+1],selection[i]]; saveSelection();} }
function removeExercise(i){ selection.splice(i,1); saveSelection(); }
function saveSelection(){ localStorage.setItem('tj-selection',JSON.stringify(selection)); renderSelection(); renderGoals(); }
function clearSelection(){ if(confirm("Vider la s√©lection ?")){ selection=[]; saveSelection(); } }
function setGoal(name,v){ goals[name]=parseInt(v); renderGoals(); }

/* ===== ENTRA√éNEMENT ===== */
function startSession(){
  if(!selection.length){ alert("S√©lectionnez des exercices"); return; }
  const name = document.getElementById('sessionName').value || "S√©ance " + new Date().toLocaleString();
  currentSessionName = name;

  // copie de la s√©lection pour la s√©ance
  sessions[name] = {
    date: new Date().toLocaleString(),
    week: weekKey(),
    exercises: selection.map(e=>({...e, doneMinutes:0})),
    notes: notes.value
  };
  localStorage.setItem('tj-sessions',JSON.stringify(sessions));

  seqIndex = 0;
  speak("Commen√ßons l'entra√Ænement", nextExercise);
}

function nextExercise(){
  if(seqIndex >= selection.length){
    speak("Entra√Ænement termin√©, √† bient√¥t !");
    return;
  }
  const ex = selection[seqIndex];
  exerciseName.textContent = ex.name;
  if(fullscreen) trainingOverlay.style.display='flex';

  speak(`Exercice ${seqIndex+1} : ${ex.name}`, ()=>{
    beep.play();
    let remaining = ex.duration*60;
    timerEl.textContent = formatTime(remaining);
    sessionProgress.value = (seqIndex)/selection.length*100;

    clearInterval(window._t);
    window._t = setInterval(()=>{
      remaining--;
      timerEl.textContent = formatTime(remaining);
      sessionProgress.value = (seqIndex + (ex.duration*60-remaining)/(ex.duration*60))/selection.length*100;
      if(remaining<=0){
        clearInterval(window._t);
        ding.play();
        selection[seqIndex].doneMinutes = ex.duration;
        sessions[currentSessionName].exercises[seqIndex].doneMinutes = ex.duration;
        localStorage.setItem('tj-sessions',JSON.stringify(sessions));
        speak("Fin de l'exercice", ()=>{
          seqIndex++;
          nextExercise();
        });
      }
    },1000);
  });
}

/* ===== FULLSCREEN ===== */
function toggleFullscreen(){ fullscreen = !fullscreen; trainingOverlay.style.display = fullscreen ? 'flex' : 'none'; }

/* ===== HISTORIQUE ===== */
function showHistory(){
  let txt='';
  for(const n in sessions){
    const s=sessions[n];
    txt+=`${n} (${s.date})\n`;
    s.exercises.forEach(e=>{
      txt+=`- ${e.name}: ${e.doneMinutes||0} min\n`;
    });
    txt+=`Notes: ${s.notes||''}\n\n`;
  }
  alert(txt || "Aucune s√©ance");
}

/* ===== INIT ===== */
renderBank(); renderSelection(); renderGoals();
</script>
</body>
</html>
