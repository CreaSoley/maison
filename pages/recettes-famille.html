<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Recettes de famille — Le P'tit Logis</title>

<!-- Police SPICY (précise ton chemin ../assets/fonts/Spicy Sale.ttf) -->
<style>
@font-face {
    font-family: "Spicy";
    src: url("../assets/fonts/Spicy Sale.ttf") format("truetype");
    font-weight: normal;
    font-style: normal;
}
:root{
    --bg: linear-gradient(135deg,#fff8f2 0%, #fdebd3 100%);
    --card: #fff;
    --muted: #6b6b6b;
    --text: #1f1f1f;
    --accent: #ff9f6b;
    --shadow: rgba(23,19,15,0.06);
    --info-gradient: linear-gradient(120deg,#ffd5b6 0%, #ffbdbd 100%);
    --btn-gradient: linear-gradient(120deg,#ffe6f0 0%, #ffd6b8 100%);
    --tag-gradient: linear-gradient(120deg,#84fab0 0%,#8fd3f4 100%);
}

html,body{height:100%;margin:0;padding:0;background:var(--bg);font-family:Arial, sans-serif;color:var(--text);}

/* Container */
.container{max-width:1100px;margin:18px auto;padding:0 16px;}

/* Header: logo + title (mobile stacked, desktop inline) */
.header{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:8px;
    margin-bottom:18px;
    text-align:center;
}
.header-row{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
}
.header img{
    width:110px;
    height:auto;
    cursor:pointer;
    transition:transform .18s;
    border-radius:12px;
    box-shadow:0 6px 16px var(--shadow);
}
.header img:hover{ transform:scale(1.04); }

.header h1{
    font-family:"Spicy", serif;
    font-size:2.2rem;
    margin:0;
    color:#111;
}
.header .sub{
    font-family:"Spicy", serif;
    margin-top:-6px;
    color:var(--muted);
    font-size:1.05rem;
}

/* toolbar */
.toolbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:20px;}
.toolbar input, .toolbar select, .toolbar button{
    padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);font-size:15px;
    background:rgba(255,255,255,0.9);
}
.toolbar .btn-action{
    background:var(--btn-gradient);
    border:none; cursor:pointer;
    display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;
    box-shadow:0 6px 14px rgba(0,0,0,0.06);
}

/* Cards grid */
.cards{
    display:grid;
    grid-template-columns: repeat(auto-fill,minmax(280px,1fr));
    gap:20px;
    align-items:start;
}

/* Card */
.card{
    background:var(--card);
    border-radius:14px;
    padding:14px;
    border:1px solid rgba(0,0,0,0.03);
    box-shadow:0 6px 18px var(--shadow);
    transition:transform .14s, box-shadow .14s;
    display:flex;
    flex-direction:column;
    gap:8px;
}
.card:hover{ transform:translateY(-6px); box-shadow:0 12px 30px rgba(0,0,0,0.12); }

/* image */
.img-box{width:100%;height:10.5cm;border-radius:10px;overflow:hidden;background:#f6f6f6;}
.img-box img{width:100%;height:100%;object-fit:cover;display:block;}

/* title */
.card h3{margin:0;font-family:"Spicy", serif;font-size:1.25rem;color:#111;}

/* tags & content */
.tag-section{display:flex;flex-direction:column;gap:6px;}
.tag-title{display:inline-block;padding:6px 10px;border-radius:10px;background:var(--tag-gradient);font-weight:600;color:#1b1b1b;font-size:13px;}
.tag-content{white-space:pre-line;font-size:14px;color:var(--muted);margin-left:4px;}

/* buttons row */
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;}
.kbtn{
    display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:none;cursor:pointer;font-size:14px;
    background:var(--btn-gradient);box-shadow:0 4px 10px rgba(0,0,0,0.06);
}
.kbtn svg{width:18px;height:18px}

/* small tag (pour "Pour X personnes") */
.small-tag{display:inline-block;padding:6px 10px;border-radius:10px;background:linear-gradient(120deg,#fff0d9 0%,#ffe6c8 100%);font-weight:600;color:#222;font-size:13px;}

/* responsive: logo left + title right on desktop */
@media (min-width:900px){
    .header{align-items:flex-start;text-align:left;}
    .header-row{flex-direction:row;align-items:center;gap:18px;}
    .header img{width:140px;}
    .header h1{font-size:2.8rem;}
}

/* print focus - only print the focused card */
@media print{
    body *{visibility:hidden !important}
    .print-focus, .print-focus *{visibility:visible !important}
    .print-focus{position:relative;top:0;left:0;width:100%}
    .toolbar, .header img, .btn-action{display:none !important}
}

/* fallback for very small screens */
@media (max-width:420px){
    .img-box{height:50vw}
}
</style>
</head>
<body>
<div class="container">

    <!-- Header -->
    <header class="header" role="banner">
        <div class="header-row">
            <a href="../index.html" title="Retour à l'accueil">
                <img src="../assets/images/logo.png" alt="logo Le P'tit Logis">
            </a>
            <div>
                <h1>Recettes de famille</h1>
                <div class="sub">cuisiné avec amour</div>
            </div>
        </div>
    </header>

    <!-- Toolbar -->
    <div class="toolbar" role="search">
        <input id="searchInput" type="search" placeholder="Recherche (nom ou ingrédient)…" aria-label="Recherche">
        <select id="categorieFilter" aria-label="Filtrer par catégorie">
            <option value="">Toutes catégories</option>
            <option>Petit-déjeuner</option>
            <option>Goûter</option>
            <option>Dessert</option>
            <option>Plat</option>
            <option>Hiver</option>
            <option>Boisson</option>
            <option>Léger</option>
        </select>

        <button class="btn-action" id="surpriseBtn" title="Recette surprise" onclick="recetteAleatoire()">
            <!-- cute dice icon -->
            <svg viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg" aria-hidden>
                <rect x="3" y="3" width="18" height="18" rx="4" fill="#ffdfd1"/>
                <circle cx="8" cy="8" r="1.6" fill="#ff7ea6"></circle>
                <circle cx="12" cy="12" r="1.6" fill="#78c4ff"></circle>
                <circle cx="16" cy="16" r="1.6" fill="#a8e063"></circle>
            </svg>
            Recette surprise
        </button>

    </div>

    <!-- Cards area -->
    <main id="cards" class="cards" aria-live="polite">
        <!-- Chargement… les cartes seront insérées ici -->
    </main>

</div>

<script>
/* --------------------------
   CSV parser robuste (gère guillemets et retours à la ligne)
   Retourne array d'objets {nom,categorie,personnes,ingredients,recette,photo}
   -------------------------- */
function parseCSVToObjects(text){
    const rows=[];
    let curField = "";
    let curRow = [];
    let inQuotes = false;
    for (let i=0;i<text.length;i++){
        const ch = text[i];
        const nch = text[i+1];

        if (ch === '"') {
            // if next char is a quote, it's an escaped quote
            if (inQuotes && nch === '"') {
                curField += '"';
                i++; // skip next
                continue;
            }
            inQuotes = !inQuotes;
            continue;
        }

        // handle CRLF or LF as row separators only when not in quotes
        if (!inQuotes && (ch === '\n' || ch === '\r')) {
            // if CRLF, skip the next char if it's \n
            if (ch === '\r' && nch === '\n') { /* skip */ }

            // end of field
            curRow.push(curField);
            curField = "";
            // end of row
            // if row is not completely empty (skip possible leading/trailing newlines)
            if (!(curRow.length === 1 && curRow[0].trim()==="")) {
                rows.push(curRow);
            }
            curRow = [];
            // skip possible extra \n after \r
            if (ch === '\r' && nch === '\n') i++;
            continue;
        }

        // comma separator only when not in quotes
        if (!inQuotes && ch === ',') {
            curRow.push(curField);
            curField = "";
            continue;
        }

        // otherwise append char to current field
        curField += ch;
    }

    // push last field/row
    if (curField !== "" || curRow.length > 0) {
        curRow.push(curField);
        rows.push(curRow);
    }

    // Normalize: first row is header
    if (rows.length === 0) return [];
    const header = rows[0].map(h => (h||"").trim());
    const dataRows = rows.slice(1).filter(r => r.some(c => (c||"").trim() !== ""));

    // Map to objects using header positions (defensive)
    const objs = dataRows.map(r => {
        // ensure has at least 6 columns
        while (r.length < 6) r.push("");
        return {
            nom: (r[0]||"").trim(),
            categorie: (r[1]||"").trim(),
            personnes: (r[2]||"").trim(),
            ingredients: (r[3]||"").replace(/\\n/g,"\n").trim(),
            recette: (r[4]||"").replace(/\\n/g,"\n").trim(),
            photo: (r[5]||"").trim()
        };
    });

    return objs;
}

/* --------------------------
   Load CSV file located at ../data/recettes.csv
   -------------------------- */
let RECETTES = [];

async function loadRecettes(){
    try {
        const res = await fetch("../data/recettes.csv", {cache:"no-store"});
        if (!res.ok) throw new Error("Fichier data/recettes.csv introuvable");
        const txt = await res.text();
        RECETTES = parseCSVToObjects(txt);
        renderCards(RECETTES);
    } catch (err) {
        console.error("Erreur chargement recettes:", err);
        const zone = document.getElementById("cards");
        zone.innerHTML = `<div style="padding:20px;background:#fff;border-radius:12px">Impossible de charger les recettes. Vérifie data/recettes.csv</div>`;
    }
}

/* --------------------------
   Render functions
   -------------------------- */
function createIconSVG(name){
    // small set of kawaii inline svgs by name
    switch(name){
        case 'print': return `<svg viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="14" rx="2" fill="#fff0d9" stroke="#ffb57a"/><rect x="7" y="7" width="10" height="6" rx="1" fill="#fff"/></svg>`;
        case 'ingredients': return `<svg viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg"><circle cx="7" cy="7" r="3" fill="#ffd1e6"/><rect x="11" y="5" width="8" height="6" rx="3" fill="#c7eaff"/></svg>`;
        case 'recipe': return `<svg viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg"><path d="M4 4h10v12H4z" fill="#fff3d9"/><circle cx="16" cy="8" r="3" fill="#ffd1e6"/></svg>`;
        case 'surprise': return `<svg viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="4" fill="#fff0f0"/><path d="M7 7l10 10M17 7L7 17" stroke="#ff7ea6" stroke-width="1.5"/></svg>`;
        default: return '';
    }
}

function renderCards(list){
    const zone = document.getElementById("cards");
    zone.innerHTML = "";
    if (!list || list.length === 0) {
        zone.innerHTML = `<div style="padding:24px;background:#fff;border-radius:12px;text-align:center">Aucune recette trouvée.</div>`;
        return;
    }

    list.forEach(r => {
        const card = document.createElement("article");
        card.className = "card";

        const imgUrl = r.photo || "";

        // sanitize text (basic)
        const ing = (r.ingredients||"").replace(/\n/g,"<br>");
        const rec = (r.recette||"").replace(/\n/g,"<br>");

        card.innerHTML = `
            <div class="img-box"><img src="${imgUrl}" alt="${escapeHtml(r.nom)}" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/640x480?text=Image'"></div>
            <h3>${escapeHtml(r.nom)}</h3>

            <div class="tag-section">
                <div><span class="tag-title">Ingrédients</span></div>
                <div class="tag-content">${ing}</div>
            </div>

            <div class="tag-section">
                <div><span class="tag-title">Préparation</span></div>
                <div class="tag-content">${rec}</div>
            </div>

            <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
                <div class="small-tag">${r.personnes || '—'} personne(s)</div>
                <div style="color:var(--muted);font-size:13px">${r.categorie || ''}</div>
            </div>

            <div class="actions">
                <button class="kbtn" onclick="printCard(this)" title="Imprimer cette fiche">
                    ${createIconSVG('print')} Imprimer
                </button>

                <button class="kbtn" onclick="openLightboxIngredients('${escapeJS(r.ingredients||"")}')" title="Voir ingrédients">
                    ${createIconSVG('ingredients')} Ingrédients
                </button>

                <button class="kbtn" onclick="openLightboxRecette('${escapeJS(r.recette||"")}')" title="Voir préparation">
                    ${createIconSVG('recipe')} Préparation
                </button>
            </div>
        `;

        zone.appendChild(card);
    });
}

/* --------------------------
   Helpers
   -------------------------- */
function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function escapeJS(s){ return (s||'').replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/\n/g,"\\n").replace(/\r/g,""); }

/* --------------------------
   Print only one card
   -------------------------- */
function printCard(btn){
    const card = btn.closest('.card');
    if(!card) return;
    card.classList.add('print-focus');
    setTimeout(()=> window.print(), 100);
    // cleanup after printing - use onafterprint where available
    const cleanup = () => { card.classList.remove('print-focus'); window.removeEventListener('afterprint',cleanup); };
    window.addEventListener('afterprint', cleanup);
    // fallback cleanup after 1s if afterprint not supported
    setTimeout(()=> card.classList.remove('print-focus'), 1200);
}

/* --------------------------
   Lightboxes simples pour ingrédients / préparation
   -------------------------- */
function openLightboxIngredients(text){
    openModal('Ingrédients', text);
}
function openLightboxRecette(text){
    openModal('Préparation', text);
}
function openModal(title, text){
    // create overlay
    const overlay = document.createElement('div');
    overlay.style.position='fixed';
    overlay.style.left=0;overlay.style.top=0;
    overlay.style.width='100%';overlay.style.height='100%';
    overlay.style.background='rgba(0,0,0,0.4)';
    overlay.style.display='flex';overlay.style.alignItems='center';overlay.style.justifyContent='center';
    overlay.style.zIndex=9999;
    overlay.onclick = () => { overlay.remove(); };

    const box = document.createElement('div');
    box.style.width='min(800px,92%)';
    box.style.maxHeight='80vh';
    box.style.overflow='auto';
    box.style.background='#fff';
    box.style.borderRadius='12px';
    box.style.padding='18px';
    box.style.boxShadow='0 10px 30px rgba(0,0,0,0.2)';
    box.onclick = (e) => e.stopPropagation();

    const h = document.createElement('h3');
    h.textContent = title;
    h.style.fontFamily = 'Spicy, serif';
    h.style.marginTop = 0;

    const p = document.createElement('div');
    p.innerHTML = text.replace(/\n/g,'<br>');
    p.style.whiteSpace = 'pre-wrap';
    p.style.color = 'var(--muted)';
    p.style.marginTop = '8px';

    const btn = document.createElement('button');
    btn.textContent='Fermer';
    btn.style.marginTop='12px';
    btn.className = 'kbtn';
    btn.onclick = () => overlay.remove();

    box.appendChild(h); box.appendChild(p); box.appendChild(btn);
    overlay.appendChild(box);
    document.body.appendChild(overlay);
}

/* --------------------------
   Filters & search
   -------------------------- */
function applyFilters(){
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    const cat = document.getElementById('categorieFilter').value.trim().toLowerCase();

    const filtered = RECETTES.filter(r => {
        const inName = (r.nom||'').toLowerCase().includes(q);
        const inIng = (r.ingredients||'').toLowerCase().includes(q);
        const catOk = !cat || (r.categorie||'').toLowerCase() === cat;
        return (inName || inIng) && catOk;
    });

    renderCards(filtered);
}

/* --------------------------
   Recette aléatoire
   -------------------------- */
function recetteAleatoire(){
    if (!RECETTES || RECETTES.length === 0) return;
    const r = RECETTES[Math.floor(Math.random() * RECETTES.length)];
    renderCards([r]);
}

/* --------------------------
   load + wire events
   -------------------------- */
document.getElementById('searchInput')?.addEventListener('input', applyFilters);
document.getElementById('categorieFilter')?.addEventListener('change', applyFilters);
document.getElementById('surpriseBtn')?.addEventListener('click', recetteAleatoire);

document.addEventListener('DOMContentLoaded', loadRecettes);
</script>
</body>
</html>
