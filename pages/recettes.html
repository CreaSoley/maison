<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recettes ‚Äî Le P'tit Logis</title>

  <meta name="description" content="S√©lecteur de recettes ‚Äî recherche par ingr√©dient, filtre par cat√©gorie, impression.">

  <!-- Material Icons (optionnel pour retour) -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root{
      --bg: #fff8fb;
      --card-bg: #ffffff;
      --muted: #6b6b6b;
      --kawaii-btn: linear-gradient(120deg,#fde7fb 0%,#e8f7ff 100%);
      --kawaii-badge: linear-gradient(120deg,#d8ffd6 0%,#d8f0ff 100%);
      --shadow: 0 10px 30px rgba(0,0,0,0.07);
      --accent: #6a7cff;
      --max-width: 1100px;
    }

    html,body { height:100%; margin:0; padding:0; font-family: Arial, Helvetica, sans-serif; background:var(--bg); color:#222; }

    .wrap { max-width: var(--max-width); margin:18px auto; padding:16px; }

    /* header */
    .top {
      display:flex;
      align-items:center;
      gap:16px;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand {
      display:flex;
      gap:12px;
      align-items:center;
    }
    .brand img { width:72px; height:auto; display:block; border-radius:10px; }
    .brand h1 { font-size:1.6rem; margin:0; color:var(--accent); font-weight:700; }
    .subtitle { font-size:0.95rem; color:var(--muted); margin-top:4px; }

    /* controls */
    .controls {
      margin-top:14px;
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }

    input[type="search"], select {
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.08);
      height:44px;
      font-size:15px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.03);
      background: white;
    }

    .btn {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border-radius:12px;
      background:var(--kawaii-btn);
      border:none;
      cursor:pointer;
      box-shadow: var(--shadow);
      font-weight:700;
    }

    .btn.icon { padding:8px 10px; font-size:1rem; }

    /* grid */
    .cards {
      display:grid;
      grid-template-columns: repeat(auto-fill,minmax(300px,1fr));
      gap:18px;
      margin-top:18px;
    }

    .card {
      background: var(--card-bg);
      border-radius:14px;
      padding:14px;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap:12px;
      border: 1px solid rgba(0,0,0,0.03);
    }

    .card h3 { margin:0; font-size:1.15rem; display:flex; align-items:center; gap:8px; }
    .meta { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .badge {
      padding:6px 10px;
      border-radius:12px;
      background-image: var(--kawaii-badge);
      font-weight:700;
      font-size:0.9rem;
      color:#054;
      box-shadow: 0 6px 12px rgba(0,0,0,0.04);
    }

    .img-box { width:100%; height:220px; border-radius:10px; overflow:hidden; background:#fafafa; display:flex; align-items:center; justify-content:center; }
    .img-box img { width:100%; height:100%; object-fit:contain; display:block; }

    .ingredients {
      background: linear-gradient(90deg,#fff,#fbfdff);
      padding:10px;
      border-radius:10px;
      font-size:0.95rem;
      line-height:1.45;
      max-height:160px;
      overflow:auto;
      border:1px solid rgba(0,0,0,0.02);
    }

    .recipe-steps { font-size:0.95rem; line-height:1.6; white-space:pre-wrap; }

    .buttons-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }

    .btn-small {
      background:white;
      border-radius:12px;
      padding:8px 12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid rgba(0,0,0,0.06);
      cursor:pointer;
      box-shadow: 0 6px 12px rgba(0,0,0,0.03);
      font-weight:600;
    }

    .muted { color:var(--muted); }

    /* print special: hide controls */
    @media print {
      .controls, .top, .btn { display:none !important; }
      body { background:white; }
      .card { box-shadow:none; border:none; page-break-after:always; }
    }

    /* responsive tweaks */
    @media (max-width:900px) {
      .img-box { height:44vw; }
      .brand img { width:60px; }
      .brand h1 { font-size:1.3rem; }
      .controls { flex-direction:column; align-items:stretch; gap:10px; }
      .top { gap:10px; }
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- header -->
    <div class="top">
      <div class="brand">
        <!-- logo cliquable vers la page d'accueil (change le chemin si besoin) -->
        <a href="index.html" title="Retour √† l'accueil"><img src="assets/images/logo.png" alt="logo"></a>
        <div>
          <h1>Recettes</h1>
          <div class="subtitle">Recherche rapide, filtre par cat√©gorie ‚Äî trouve ta recette parfaite ‚ú®</div>
        </div>
      </div>

      <div>
        <button class="btn" onclick="doRandom()" title="Recette surprise">‚ú® Surprise</button>
        <button class="btn" onclick="window.print()" title="Imprimer la page">üñ®Ô∏è Imprimer</button>
      </div>
    </div>

    <!-- controls -->
    <div class="controls" role="region" aria-label="Recherche et filtres">
      <input id="searchInput" type="search" placeholder="Recherche par nom ou ingr√©dient..." aria-label="Recherche" />
      <select id="categorySelect" aria-label="Cat√©gorie">
        <option value="">Toutes les cat√©gories</option>
      </select>
    </div>

    <!-- listing -->
    <main id="mainArea" class="main-area">
      <p class="muted">Chargement des recettes‚Ä¶</p>
    </main>
  </div>

  <script>
    /* ---------------------------------------
       Recettes (static CSV loader) ‚Äî client-side
       CSV attendu : nom,categorie,personnes,ingredients,recette,photo
       Chemin CSV : /data/recettes.csv
       --------------------------------------- */

    // Parse CSV line robustly (guillemets)
    function parseCSV(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
      if (!lines.length) return [];
      const header = lines[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); // handle quotes
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;
        // split that respects quotes
        const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => {
          let s = c.trim();
          if (s.startsWith('"') && s.endsWith('"')) s = s.slice(1, -1);
          return s.replace(/""/g, '"');
        });
        // ensure at least 6 columns
        while (cols.length < 6) cols.push("");
        rows.push({
          nom: cols[0] || "",
          categorie: cols[1] || "",
          personnes: cols[2] || "",
          ingredients: cols[3] || "",
          recette: cols[4] || "",
          photo: cols[5] || ""
        });
      }
      return rows;
    }

    async function loadCSV() {
      try {
        const res = await fetch('/data/recettes.csv', { cache: 'no-store' });
        if (!res.ok) throw new Error('CSV introuvable : ' + res.status);
        const txt = await res.text();
        const data = parseCSV(txt);
        if (!data || data.length === 0) {
          document.getElementById('mainArea').innerHTML = '<p class="muted">Aucune recette dans le fichier CSV.</p>';
          return;
        }
        RECIPES = data;
        buildCategoryList();
        renderList(RECIPES);
      } catch (err) {
        console.error(err);
        document.getElementById('mainArea').innerHTML = '<p class="muted">Erreur de chargement du CSV (v√©rifie /data/recettes.csv).</p>';
      }
    }

    // globals
    let RECIPES = [];
    let CATS = [];

    function buildCategoryList() {
      const set = new Set();
      RECIPES.forEach(r => {
        const c = (r.categorie || '').trim();
        if (c) set.add(c);
      });
      CATS = Array.from(set).sort();
      const sel = document.getElementById('categorySelect');
      // keep first option
      sel.innerHTML = '<option value="">Toutes les cat√©gories</option>';
      CATS.forEach(cat => {
        const o = document.createElement('option');
        o.value = cat;
        o.textContent = cat;
        sel.appendChild(o);
      });
    }

    // render
    function renderList(list) {
      const main = document.getElementById('mainArea');
      main.innerHTML = '';
      if (!list || list.length === 0) {
        main.innerHTML = '<p class="muted">Aucune recette trouv√©e.</p>';
        return;
      }
      const grid = document.createElement('div');
      grid.className = 'cards';

      list.forEach(r => {
        const card = document.createElement('article');
        card.className = 'card';

        const title = document.createElement('h3');
        title.innerHTML = `üç≤ ${escapeHtml(r.nom || '‚Äî')}`;

        const imgBox = document.createElement('div');
        imgBox.className = 'img-box';
        const img = document.createElement('img');
        img.src = r.photo && r.photo.trim() ? r.photo.trim() : 'assets/images/placeholder.png';
        img.alt = r.nom || 'image recette';
        // ensure proportion (contain)
        img.style.objectFit = 'contain';
        img.onerror = function(){ this.onerror=null; this.src='assets/images/placeholder.png'; };
        imgBox.appendChild(img);

        const meta = document.createElement('div');
        meta.className = 'meta';
        const b1 = document.createElement('div'); b1.className = 'badge'; b1.textContent = `üë• ${r.personnes || '‚Äî'}`;
        const b2 = document.createElement('div'); b2.className = 'badge'; b2.textContent = `üìÇ ${r.categorie || '‚Äî'}`;
        meta.appendChild(b1); meta.appendChild(b2);

        const ingred = document.createElement('div');
        ingred.className = 'ingredients';
        ingred.innerHTML = `<strong>üßæ Ingr√©dients</strong><br>${nl2br(escapeHtml(r.ingredients || '‚Äî'))}`;

        const steps = document.createElement('div');
        steps.className = 'recipe-steps';
        steps.innerHTML = `<strong>üìù Pr√©paration</strong><div style="margin-top:8px;">${nl2br(escapeHtml(r.recette || '‚Äî'))}</div>`;

        // buttons
        const buttons = document.createElement('div');
        buttons.className = 'buttons-row';

        // gallery (opens image)
        if (r.photo && r.photo.trim()) {
          const g = document.createElement('button');
          g.className = 'btn-small';
          g.innerHTML = 'üñº Galerie';
          g.onclick = () => openUrl(r.photo.trim());
          buttons.appendChild(g);
        }

        // print single
        const pbtn = document.createElement('button');
        pbtn.className = 'btn-small';
        pbtn.innerHTML = 'üñ®Ô∏è Imprimer la fiche';
        pbtn.onclick = () => printRecipe(r);
        buttons.appendChild(pbtn);

        // append all
        card.appendChild(title);
        card.appendChild(imgBox);
        card.appendChild(meta);
        card.appendChild(ingred);
        card.appendChild(steps);
        card.appendChild(buttons);

        grid.appendChild(card);
      });

      main.appendChild(grid);
    }

    // helpers
    function nl2br(s){ return String(s).replace(/\r?\n/g, '<br>'); }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // open url safely
    function openUrl(u){ try { window.open(decodeURIComponent(u), '_blank'); } catch(e){ window.open(u, '_blank'); } }

    // search & filter
    let searchTimer = null;
    document.getElementById && document.getElementById('searchInput') && (document.getElementById('searchInput').oninput = onSearchChange);
    document.getElementById && document.getElementById('categorySelect') && (document.getElementById('categorySelect').onchange = onSearchChange);

    function onSearchChange(){
      if (searchTimer) clearTimeout(searchTimer);
      searchTimer = setTimeout(()=> {
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        const cat = document.getElementById('categorySelect').value;
        let filtered = RECIPES.slice();

        if (q) {
          filtered = filtered.filter(r => (r.nom||'').toLowerCase().includes(q) || (r.ingredients||'').toLowerCase().includes(q));
        }
        if (cat) {
          filtered = filtered.filter(r => (r.categorie||'').toLowerCase() === cat.toLowerCase());
        }
        renderList(filtered);
      }, 200);
    }

    // random recipe
    function doRandom(){
      if (!RECIPES || RECIPES.length === 0) return;
      const r = RECIPES[Math.floor(Math.random() * RECIPES.length)];
      renderList([r]);
      // scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // print single recipe (open new window with print)
    function printRecipe(r){
      const doc = window.open('', '_blank', 'width=800,height=900');
      const html = `<!doctype html>
<html><head><meta charset="utf-8"><title>${escapeHtml(r.nom)}</title>
<style>
  body{ font-family: Arial, sans-serif; padding:20px; color:#222; }
  h1{ margin:0 0 6px 0; font-size:24px; color:var(--accent); }
  .meta{ color:#666; margin-bottom:12px; }
  .img{ width:100%; max-height:420px; object-fit:contain; margin-bottom:12px; border-radius:8px; background:#fafafa; padding:6px; }
  .section{ margin-bottom:14px; }
  pre{ white-space:pre-wrap; font-size:15px; line-height:1.5; }
</style>
</head><body>
  <h1>${escapeHtml(r.nom)}</h1>
  <div class="meta">Cat√©gorie: ${escapeHtml(r.categorie || '‚Äî')} ‚Ä¢ Pour: ${escapeHtml(r.personnes || '‚Äî')}</div>
  <img src="${r.photo || 'assets/images/placeholder.png'}" class="img" onerror="this.onerror=null;this.src='assets/images/placeholder.png'">
  <div class="section"><strong>Ingr√©dients :</strong><pre>${escapeHtml(r.ingredients || '‚Äî')}</pre></div>
  <div class="section"><strong>Pr√©paration :</strong><pre>${escapeHtml(r.recette || '‚Äî')}</pre></div>
  <script>setTimeout(()=>{window.print();},400); window.onafterprint=()=>window.close();<\/script>
</body></html>`;
      doc.document.open();
      doc.document.write(html);
      doc.document.close();
    }

    // init on load
    window.addEventListener('load', () => {
      // connect inputs
      const s = document.getElementById('searchInput');
      const c = document.getElementById('categorySelect');
      if (s) s.oninput = onSearchChange;
      if (c) c.onchange = onSearchChange;
      loadCSV();
    });
  </script>
</body>
</html>
